.de Id
.ds Rv \\$3
.ds Dt \\$4
..
.Id $Id: ci.1,v 1.1.1.1 1999/07/19 01:49:13 cvs Exp $
.ds r \&\s-1RCS\s0
.if n .ds - \%--
.if t .ds - \(em
.TH CI 1 \*(Dt GNU
.SH 名称
ci \- RCS ファイルに新たなリビジョンを追加する
.SH 書式
.B ci
.RI [ options ] " file " .\|.\|.
.SH 解説
.B ci
は \*r ファイルに新たなリビジョンを追加します。引数のうち、\*r ファイルの拡張子
形式にマッチするファイル名を \*r ファイルとみなします。
それ以外のファ
イル名は、新たなリビジョンを含んだワークファイルとみなします。
.B ci
はワー
クファイルの内容を対応した \*r ファイルに格納します。もし、ワークファイ
ルのみが指定されたなら、
.B ci
はサブディレクトリ \*r、次にワークファイ
ルがあるディレクトリの順に対応した \*r ファイルを検索します。詳細は後
述の
.SM "ファイル名規則"
の項を参照してください。
.PP
.B ci
が動作するには、
.B ci
を起動したユーザが
\*r ファイルのアクセスリスト
に登録されているか、アクセスリストが空であるか、ユーザが \*r ファイル
の持ち主であるか、スーパーユーザである必要があります。
すでに存在する枝(branch)に新しいリビジョンを追加するには、ブランチの先
端(tip)リビジョン
が、追加しようとするユーザによってロックされていなければなりません。さもな
ければ、新たな枝を作成することができます。非厳格モード(
.BR rcs (1)
参照)の
場合、ファイルの持ち主に対してはこの制限はありません。他人が行っている
ロックは、
.B rcs
コマンドによって解除できます。
.PP
.B \-f
オプションが指定されていなければ、
.B ci
は追加しようとするリビジョンと
直前のリビジョンとの比較を行います。もし、違いがなかった場合、新たなリ
ビジョンを作成するかわりに、ワークファイルを元のリビジョンのものに復元
します。復元するときには、ci はいったんワークファイルを削除します。
.B ci
に
.B \-l 
オプション
または
.B \-u
オプションが指定されていれば、あたかも直前のリビジョンに対し
て
.B "co\ \-l"
または
.B "co\ \-u"
を実行したかのようにして直前のリビジョンの内容を
取り出します。復元が行われる場合、
.B \-n
と
.B \-s
オプションは復元されるリビ
ジョンに対して作用します。
.PP
リビジョンを格納するときに、
.B ci
はログメッセージの入力を促すプロンプト
を表示します。ログメッセージは、そのリビジョンの変更点の要約です。
ファイル終端(EOF) `.' のみからなる行によって入力を完了させます。複数の
ファイルが登録される場合、
.B ci
は前に入力したログメッセージを再利用する
かどうかを聞いてきます。もし、標準入力が端末でなければ、
.B ci
は確認を行
わず、登録されるすべてのファイルに対して同じログメッセージを使用します。
.B \-m
オプションの項を参照してください。
.PP
もし \*r ファイルが存在しなければ、
.B ci
は新規に \*r ファイルを作成し、ワークファイルの
内容を初期リビジョン(デフォルトでは
.BR 1.1 )
として格納します。その場合、アクセスリス
トは空に設定されます。初期リビジョンを格納するときは、ログメッセージのかわりにファイルの内
容を記述したテキストを入力します(
.B \-t
オプションの項参照)。
.PP
登録するリビジョンのリビジョン番号(rev)は、
.BR \-f ,
.BR \-I ,
.BR \-k ,
.BR \-l ,
.BR \-M ,
.BR \-q ,
.BR \-r ,
.BR \-u
のオプションのうちのいずれかで指定することができます。
.I rev
はシンボル、数値、あるいは両者
の混合したものです。もし
.I rev
が
.B $
ならば、
.B ci
はワークファイル中のキー
ワードからリビジョン番号を決定します。
.PP
.I rev
がリビジョン番号の場合、それは登録する枝のなかで最も大きな値である必要がありま
す。さもなければ、新しい枝を作成する必要があります。
.PP
.I rev
がリビジョン番号ではなく枝番号の場合、その枝に対する新しいリビジョ
ンが作成されます。新しいリビジョン番号は、その枝の先端リビジョン番号に 
1 を加えたものとなります。もし
.I rev
が存在しない枝番号ならば、新たな枝
が作成され、初期リビジョンとして
.IB rev .1
が作成されます。
.br
.ne 8
.PP
.I rev
が省略された場合、
.B ci
はユーザが行った最後のロックからリビジョン番
号を決定します。もし、ユーザがブランチの先端リビジョンのロックを行って
いたなら、新たなリビジョンがその枝に追加されます。新しいリビジョン番号は
先端リビジョン番号に 1 を加えたものになります。もし、ユーザが先端で
はないリビジョンをロックしていたなら、新たな枝が作成されます。新たな枝
番号は、ロック対象のリビジョンの最も大きな枝番号に 1 を加えたものになり
ます。デフォルトでは、新たな枝やリビジョンの番号は 1 となります。
.PP
.I rev
が省略され、ユーザがロックを行ってはいないが、そのファ
イルの所有者であり、かつロックを厳格には行わないモード (以下、非厳格モード)
であるなら、デフォルトの枝(通常は
幹(trunk):
.BR rcs (1)
の
.B \-b
オプションの項を参照)に新たなリビジョンが作成
されます。
.PP
例外: 幹(trunk) において、リビジョンを追加することはできますが、途中に挿
入することはできません。
.SH オプション
.TP
.BR \-r [\f2rev\fP]
リビジョンを登録します。さらに、対応したロックを解除し、ワークファイル
を削除します。これはデフォルトの動作です。
.RS
.PP
.B ci
において
.B \-r
オプションは他の \*r コマンドとは異なる意味を持ちます。
他の \*r コマンドでは
.B \-r
は単にリビジョンの指定ですが、
.B ci
ではロックの
解除とワークファイルの削除も意味します。
.B \-u
オプションの項にトリッキーな例が挙げられています。
.RE
.TP
.BR \-l [\f2rev\fP]
.B \-r
と同様の動作を行ったあと、
.B "co\ \-l"
と同様の動作も行います。すなわち、登
録されたリビジョンは即座にロックされ、取り出されます。これは、リビジョ
ンを登録してさらに編集を続けたい場合に便利です。
.TP
.BR \-u [\f2rev\fP]
.B \-l
とほぼ同様の効果がありますが、登録されたリビジョンはロックされませ
ん。これは、登録したリビジョンの内容をすぐに参照したい(コンパイル等)場合
に便利です。
.RS
.PP
.B \-l
、
.B \-r
、
.B \-u
オプションは、最後に指定したもののみ
が効力を持ちます。たとえば、
.B "ci\ \-u\ \-r"
は
.B "ci\ \-r"
と等価です。
.RE
.TP
.BR \-f [\f2rev\fP]
直前のリビジョンとの違いがない場合にも、強制的に新しいリビジョンとして
登録します。
.TP
.BR \-k [\f2rev\fP]
ワークファイルからキーワードを探し、リビジョン番号、作成日時、状態、作
者を検索し(
.BR co (1)
を参照)、登録されるリビジョンに割り当てます。さらに、
.B ci
を起動したユーザ名と実際に登録された日付を含むデフォルトのログメッ
セージを作成します。本オプションは、配布されたソフトウェアを登録するのに
便利です。複数のサイトに配布されたリビジョンは
.B \-k
オプションを使って登
録することで、元々のリビジョン番号、作成日付、状態、作者を保存することができます。
ワークファイルのキーワードから取り出した値は、
.B \-d
、
.B \-m
、
.B \-s
、
.B \-w
や、他のリ
ビジョン番号を生成するようなオプションにより変更することができます。
.TP
.BR \-q [\f2rev\fP]
診断メッセージを表示しません。直前のリビジョンから
変更がない場合、
.B \-f
オプションを指定していなければ、登録を行いません。
.TP
.BR \-I [\f2rev\fP]
対話モードで動作します。たとえ標準入力が端末でなくても、ユーザに対して
問い合わせを行います。
.TP
.BR \-d "[\f2date\fP]"
登録日付として指定された
.I date
を用います。
.I date
は
.BR co (1)
で記述された自
由形式で指定することができます。これは、
登録日時をごまかしたい場合や、日付キーワードがワークファイルに
ないにもかかわらず
.B \-k
オプションを使いたい場合に便利です。
.I date
が指定されなかった場合、ワークファイルの最終更新日付が用いられます。
.TP
.BR \-M [\f2rev\fP]
作成されるワークファイルの最終更新日付を、取り出されたリビジョンの日付
にします。たとえば、
.BI "ci\ \-d\ \-M\ \-u" "\ f"
は、
.I f
の内容がキーワード置換により変更
された場合も最終更新日時を変更しません。本オプションを指定すると
.BR make (1)
が正しく動作しなくなるので、注意して使用する必要があります。
.TP
.BI \-m "msg"
登録するすべてのファイルのログメッセージとして
.I msg
を用います。
.TP
.BI \-n "name"
登録したリビジョンにシンボリック名
.I name
をつけます。もし同じシンボリッ
ク名が別のリビジョンに割り当てられていた場合、エラーになります。
.TP
.BI \-N "name"
.B -n
と同様の動作を行います。ただし、同じシンボリック名が他のリビジョン
に割り当てられていた場合は、再割り当てを行います。
.TP
.BI \-s "state"
登録されるリビジョンの状態を
.I state
とします。デフォルトは
.B Exp
(Experimental: 実験的)です。
.TP
.BI \-t file
\*r ファイル中の内容記述テキストをファイル
.I file
の内容で置き換えます。
すでに内容記述テキストがある場合はこれを削除します。ファイル名
.I file
は
.B \-
で始まってはいけません。
.TP
.BI \-t\- string
RCS ファイル中の内容記述テキストを文字列
.I string
の内容で置き換えます。
すでに内容記述テキストがある場合は削除されます。
.RS
.PP
.B \-t
オプションは、どちらの形式で使う場合も、最初のチェックイン時にしか意
味を持ちません。それ以外の場合は単に無視されます。
.PP
最初のチェックイン時に
.B \-t
オプションが指定されなかった場合、
.B ci
は標準
入力から内容記述テキストを読み込みます。テキストは、ファイル終端あるいは
その行に `.' しかない場合に終了します。ユーザへの問い合わせが可能な場合には、テ
キストの入力を促すプロンプトが表示されます(
.B \-I
オプション参照)。
.PP
旧バージョンとの互換性のため、後に何も続けない
.B \-t
オプションは無視されます。
.RE
.TP
.BI \-w "login"
指定された
.I login
をリビジョンの作者として登録します。作者名をごまかした
い場合や、作者キーワードがワークファイルにないにもかかわらず
.B -k
オプションを使いたい場合に便利です。
uses
.TP
.BI \-V n
\*r システムのバージョン
.I n
のエミュレーションを行います。詳細は
.BR co (1) 
を参照してください。
.TP
.BI \-x "suffixes"
\*r ファイルの拡張子を指定します。拡張子が空ではない \*r ファイルを指定した場合、
.I suffix
まで含めたすべてのパス名を \*r ファイル名であるとみなします。
拡張子が空の場合は、
.BI RCS/ file
または
.IB path /RCS/ file
形式のものを \*r ファ
イル名であるとみなします。本オプションの場合、
.B /
で区切ることにより、複数の
拡張子を指定できます。たとえば、
.B \-x,v/
は、
.B ,v
と空の拡張子の 2 つの拡張子を持つ \*r ファイルを
指定します。複数の拡張子が指定された場合、指定された順に \*r ファイルを検索します。
デフォルトの拡張子は、インストールされる環境により異なります。UNIX のよ
うな計算機では、通常
.B \-x,v/
が、それ以外の計算機では空拡張子が用いられます。
.SH "ファイル名規則"
\*r ファイルとワークファイルのペア
は 3 通りの方法で指定することができます。
.PP
1) \*r ファイルとワークファイルの両方を指定する
\*r ファイルのパス名は
.IB path1 / workfileX
形式、ワークファイルのパス
名は
.IB path2 / workfile
形式を取ります。この場合の、
.IB path1 /
と
.IB path2 /
はパス(異なる場合や、空である場合もある)を示し、
.I workfile
はファイル名、X 
は \*r 拡張子を指します。もし X が空なら、
.IB path1 / は
.B RCS/
であるか、最後が
.B /RCS/
でなければなりません。
.PP
2) \*r ファイルのみを指定する
ワークファイルパス名は、カレントディレクトリの、\*r ファイル名から
.IB path / 
と
.I X
を取り除いた部分をファイル名に持つファイル名になります。
.PP
3) ワークファイルのみを指定する
.B ci
はまず、各 \*r 拡張子
.I X
に対して、
.IB path2 /RCS/ workfileX
形式の名前で検
索を行います。もしこれが見つからず、
.I X
が空でなければ、
.IB path2 / workfileX
を検索します。
.PP
1) または 2) の方法で \*r ファイルが指定されていない場合、
.I ci
は、まずディレクトリ
.B ./RCS
を検索し、次にカレントディレクトリを検索します。
.PP
ある \*r ファイルパス名のオープンに失敗すると、たとえそれがいくつかあ
る可能性の 1 つであっても、
.I ci
はエラーとして処理を終了します。たとえば、
ディレクトリ
.I d
で \*r コマンドを利用できないようにするには、
.IB d /RCS なる
名前の通常ファイルを作成しておきます。すると、\*r コマンドは
.IB d /RCS
をディレクトリとしてオープンしようとしますが、ディレクトリではないので
オープンすることはできません。その結果、エラーになるわけです。
.SH 例
\*r 拡張子が
.B ,v
、カレントディレクトリには \*r サブディレクトリがあり、
.B RCS
には
.B io.c,v
があると仮定します。ここで、以下に示したコマンドを実行すると、
どれもカレ
ントディレクトリにある
.B io.c
を
.B RCS/io.c,v
に登録し、
.B io.c
を削除します。
.LP
.RS
.nf
.ft 3
ci  io.c;    ci  RCS/io.c,v;   ci  io.c,v;
ci  io.c  RCS/io.c,v;    ci  io.c  io.c,v;
ci  RCS/io.c,v  io.c;    ci  io.c,v  io.c;
.ft
.fi
.RE
.PP
\*r 拡張子が空、カレントディレクトリには \*r サブディレクトリがあり、
\*r には
.B io.c
があると仮定します。ここで以下に示すコマンドは、どれも新しい
リビジョンの登録を行います。
.LP
.RS
.nf
.ft 3
ci  io.c;    ci  RCS/io.c;
ci  io.c  RCS/io.c;
ci  RCS/io.c  io.c;
.ft
.fi
.RE
.SH "ファイルモード"
.B ci
が作成した \*r ファイルは、ワークファイルの読み込みと実行の許可属性を
受け継ぎます。すでに \*r ファイルが存在すれば、
.B ci
はその読み込みと実行
の許可属性を保持します。
.B ci
は、つねに \*r ファイルの書き出し許可属性を不許
可にします。
.SH ファイル
いくつかの一時ファイルが、ワークファイルの存在するディレクトリまたはテ
ンポラリディレクトリ(環境変数の項の
.B \s-1TMPDIR\s0
参照)に作成されます。
セマフォファイル等のファイルが \*r ファイルが存在するディレクト
リに作成されます。空ではない \*r 拡張子を用いている場合、セマフォファイ
ル名の先頭 1 文字には、\*r 拡張子の 1 文字目と同じ文字が用いられます。
\*r 拡張子として、ファイル名の先頭として利用できない文字を指定しないよ
うに注意してください。空の \*r 拡張子を指定している場合、セマフォファ
イル名の最後の 1 文字が
.B _
となります。この場合、ワークファイル名の最
後の 1 文字が
.B _
で終わってはいけません。
.PP
.B ci
は、 \*r ファイルやワークファイルを変更しません。通常
.B ci
はそれらの
ファイルを削除し、新しいものを作成します。ただし、対象となる \*r ファイルが
シンボリックリンクの場合は、シンボリックリンク自体ではなく、そのリンク
先のファイルを削除します。他のシンボリックリンクによる参照に同じ結果を
反映するためです。ワークファイルがシンボリックリンクやハードリンクであっ
た場合には、この処置が適用されないため、他の同じ実体を指していたシンボ
リックリンクの内容との食い違いが生じます。また、\*r ファイルに対するハー
ドリンクは意味がありません。
.PP
実効ユーザは、 \*r ファイルを含むディレクトリの検索および書き込み権を
持っていなければなりません。通常、実ユーザは、 \*r ファイルとワークファイ
ルの読み込み許可と、それらを含むディレクトリの検索および書き込み権を持っ
ていなければなりません。古い計算機のなかには実ユーザと実効ユーザ
の間を容易に行き来することができないものもあります。これらの計算機では、実効ユー
ザの権限のみが利用されます。
.B ci
や
.B co
の実行ファイルに setuid が設定さ
れていなければ、実ユーザと実効ユーザは同一です。次節で説明するように、
もし実効ユーザが全 \*r ファイルとそれを含むディレクトリを所有し、実効
ユーザのみが \*r ディレクトリに書き込めるように設定できるなら、\*r ファ
イルのセキュリティを強化することが可能です。
.PP
\*r ファイルを変更するには \*r ファイルを含むディレクトリの書き込み権
が必要なので、ユーザは \*r ファイルを含むディレクトリの許可属性を変更
することで、\*r ファイルに対するアクセスを制限できます。たとえば、ユーザ
のグループを設定できる計算機では、\*r ディレクトリをあるグループのみが
書き込み権を持つように設定します。これは、略式のプロジェクトでは効果が
あります。しかし、このやりかたでは、グループに所属するユーザが自由に 
\*r ファイルを変更することができ、ときには \*r ファイルすべてを削除してしまうか
もしれません。そのため、正式なプロジェクトでは、\*r ファイルを自由に操
作きる \*r 管理者を置いて、プロジェクトの他のメンバは新たなリビジョン
を登録すること以外の操作をできないようにすることがあります。
.SH 環境変数
.TP
.B \s-1RCSINIT\s0
本変数に空白で区切ったオプションを設定することで、コマンドライン引数に先立って処理されます。
空白はバックスラッシュによってエスケープすることができます。
.B \s-1RCSINIT\s0
はほとんどの \*r コマンドで参照されます。特に
.B \-q
、
.B \-V
、
.B \-x
オプションを指定しておくと便利です。
.TP
.B \s-1TMPDIR\s0
一時ファイルを作成するディレクトリ名を指定します。設定されていない場合は、環
境変数
.B \s-1TMP\s0
、
.B \s-1TEMP\s0
を調べます。どれも設定されていない場合は、計算機毎に
決められたデフォルトのディレクトリ(ほとんどの場合
.I /tmp
)を使用します。
.SH 診断
.I ci
は \*r ファイル名、ワークファイル名、追加するリビジョン番号、直前の
リビジョン番号を表示します。処理が成功した場合は終了ステータス 0 を返
します。
.SH 作者
Author: Walter F. Tichy.
.br
Revision Number: \*(Rv; Release Date: \*(Dt.
.br
Copyright \(co 1982, 1988, 1989 by Walter F. Tichy.
.br
Copyright \(co 1990, 1991 by Paul Eggert.
.SH 関連項目
co(1), ident(1), make(1), rcs(1), rcsclean(1), rcsdiff(1),
rcsintro(1), rcsmerge(1), rlog(1), rcsfile(5)
.br
Walter F. Tichy,
\*r\*-A System for Version Control,
.I "Software\*-Practice & Experience"
.BR 15 ,
7 (July 1985), 637-654.
.br
