.\" -*- nroff -*-
.\" Copyright 2001 by Theodore Ts'o.  All Rights Reserved.
.\" This file may be copied under the terms of the GNU Public License.
.\"*******************************************************************
.\"
.\" This file was generated with po4a. Translate the source file.
.\"
.\"*******************************************************************
.\" 
.\" Japanese Version Copyright (c) 2001,2005 Yuichi SATO
.\"         all rights reserved.
.\" Translated Sun Sep  2 23:20:17 JST 2001
.\"         by Yuichi SATO <ysato@h4.dion.ne.jp>
.\" Updated & Modified Tue May  3 04:42:39 JST 2005
.\"         by Yuichi SATO <ysato444@yahoo.co.jp>
.\" Updated & Modified Tue Dec 20 07:00:21 JST 2005 by Yuichi SATO
.\"
.TH E2IMAGE 8 "February 2012" "E2fsprogs version 1.42.1" 
.SH 名前
e2image \- 重要な ext2/ext3/ext4 ファイルシステムメタデータをファイルに保存する
.SH 書式
\fBe2image\fP [ \fB\-rsI\fP ] \fIdevice\fP \fIimage\-file\fP
.SH 説明
\fBe2image\fP プログラムは、 \fIdevice\fP 上にある重要な ext2/ext3/ext4 のファイルシステムのメタデータを
指定されたファイル \fIimage\-file\fP に保存する。 このイメージファイルは \fBdumpe2fs\fP や \fBdebugfs\fP
といったプログラムで \fB\-i\fP オプションを使えば検査できる。 このプログラムは酷く破損したファイルシステムを
エキスパートが回復するときの手助けができる。 将来的には、被害を受けたファイルシステムを回復する手助けとして、 このイメージファイルを用いるように
e2fsck を拡張する予定である。
.PP
\fIimage\-file\fP が \- の場合、\fBe2image\fP の出力は標準出力に送られる。
これにより、出力を \fBgzip\fP(1) のような他のプログラムにパイプすることができる。
(今のところ、このオプションがサポートされているのは、\fB\-r\fP オプションを使って
raw イメージを作成する場合のみであることに注意すること。
なぜなら、今のところは通常のイメージファイルや QCOW2 イメージを作成する過程で、
パイプを使って行うことのできないファイルへのランダムアクセスが必要なためである。
この制限は将来のバージョンの \fBe2image\fP で取り除かれると期待される。)
.PP
(ブート時や毎週といった) 一定の期間毎に、 全てのファイルシステムのイメージファイルを作成したり、 (\fBfdisk \-l\fP コマンドで生成される)
パーティションのレイアウトを保存するのは、 とても良い考えである。 ファイルシステムが被害を受けたときに
イメージファイルデータにアクセスできることを保証するために、 イメージファイルは中に入れたファイルシステムとは
別のファイルシステムに置いておくべきである。
.PP
ディスク容量を節約するため、 \fBe2image\fP はイメージファイルを
スパース (sparse) ファイルとしてか、QCOW2 フォーマットで作成する。
スパースファイルの場合には、イメージファイルを他の場所にコピーするときには、
前もって圧縮するか、GNU 版の \fBcp\fP の \fB\-\-sparse=always\fP オプションを使って
コピーするべきである。
QCOW2 イメージはスパースではないので、この注意はあてはまらない。
.PP
ext2 イメージファイルの大きさは、ファイルシステムのサイズと 使用している inode の数に大きく依存する。 典型的な 10 GB
のファイルシステムで 1,200,000 個の inode のうち 200,000 個が使われている場合、 イメージファイルの大きさは約 35 MB
になるだろう。 4 GB のファイルシステムで 550,000 個の inode のうち 15,000 個が使用されている場合、
イメージファイルの大きさは約 3 MB になるだろう。 イメージファイルは (ファイルシステムと比べて)  とても小さく圧縮できる傾向がある。
ディスク上で 32 MB を使用しているイメージファイルは、 一般に 3 〜 4 MB に圧縮される。
.PP
.SH イメージファイルを使ったファイルシステムメタデータの復旧
.PP
\fB\-I\fP オプションを指定すると、e2image はイメージファイルに格納されている メタデータをデバイスにインストールし直す。
これは緊急の場合に、ファイルシステムメタデータを デバイスに復旧するのに使用できる。
.PP
\fB警告!!!!\fP \fB\-I\fP オプションは、他の方法が失敗した場合の 最終手段としてのみ使用すべきである。
イメージファイルが作成された後でファイルシステムが変更されていると、 データが失われる\fBだろう\fP。 他の復旧手段を後で試そうと思う場合は、
通常はファイルシステムのフルイメージバックアップを作成すべきである。
.PP
.SH "RAW イメージファイル"
\fB\-r\fP オプションを使うと、通常のイメージファイルではなく、 raw イメージファイルが作成される。 raw
イメージファイルは、通常のイメージファイルと 2 つの点が異なる。 1 つ目は、ファイルシステムのメタデータが適切な位置に置かれ、 e2fsck,
dumpe2fs, debugfs などが raw イメージファイル上で 直接実行できるという点である。 raw
イメージファイルが使うディスクスペースを最小化するため、 このファイルはスパースなファイルとして作成される。
(スパースなファイルの作成が実装されていないユーティリティで このファイルをコピー・圧縮・展開する場合は注意すること。
ファイルがファイルシステム自身と同じ大きさになってしまうだろう!)  2 つ目は、raw イメージファイルが間接ブロックと間接データブロックを
含んでいるという点である。 現行のイメージファイルはこれらのブロックを含んでいないが、 将来的には変更されるかもしれない。
.PP
raw イメージファイルは、e2fsprogs のバグレポートの 一部としてメンテナにファイルシステムを送る場合に時々利用される。
バグレポートで送る場合には、以下のコマンドが推奨される (hda1 を適切なデバイスで置き換えること):
.PP
.br
\	\fBe2image \-r /dev/hda1 \- | bzip2 > hda1.e2i.bz2\fP
.PP
これにより、データブロックを含まないメタデータ情報のみを送ることができる。 しかしこれでも、ディレクトリブロック内のファイル名によって、
バグ報告者が秘密にしておきたいファイルシステムの内容についての情報が 明らかにされてしまう。 その心配を取り除くためには、 \fB\-s\fP
オプションを指定することができる。 これにより \fBe2image\fP は、イメージファイルを書き込む前に、ディレクトリエントリをごちゃ混ぜにして、
ディレクトリブロックの使用されていない部分を 0 で埋める。 ただし \fB\-s\fP オプションはハッシュツリーにインデックス化された
ディレクトリについての問題の分析を妨げてしまう。
.PP
"/dev/hda1" を \fBe2image\fP で以前に作成した別の raw や QCOW2 のディスクイメージに
置き換えた場合でも、この方法は使える点に留意してほしい。
.PP
.SH "QCOW2 イメージファイル"
\fB\-Q\fP オプションを使うと、通常のイメージや raw イメージファイルではなく、
QCOW2 イメージファイルが作成される。
QCOW2 イメージは raw イメージが持つ情報を全て持つが、
raw イメージとはスパースでない点が異なる。
QCOW2 イメージでは、データを近くに詰め込む特別な形式でデータを格納することで、
必要なディスク容量を最小限にしている。そのため、穴 (ホール) の発生を避けつつ
サイズを最小限にすることができる。
.PP
e2fsprogs のバグレポートの一部としてメンテナにファイルシステムを送る場合には、
以下のコマンドを使うこと (hda1 を適切なデバイスで置き換えること):
.PP
.br
\	\fBe2image \-Q /dev/hda1 hda1.qcow2\fP
.br
\	\fBbzip2 \-z hda1.qcow2\fP
.PP
これにより、データブロックを含まないメタデータ情報のみを送ることができる。 しかしこれでも、ディレクトリブロック内のファイル名によって、
バグ報告者が秘密にしておきたいファイルシステムの内容についての情報が 明らかにされてしまう。 その心配を取り除くためには、 \fB\-s\fP
オプションを指定することができる。 これにより \fBe2image\fP は、イメージファイルを書き込む前に、ディレクトリエントリをごちゃ混ぜにして、
ディレクトリブロックの使用されていない部分を 0 で埋める。 ただし \fB\-s\fP オプションはハッシュツリーにインデックス化された
ディレクトリについての問題の分析を妨げてしまう。
.PP
\fBe2image\fP により作成される QCOW2 イメージは通常の QCOW2 イメージであり、
\fBqemu\-img\fP などの QCOW2 形式を認識する他のツールで扱うことができる。
.PP
.SH 作者
\fBe2image\fP は Theodore Ts'o (tytso@mit.edu) が作成した。
.SH 入手方法
\fBe2image\fP は e2fsprogs パッケージの一部で、 http://e2fsprogs.sourceforge.net から入手できる。
.SH 関連項目
\fBdumpe2fs\fP(8), \fBdebugfs\fP(8)

