
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Man page of KLOGD</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../jm.css">
</HEAD>
<BODY>

<H1>KLOGD</H1>
Section: Linux System Administration (8)<BR>Updated: 21 August, 1999<BR><A HREF="#index">Index</A>
<A HREF="../../../index.html">JM Home Page</A>
<A HREF="../../../manual/sysklogd/release/man8/klogd.8">roff page</A><HR>

<A NAME="lbAB">&nbsp;</A>
<H2>名前</H2>

klogd - カーネルログデーモン
<P>

<A NAME="lbAC">&nbsp;</A>
<H2>書式</H2>

<B>klogd</B>

[<B> -c </B>

<I>n</I>

]
[<B> -d </B>]

[<B> -f </B>

<I>fname</I>

]
[<B> -iI </B>]

[<B> -n </B>]

[<B> -o </B>]

[<B> -p </B>]

[<B> -s </B>]

[<B> -k </B>

<I>fname</I>

]
[<B> -v </B>]

[<B> -x </B>]

[<B> -2 </B>]

<P>

<A NAME="lbAD">&nbsp;</A>
<H2>説明</H2>

klogd は Linux のカーネルメッセージを捕え記録するシステムデーモンである。
<P>

<A NAME="lbAE">&nbsp;</A>
<H2>オプション</H2>

<DL COMPACT>
<DT><B>-c </B><I>n</I>

<DD>
コンソールに出力するログのレベルの既定値を <I>n</I> にする。
<DT><B>-d</B>

<DD>
デバッグモード。これは<B>大量に</B> stderr に出力する。
<DT><B>-f </B><I>file</I>

<DD>
syslog の facility ではなくて指定した名前のファイルにメッセージを記録
する。
<DT><B>-i -I</B>

<DD>
現在実行されている klogd デーモンにシグナルを送る。
どちらのオプションもシンボル情報を(再)読み込みするように指示する。
-iオプションはカーネルモジュールシンボルを再読み込みさせる。
-Iオプションは静的カーネルシンボルとカーネルモジュールシンボルの
両方を再読み込みさせる。
<DT><B>-n</B>

<DD>
自動的なバックグラウンドへの移行を抑止する。これは 
<B>klogd </B>

が 
<B><A HREF="../../SysVinit/man8/init.8.html">init</A>(8)</B>

により起動および制御される場合にのみ必要である。
<DT><B>-o</B>

<DD>
`ワンショット'モードで実行する。<B>klogd</B> はカーネルメッセー
ジバッファに存在する全てのメッセージを読み出し記録する。一回の読み出
しと記録ののちデーモンは終了する。
<DT><B>-p</B>

<DD>
パラノイアモード。klog がいつカーネルモジュールシンボルを読み込むかを指定する。
このオプションを設定すると、カーネルメッセージストリームに &quot;Oops&quot; の文字列が
流れる毎にカーネルモジュールシンボルの情報を読み込む。
<DT><B>-s</B>

<DD>
<B>klogd</B> はカーネルメッセージバッファとのインターフェイスにシステム
コールの使用を強行する。
<DT><B>-k </B><I>file</I>

<DD>
カーネルシンボル情報を指定した名前のファイルから取得する。
<DT><B>-v</B>

<DD>
バージョンを出力し、終了する。
<DT><B>-x</B>

<DD>
EIP 変換を抑制し、 System.map を読み込まない。
<DT><B>-2</B>

<DD>
シンボルが展開された時、
アドレスをシンボルに変換したものと生テキストの 2 回表示する。
これにより、ksymoops のような外部プログラムが変換される前の
データを使って処理を行えるようになる。
</DL>
<P>

<A NAME="lbAF">&nbsp;</A>
<H2>概説</H2>

klogd の機能はよく他の版の syslogd に編入されてしまいがちであるが、そ
れはあまり良い方法とは思われない。最近の Linux カーネルにおいては、情
報源の特定、順位付け、カーネルアドレスの解決など多くのメッセージに関す
る問題を扱わなければならない。カーネルロギングを個別のプロセスとするこ
とは、各種サービスの分割を明確なものにする。
<P>
Linux ではカーネルログ情報の情報源として二つの可能性がある。
<I>/proc</I>

ファイルシステムと syscall (sys_syslog) インターフェースであるが、
突き詰めていけばこれらは同じ一つのものである。
klogd は最もふさわしい情報としてどちらかを選択するように設計されている。
最初に、実際にマウントされている
<I>/proc</I>

ファイルシステムを確認する。もしそこに
<I>/proc/kmsg</I>

ファイルがあれば、それをカーネルログ情報の情報源として利用する。もし 
proc ファイルシステムがマウントされていなければ、
<B>klogd </B>

はカーネルメッセージの取得にシステムコールを利用する。コマンドラインス
イッチの
(<B>-s</B>)

は klogd にその情報源としてシステムコールの利用を強行させる。
<P>
もしカーネルメッセージが
<B>syslogd</B>

デーモンに振り向けられたとしても、
version 1.1 の
<B>klogd </B>

デーモンはその優先順位を適切に判定することが可能である。
カーネルメッセージの優先順位付けは version 0.99pl13 あたり
のカーネルで実装された。生のカーネルメッセージの形式は次の通り:
<DL COMPACT>
<DT><DD>
&lt;[0-7]&gt;カーネルからの出力
</DL>
<P>

カーネルメッセージの優先順位は &lt;&gt; 括弧に閉じられた一桁の数字に変換される。
この数値はカーネルの include ファイル kernel.h で定義されている。
カーネルからメッセージを受けると klogd デーモンはこの優先順位を読み取り、
適切な syslog のメッセージレベルに割り付ける。
(<B>-f</B>)
によってファイルへの出力が指示されている場合には、カーネルメッセージに
優先順位番号が残される。
<P>
klogd デーモンはカーネルメッセージの出力先をシステムコンソールへ変更す
ることもできる。カーネルによって優先順位が付けられる結果として、
メッセージはそれぞれデフォルトの既定のカーネルへのメッセージレベルが
割り当てられている。
手を加えていないカーネルのデフォルトのコンソールへのメッセージレベルは 
7 に設定されている。7 よりも小さい(つまり高い)優先順位レベルを持つメッ
セージはコンソールに出力される。
<P>
レベル 7 の優先順位を持つメッセージは `debug' メッセージとみなされ、
コンソールには出力されない。特にマルチユーザ環境における、多くのシ
ステム管理者は全てのカーネルメッセージを klogd により管理させ、
ファイルか syslogd デーモンに渡したいと思うだろう。そうすれば、
プリンタの用紙切れとかディスクの交換検出のような`わずらわしい'メッセージ
のコンソールへの出力を避けることができる。
<P>
<B>-c</B> オプションが指定されると、
<B>klogd</B>

デーモンはコンソールに表示される全てのカーネルメッセージを抑制する
システムコールを実行する。
以前のバージョンでは常にこのシステムコールが実行され、
そのデフォルトは panic を除くすべてのカーネルメッセージであった。
最近のバージョンでは少し違う扱いをしており、
もはやこのオプション値を設定する必要はない。
<B>-c</B> オプションの引数にはコンソールへ出力すべきメッ
セージの優先順位レベルを指定する。指示される数字「よりも小さい」優先順
位値を持つメッセージがコンソールへ出力される、という点に注意すること。
<DL COMPACT>
<DT><DD>
たとえば、優先順位値が 3 
(<B>KERN_ERR</B>)

かそれよりも重要なすべてのメッセージをコンソールに出力するためには、次
のコマンドを実行する:
<DT><DD>
<PRE>
        klogd -c 4
</PRE>

</DL>
<P>

カーネルメッセージの(優先順位の)数値は、カーネルのソースコードが
インストールされているのであれば、
<I>/usr/include/linux</I>

にある
<I>kernel.h</I>

ファイルで定義されている。これらの数値は
<I>/usr/include/sys</I>

サブディレクトリにある
<I>syslog.h</I>

ファイルでの優先順位値の定義に対応している。
<P>
klogd デーモンはカーネルメッセージを読み出す 'ワンショット' モードも利
用可能である。ワンショットモードはコマンドラインの <B>-o</B> オプション
で指示される。その出力は syslogd デーモンに渡されるか <B>-f</B> スイッ
チが指定されていれば代りのファイルに書き出される。
<DL COMPACT>
<DT><DD>
たとえば、システムがブートした際のカーネルメッセージを全て読み出して、
それを krnl.msg という名前のファイルに記録するには次のコマンドを実行す
る。
<DT><DD>
<PRE>
        klogd -o -f ./krnl.msg
</PRE>

</DL>
<P>

<A NAME="lbAG">&nbsp;</A>
<H2>カーネルアドレスの解決</H2>

カーネルが内部エラー状態を検出すると、
一般保護違反 (General Protection Fault) が発生する。
GPF 処理手続きの一部として、カーネルは違反が発生した時点での
プロセッサの状態を示すステータス報告を表示する。
この表示にはプロセッサのレジスタの内容、カーネルスタックの内容、
違反が発生した時にどの関数が実行されていたかのトレースが含まれる。
<P>
この情報は内部エラー状態が発生した原因を特定するために
<B>極めて重要</B>

である。
カーネル開発者がこの情報を分析しようとすると、困難が生じる。
なぜならカーネルは全て同じなわけではなく、
変数の位置や関数のアドレスはカーネルごとに異なるからである。
エラーの原因を診断するためには、カーネル開発者は
特定のカーネルの、どの関数や変数位置がエラーに関係したかを知る必要がある。
<P>
カーネルコンパイル処理の一部として、
コンパイルされたカーネルにおける重要な変数と関数のアドレスを記した一覧が作成される。
この一覧は カーネルディレクトリソースツリーのトップに System.map という名前で
作成される。
この一覧を使って、カーネル開発者はエラー状態が発生した時に
カーネルが何をしていたかを正確に知ることができる。
<P>
保護違反の表示から数値表現のアドレスを解決する処理は、
手動かまたはカーネルソースに含まれる
<B>ksymoops</B>

プログラムを使って行なわれる。
<P>
利便性のために、
<B>klogd</B>

はカーネルの数値表現のアドレスを、それらのシンボル表現に変換しようとする。
ただし実行時にカーネルのシンボルテーブルが必要である。
もしシンボルの元のアドレスも必要な場合は、
<B>-2</B>

を使うと数値アドレスも保存される。
シンボルテーブルはコマンドラインの <B>-k</B> オプションを用いて指定する。
シンボルファイルが明示されない場合は、次の順番でファイルを探す:
<P>
<PRE>
<I>/boot/System.map</I>
<I>/System.map</I>
<I>/usr/src/linux/System.map</I>
</PRE>

<P>
カーネル 1.3.43 のシステムマップから、
バージョン情報も提供されるようになっている。
バージョン情報はシンボルテーブルのリストを解析検索する際に利用される。
この機能は(カーネルの)安定版と先進版の両方で提供されているので
(その判別に)役に立つ。
<P>
たとえば、安定版のカーネルはそのマップファイルを /boot/System.map に持っ
ている。もし先進版のカーネルが /usr/src/linux の `標準の' 配置でコンパ
イルされているのであれば、システムマップは /usr/src/linux/System.map 
に存在する。klogd は先進版のもとで起動する時には 
/usr/src/linux/System.map マップファイル を優先して利用し、
/boot/System.map マップファイルは無視する。
<P>
1.3.43 以降の最近のカーネルでは klogd がきちんと理解し、変換できるように
重要なカーネルアドレスは適切に整列されている。それ以前のカーネルはカー
ネルのソースコードへのパッチが必要であり、そのパッチは sysklogd のソー
スコードと共に提供されている。
<P>
カーネル保護違反の分析処理は、静的カーネルに対しては非常にうまくいく。
ローダブルカーネルモジュールで発生したエラーを診断しようとすると
さらなる困難に出会うことになる。
ローダブルカーネルモジュールはカーネルの機能の一部を
自由にロードしたりアンロードしたりするのに用いられる。
ローダブルモジュールはデバッグの観点から有用であり、
カーネルが必要とするメモリの量を減らすのにも有用である。
<P>
ローダブルモジュールのエラー診断が困難なのは、
カーネルモジュールが動的であるということによる。
モジュールがロードされるとカーネルはモジュールを保持するためのメモリを確保し、
モジュールがアンロードされるとこのメモリはカーネルに返される。
動的にメモリが確保されるため、カーネルローダブルモジュールの
変数や関数のアドレスの詳細を記したマップファイルを作成することは不可能である。
マップファイルなしではカーネルモジュールによる保護違反が発生した時に
カーネル開発者が何が悪いのかを判断することは不可能である。
<P>
<B>klogd</B>

はカーネルローダブルモジュールで発生した保護違反を診断する際に生じる
この問題を扱えるようになっている。
プログラム開始時やシグナルを受け取った時に、klogd は
全てのロードされているモジュールと
それらがロードされているメモリアドレスの一覧を問い合わせる。
これらの外部シンボルのアドレスもこの問い合わせ処理の間に決定される。
<P>
保護違反が発生すると、
静的シンボルテーブルからカーネルアドレスの解決を試みる。
これに失敗した場合、
現在ロードされているモジュールのシンボルを用いてアドレスの解決を試みる。
これにより、最小限ではあるが、
klogd は保護違反を起こしたローダブルモジュールがどれかを示すことができるようになる。
もしモジュール開発者がモジュールからシンボル情報をエクスポートするように
していれば、追加の情報も得られる。
<P>
カーネルモジュールのアドレスを適切かつ正確に解決するためには、
カーネルモジュールの状態が変わる度にそれを
<B>klogd</B>

に知らせる必要がある。
<B>-i</B>

と
<B>-I</B>

オプションは現在起動しているデーモンにシンボル情報を再読み込みするように
指示するために使われる。
ほとんどの場合、適切にモジュールシンボルを解決させるために必要なのは
<B>-i</B>

オプションである。カーネルモジュールが追加または削除される度に、
以下のコマンドを実行するべきである。
<P>
<PRE>
<I>klogd -i</I>
</PRE>

<P>
<B>-p</B>

オプションもカーネルシンボル情報が最新であることを保証するために用いられる。
このオプションは、保護違反が発生する度に
<B>klogd</B>

にモジュールシンボル情報を再読み込みするように指示する。
プログラムを「パラノイア」モードで動かす前に注意してほしい。
保護違反が発生した時のカーネルと実行環境の安定性は常に疑問である。
モジュールシンボル情報を読み込むために klogd デーモンが
システムコールを実行する必要があるため、
システムが不安定になって有用な情報が得られなくなる可能性がある。
モジュールがロード・アンロードされた時に klogd (の情報)が更新される
ことを保証する方が遥かによい方法である。
最新のシンボル情報をあらかじめ読み込んでおくことにより、
保護違反が起きた時にそれを正しく解決する可能性が上昇する。
<P>
sysklogd のソースパッケージには
modules-2.0.0 パッケージに対するパッチが含まれている。
このパッチを適用すると、
<B>insmod</B>,

<B>rmmod</B>,

<B>modprobe</B>

を使ってカーネルにモジュールを追加・削除した時に
自動的に
<B>klogd</B>

にシグナルを送るようになる。
<P>
<P>

<A NAME="lbAH">&nbsp;</A>
<H2>シグナルの処理</H2>

klogd は以下の 8 種類のシグナルに反応する:
<B>SIGHUP</B>, <B>SIGINT</B>, <B>SIGKILL</B>, <B>SIGTERM</B>, <B>SIGTSTP</B>, 

<B>SIGUSR1</B>, SIGUSR2<B>, </B>SIGCONT

。このうち 
<B>SIGINT</B>, <B>SIGKILL</B>, <B>SIGTERM</B>, <B>SIGHUP</B>

の各シグナルはデーモンにカーネルログの生成源を閉じさせ、適切に終了させる。
<P>
<B>SIGTSTP</B>と <B>SICONT</B>

の両シグナルはカーネルロギングの開始と終了のために利用される。
<B>SIGTSTP </B>

シグナルを受信するとデーモンはそのログの生成源を閉じ、アイドルループに
突入する。その次に
<B>SIGCONT </B>

を受信するとデーモンは初期化を実行したのち、その入力源を再度選択し実行
を再開する。
<B>SIGSTOP</B>と <B>SIGCONT</B>

の組合せは無停止でカーネルログの入力源を再選択させることができる。例え
ば、<I>/proc</I> ファイルシステムの利用を解除するには次の順番でコマンド
を実行すればよい:
<P>


<DL COMPACT>
<DT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT># kill -TSTP pid<DD>
<DT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT># umount /proc<DD>
<DT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT># kill -CONT pid<DD>

</DL>
<P>

<B>LOG_INFO </B>

優先順位を持つシステムログがその停止/再開を記録する。<BR>
<P>
<B>SIGUSR1</B> と <B>SIGUSR2</B>

はカーネルシンボル情報を(再)読み込みさせるために用いる。
<B>SIGUSR1</B>

はカーネルモジュールシンボルを再読み込みさせる。
<B>SIGUSR2</B>

は静的カーネルシンボルとカーネルモジュールシンボルの両方を再読み込みさせる。
<P>
System.map ファイルが適切な位置に置かれているなら、
最も有効なシグナルは一般に
<B>SIGUSR1</B>

である。
このシグナルはカーネルモジュールが(再)読み込みされた時のために
用意されている。
カーネルモジュールの状態が変わった後にこのシグナルをデーモンに送れば、
カーネルモジュールが占めているアドレス空間で保護違反が起きた時に
適切にシンボルを解決できることが保証される。
<P>

<A NAME="lbAI">&nbsp;</A>
<H2>ファイル</H2>


<DL COMPACT>
<DT><I>/proc/kmsg</I>

<DD>
<B>klogd </B>

の記録するカーネルメッセージ源の一つ
<DT><I>/var/run/klogd.pid</I>

<DD>
<B>klogd </B>

のプロセス id が記録されているファイル
<DT><I>/boot/System.map, /System.map, /usr/src/linux/System.map</I>

<DD>
カーネルシステムマップのデフォルト位置

</DL>
<A NAME="lbAJ">&nbsp;</A>
<H2>バグ</H2>

多分、沢山。整理されたコンテキスト diff を送ってくれれば歓迎します。 
<A NAME="lbAK">&nbsp;</A>
<H2>著者</H2>

<B>klogd </B>

のオリジナルは Steve Lord (<A HREF="mailto:lord@crya.com">lord@crya.com</A>)によって書かれ、Greg
Wettstein が多くの改善を施した。

<DL COMPACT>
<DT>Dr. Greg Wettstein (<A HREF="mailto:greg@wind.enjellic.com">greg@wind.enjellic.com</A>)<DD>
<DT>Enjellic Systems Development<DD>

</DL>
<P>


<DL COMPACT>
<DT>Oncology Research Divsion Computing Facility<DD>
<DT>Roger Maris Cancer Center<DD>
<DT>Fargo, ND 58122<DD>


<P>
</DL>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">名前</A><DD>
<DT><A HREF="#lbAC">書式</A><DD>
<DT><A HREF="#lbAD">説明</A><DD>
<DT><A HREF="#lbAE">オプション</A><DD>
<DT><A HREF="#lbAF">概説</A><DD>
<DT><A HREF="#lbAG">カーネルアドレスの解決</A><DD>
<DT><A HREF="#lbAH">シグナルの処理</A><DD>
<DT><A HREF="#lbAI">ファイル</A><DD>
<DT><A HREF="#lbAJ">バグ</A><DD>
<DT><A HREF="#lbAK">著者</A><DD>
</DL>
<HR>
This document was created by
<A HREF="../../man/man1/man2html.1.html">man2html</A>,
using the manual pages.<BR>
Time: 03:33:46 GMT, December 05, 2022
</BODY>
</HTML>
