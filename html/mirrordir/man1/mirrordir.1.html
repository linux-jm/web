
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Man page of mirrordir</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../jm.css">
</HEAD>
<BODY>

<H1>mirrordir</H1>
Section: User Commands  (1)<BR>Updated: 1998 November 1<BR><A HREF="#index">Index</A>
<A HREF="../../../index.html">JM Home Page</A>
<A HREF="../../../manual/mirrordir/release/man1/mirrordir.1">roff page</A><HR>

<A NAME="lbAB">&nbsp;</A>
<H2>名前</H2>

pslogin - 強力なストリーム cipher 暗号化と diffie-hellman 鍵交換を用いた安全なリモート tcp ログイン
<P>

forward - 任意の tcp ソケットを安全かつ暗号化されたチャネルにフォワードする
<P>

copydir, mirrordir - 変更された最小の部分のみを用いて
(ローカル、FTP 経由、安全な tcp 接続経由で)
ディレクトリツリーをコピーまたはミラーする
<P>

recursdir - ファイルの操作/検索や tar ファイル作成のために、ローカルまたはリモートのディレクトリを再帰的に探索する
<A NAME="lbAC">&nbsp;</A>
<H2>書式</H2>

<B>mirrordir</B>

<BR>

[<B>-a</B>, <B>--access-times</B>]
<BR>

[<B>-m</B>, <B>--strict-mtimes</B>]
<BR>

[<B>--no-mtimes</B>]
<BR>

[<B>--ignore-size</B>]
<BR>

[<B>-A</B>, <B>--mtime-threshold</B> <I>ext</I>]
<BR>

[<B>--time-offset</B> [[<I>+</I>]|<I>-</I>][<I>H</I>]<I>H</I>[<I>:MM</I>]]
<BR>

[<B>-A</B>, <B>--always-write</B>]
<BR>

[<B>-r</B>, <B>--restore-access</B>]
<BR>

[<B>--no-chown</B>]
<BR>

[<B>--no-chmod</B>]
<BR>

[<B>-D</B>, <B>--only-delete</B>]
<BR>

[<B>-b</B>, <B>-S</B>, <B>--backup-extension</B>, <B>--suffix</B> <I>ext</I>]
<BR>

[<B>-N</B>, <B>--num-backups</B> <I>num</I>]
<BR>

[<B>-O</B>, <B>--backup-outdate</B> <I>sec</I>]
<BR>

[<B>-B</B>, <B>--block-size</B> <I>bytes</I>]
<BR>

[<B>-M</B>, <B>--max-bytes</B> <I>num</I>[<B>K</B>|<B>M</B>|<B>G</B>]]
<BR>

[<B>-s</B>, <B>--starting-file</B> <I>path</I>]
<BR>

[<B>-i</B>, <B>--ignore-next-exclude</B>]
<BR>

[[<B>-i</B>] <B>-X</B>, <B>--exclude</B> <I>path</I>] [[<B>-i</B>] <B>-X</B>, <B>--exclude</B> <I>path</I>] ...
<BR>

[[<B>-i</B>] <B>-F</B>, <B>--exclude-from</B> <I>file</I>] ...
<BR>

[[<B>-i</B>] <B>-G</B>, <B>--exclude-glob</B> <I>expr</I>] [[<B>-i</B>] <B>-G</B>, <B>--exclude-glob</B> <I>expr</I>] ...
<BR>

[[<B>-i</B>] <B>-R</B>, <B>--exclude-regexp</B> <I>expr</I>] [[<B>-i</B>] <B>-R</B>, <B>--exclude-regexp</B> <I>expr</I>] ...
<BR>

[<B>-C</B>, <B>--exclude-script</B> [<I>expr</I>|<I>file</I>]] [<B>-C</B>, <B>--exclude-script</B> [<I>expr</I>|<I>file</I>]] ...
<BR>

[<B>-h</B>, <B>--help</B>]
<BR>

[<B>-v</B>, <B>--verbose</B>] [<B>-v</B>, <B>--verbose</B>] ...
<BR>

[<B>-V</B>, <B>--version</B>]
<BR>

[<B>-k</B>, <B>--keep-files</B>]
<BR>

[<B>-l</B>, <B>--no-hard-links</B>]
<BR>

[<B>--follow-symlinks</B>]
<BR>

[<B>-L</B>, <B>--strict-locking</B>]
<BR>

[<B>-p</B>, <B>--password</B> <I>password</I>]
<BR>

[<B>-P</B>, <B>--password-exact</B> <I>password</I>]
<BR>

[<B>--test-login</B>]
<BR>

[<B>--no-warn-first-login</B>]
<BR>

[<B>--read-password-from-stdin</B>]
<BR>

[<B>--allow-empty-ftp-dirs</B>]
<BR>

[<B>--no-allow-empty-ftp-dirs</B>]
<BR>

[<B>--netrc</B>]
<BR>

[<B>--no-netrc</B>]
<BR>

[<B>--proxy-host</B> <I>host</I>]
<BR>

[<B>--secure</B>]
<BR>

[<B>-z</B>, <B>--gzip</B>]
<BR>

[<B>--gzip-backups</B>]
<BR>

[<B>--case-insensitive</B>]
<BR>

[<B>--to-lower</B>]
<BR>

[<B>--to-upper</B>]
<BR>

[<B>--no-use-passive-connections</B>]
<BR>

[<B>-K</B>, <B>--key-size</B> <I>bits</I>]
<BR>

[<B>--download-scripts</B>]
<BR>

[<B>--tar-file</B> <I>filename</I>]
<BR>

[<B>--tar-block-size</B> <I>N</I>]
<BR>

[<B>-t</B>, <B>--dry-run</B>, <B>--test-only</B>]
<BR>

[<B>--nice</B> <I>num</I>] <I>control mirror</I>
<P>

<B>mirrordir</B>

[<B>-c</B> | <B>--copy-mode</B> | <B>--recurs-mode</B> ] 
-[<B>abBCdDFGhklMmNOopRrstvVX</B>] <I>src</I> [<I>src</I> ...] <I>dest</I>
<P>

<B>copydir</B>

-[<B>abBCdeFGhklMmNOopRrstvVX</B>] <I>src</I> [<I>src</I> ...] <I>dest</I>
<P>

<B>recursdir</B>

-[<B>abBCdeFGhklMmNOopRrstvVX</B>] <I>src</I> [<I>src</I> ...]
<P>

<B>pslogin</B>

[<B>--key-size</B> <I>bits</I>]
[<B>mc://</B>][<I>username</I><B>@</B>]<I>hostname</I>[<B>:</B><I>portnumber</I>][<B>/</B><I>path</I>]
<P>

しかし通常は単に:
<BR>

<B>mirrordir</B> [<B>--exclude</B> <I>path</I>] <B></B><I>control mirror</I>

<BR>

<B>copydir</B>

<I>src</I> [<I>src</I> ...] <I>dest</I>
<BR>

<B>recursdir </B>

<I>src</I> [<I>src</I> ...] [<B>-C</B> <I>program</I>]
<BR>

<B>pslogin</B>

[<I>username</I><B>@</B>]<I>hostname</I>[<B>:</B><I>portnumber</I>]
<A NAME="lbAD">&nbsp;</A>
<H2>説明</H2>

<B>mirrordir</B>

はディレクトリを操作したりミラーする際に便利なユーティリティの集まりである。
<B>ssh</B>(1)

の代替になるコマンド
<B>pslogin</B>

や、任意の TCP ソケット接続を暗号化された安全なチャネルにフォワードする
<B><A HREF="../man1/forward.1.html">forward</A></B>(1)

も含まれている。
<P>

<B>mirrordir</B>

は 2 つのディレクトリ
<I>control</I>

と
<I>mirror</I>

との間で異なるファイルを、
<I>control</I>

から
<I>mirror</I>

へとコピーする。

修正時刻 (modification time) またはサイズが異なるファイルがコピーされる。
ファイルの許可属性・所有者・修正時刻・アクセス時刻
(--access-time が用いられた場合のみ)・スティッキービット・
デバイスタイプが複製される。
シンボリックリンクはリンク先の解決をされずにそのままコピーされる。
シンボリックリンクの修正・アクセス時刻 (シンボリック自身のもので、
シンボリックが指すファイルのものではないことに注意) は保存<I>されない</I>。
ハードリンクされたファイルは単にコピーされる。
生成時刻は、私の知る限り Unix では設定できない。
<P>
<B>mirrordir</B>

は<B>危険な</B>コマンドである。
<I>mirror</I>

にあって
<I>control</I>

にないファイルやディレクトリは削除されるからである。もし
<I>control</I>

が完全に空の場合には、
<I>mirror</I>

のすべてのファイルやディレクトリが削除される。もし
<I>mirror</I>

が完全に空の場合には、
<I>control</I>

のすべてのファイルやディレクトリがコピーされる。
<P>
要するに
<B>mirrordir</B>

は
<I>mirror</I>

をディレクトリツリー
<I>control</I>

の完全なレプリカにし、またその際にあらゆるものを
(定期的バックアップという目的に合致するなら)
可能な限り複製しようとする。当然
<B>mirrordir</B>

はサブディレクトリの一番深いところまで降りていく。
ディレクトリミラーの際には、それに必要な最小の変更のみを調べ、
可能な限り効率的に動作しようとする。
<P>
アクセス時刻の複製は通常は必要なく、また不要な負荷を与えることになる。
よってこれはオプションになっている。
<P>
ディレクトリ
<I>control</I>

には、何の変化も与えない。--restore-access
が与えられると、アクセス時刻は読み込みのたびに、
元の時刻に再設定される。
<P>
--strict-locking オプションをオンにすると、
<I>control</I>

にあるコピー作業中のファイルは「共有読み込み (shared reading)」
にロックされる。これによって、
他のプロセスがそのファイルに頻繁に書き込みを行っている場合でも、
ファイルが不完全な状態や壊れた状態ではコピーされないことを保証する。
<P>
通常
<B>mirrordir</B>

は問題があっても中断せず、
問題の報告を stderr へのエラーメッセージとして行い、
動作を継続する。
<P>
ディレクトリ
<I>mirror</I>

や
<I>dest</I>

は (たとえ空であっても) 存在していなければならない。
<P>
ディレクトリのすべてのファイルを削除する前に、
<B>mirrordir</B>

は <B>*--keep-me</B> というファイル (ここで <B>*</B> は 0 または 1 つの文字)
をチェックする。
このファイルが存在すると、エラーメッセージを出して中断する。
よって再帰的に削除されてはまずいディレクトリがあったら、
それぞれにこのようなファイルを作っておけば良い。

<P>
<B>copydir</B>

は <B>mirrordir</B> <I>-ck --no-erase-directories</I> ...
と等価である (-c には -k が含まれるが)。よって
<B>copydir</B>

は厳密な意味での
<B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1)

とよく似ているが、ファイル名は URL でも良く、
かつ古いファイルだけが置き換えられる。
ファイル転送には、ほとんどの場合
<B>mirrordir</B>

ではなく
<B>copydir</B>

を使うほうがよい。本当に消してよい場合に限り、
<B>mirrordir</B>

を使うようにすること。
<P>
<B>recursdir</B>

はまたもう一つのプログラムで、
コマンドライン上でディレクトリを降りてゆくだけで何も行わない。
これは <B>mirrordir</B> <I>--recures-mode</I> ...
と等価である。これは
<B>-C</B>

オプションが追加される前にできたプログラムで、より厳密な
<B><A HREF="../../GNU_findutils/man1/find.1.html">find</A></B>(1)

として、あるいは見つかったすべてのファイルを
tar ファイルにパックする目的に、それぞれ利用できる。
<P>

<B>pslogin</B>

はさらにもう一つのプログラムで、
これまでに挙げた 3 つとはほとんど関係がない。
<B>pslogin</B>

は
<B>secure-mcserv</B>

を用いて安全なログインセッションを開始する。
これは <B>mirrordir</B> <I>--login-mode</I> <I>--secure</I> ...
と等価である。
<B>pslogin</B>

は
<B>logindir</B>

と呼ぶべきかもしれない。後述の
<B>--login-mode</B>

を参照のこと。
<P>
<B>forward</B>

はさらにもう一つのプログラムで、
最初の 3 つとはほとんど関係がない。
これは任意のサービスを安全なチャネルにフォワードできる。
詳細は
<B><A HREF="../man1/forward.1.html">forward</A></B>(1)

を参照のこと。
<P>
このパッケージの重要な点は、
通常のファイル名に替えて URL を使える点にある。
よってファイルをネットワーク越しに操作できる。
現在サポートされている URL のタイプは、
<B>ftp://</B> と <B>mc://</B> である
(<B>http://</B> はファイルシステムではないので、サポートされていない)。
<B>mc://</B> は <B>Midnight Commander</B> ファイルシステムで、
<B>secure-mcserv</B>

デーモンによってサービスされるものである。
これには、暗号化された、
強く安全なファイル転送およびログインを提供するという長所がある。
<P>
<B>recursdir</B>

コマンドと
<B>copydir</B>

コマンドには glob 表現も利用できる。
これらは再帰的に展開される。
<A NAME="lbAE">&nbsp;</A>
<H2>セキュリティと暗号化</H2>

<B>mirrordir</B>

は、強力なストリーム cipher 暗号化と、
何種類かの鍵サイズでの Diffie-Hellman 鍵交換をサポートしている。
安全な接続は
<B>mc://</B>

の接続で動作する。オプション
<B>--secure</B>, <B>--key-size</B>, <B>--download-scripts</B>

を参照のこと。
デモは
<B>例</B>

の節を、公開鍵・秘密鍵の置場所については
<B>ファイル</B>

の節を参照のこと。
<A NAME="lbAF">&nbsp;</A>
<H2>オプション</H2>

<DL COMPACT>
<DT><B>--help</B>

<DD>
詳しいヘルプを出力して終了する。
<DT><B>--verbose</B><DD>
<I>mirror</I>

に対してなされたファイル修正に関して、
詳しい出力をするよう指定する。
このオプションは複数個指定でき、
たくさん指定するほどより詳しく出力する。
出力は標準出力に書き出される。
<DT><B>--restore-access</B><DD>
読み込むを行うごとに、
<I>control</I>

のアクセス時間を元に戻す。
<DT><B>--access-times</B><DD>
<I>control</I>

のアクセス時刻も複製する。
<DT><B>--always-write</B><DD>
同じに見えるかどうかに関らず、
すべてのファイルを書き変えるよう強制する。
<DT><B>--recurs-mode</B><DD>
これは
<B>recursdir</B>

ではデフォルトで有効になる。
指定したディレクトリを再帰的に読み、それらに対しては何も行わない。
このオプションは
ファイルを検索したり、
<B>-C</B>

と共に指定してシェルコマンドを実行したりするのに便利である。
なお C インタープリタでは
<B>system()</B>, <B>exec()</B>, <B>popen</B>

関数が利用できる。
<DT><B>--login-mode</B><DD>
このオプションは
<B>pslogin</B>

ではデフォルトでセットされる。これは
<B>secure-mcserv</B>

をサーバに使う
<B>rlogin</B>

とだいたい同じになる。
<B>ssh</B>(1)

の代わりに使えるような、安全な暗号化された接続を提供する。
<B>pslogin</B>

は暗黙のうちに
<B>--secure</B>

も指定する。このオプションを指定したり、
<B>pslogin</B>

を用いた場合は、コマンドラインにはパスを 1 つだけ指定しなければならない。
指定の形式は
[<B>mc://</B>][<I>username</I><B>@</B>]<I>hostname</I>[<B>:</B><I>portnumber</I>][<B>/</B><I>path</I>]
である。
<P>
ログイン後直ちに、シェルプロンプトから <B>cd</B> <I>/path</I>
が実行される。
<B>pslogin</B>

は文字 <B>#</B>, <B>$</B>, <B>&gt;</B> を調べ、
プロンプトが出たかどうか判断する。
これらが見つからないと、
<B>pslogin</B>

はずっと止まったままになる。この動作を避けるには、
<B>/</B><I>path</I>

を
<B>/</B>

とすれば良い。するとログインディレクトリに留まったままになる。
あるいはシェルプロンプトを変更して、これらの文字を含めるようにしてもよい。
<DT><B>--copy-mode</B><DD>
これは
<B>copydir</B>

ではデフォルトでセットされる。
コピー元・コピー先の各ファイルに対して
<B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1)

と同じように振る舞う。このオプションを用いると、暗黙のうちに
<B>--keep-files</B>

を指定したことになる。
コピー先の既存のファイル・ディレクトリのうち、
コピー元と同じ名前を持つものはすべて上書きされるが、
これ以外の理由でファイルやディレクトリが削除されることはない。
コピー元には複数のファイルやディレクトリを指定できる。
コピー先のパスはディレクトリでなければならない。
<DT><B>--no-erase-directories</B><DD>
このオプションを指定すると、
コピー先のディレクトリとコピー元のファイルがおなじ名前で、
かつそのディレクトリが空でない場合、
エラーメッセージを表示して終了する。これは
<B>copydir</B>

のデフォルトの動作である。
<DT><B>--erase-directories</B><DD>
このオプションを指定すると、
コピー先のディレクトリとコピー元のファイルがおなじ名前の場合、
コピー先のディレクトリは再帰的に削除される。これは
<B>mirrordir</B>

のデフォルトの動作である。
<DT><B>--allow-empty-ftp-dirs</B><DD>
ftp サーバには、 . とか .. といったディレクトリを生成しないものがある。
そのような場合、ディレクトリへの読み取り許可がないように見えてしまう。
このオプションを用いると、この動作を変更し、
このような完全に空のディレクトリを単に空であるとみなしてエラーにしない。
<B>unable to open directory: *: Permission denied</B>
というエラーになった場合は、このオプションを試してみるとよい。
このオプションはデフォルトでは有効になっている (次項を参照のこと)。
<DT><B>--no-allow-empty-ftp-dirs</B><DD>
現在はディレクトリに cd してアクセス許可を調べるためにようになったので、
デフォルトの動作は空のディレクトリを許可するようにした。
<DT><B>--only-delete</B><DD>
<I>mirror</I> に対して、利用しているディスクスペースを
増加させるような変更は一切行なわない。
これは容量の限られているドライブに対してバックアップを取る場合、
転送の最中に <I>control</I> に <I>mirror</I> を増加させてしまうような
変更がなされるときに便利である。
一度このオプションをつけて <B>mirrordir</B> を実行すれば、
次にこのオプションをつけて実行したときには、
利用できる領域を越えないことが通常は保証される。
<DT><B>-i</B>, <B>--ignore-next-exclude</B><DD>
このオプションを指定すると、次の --exclude- タイプのオプションは、
対象ファイルが mirror ディレクトリにあろうと無かろうと、
それらを完全に無視することになる。
これは後述する
<B>--exclude-script</B>

オプションで <B>IGNORE</B> が返った場合と同じ効果を持つ。
これは特定のファイルを決して変更しないようにするのに利用できる。
例えば
<I>/etc/named.boot</I>

を決して変更したくない場合には、
<B>mirrordir /mnt/1 /mnt/2 -i --exclude /mnt/1/etc/named.boot</B>

とすればよい。mirror ディレクトリではなく、
control ディレクトリのフルパスで指定することに注意。
<B>--exclude /mnt/2/etc/named.boot</B>

では動作しない。
後者では、ファイルを削除したくない場合には
そのファイルが control ディレクトリに存在しなければならない
(たとえサイズ 0 であっても) という馬鹿げた動作となる。
<DT><B>--exclude</B> <I>path</I><DD>
ファイルまたはディレクトリ
<I>path</I>

を除外する。コマンドラインにたくさんの exclude パスを指定すると、
動作が遅くなってしまう。除外されたパスは、
mirror ツリーに存在する場合は削除される
(そのディレクトリまたはファイルが存在していない場合と同様である)。
これらのファイルを削除せずに無視して保持しておきたい場合は、
--ignore オプションを用いること。
<P>
除外するファイルが長いリストになる場合は、
<B>--exclude-from</B>

オプションを利用すること。
<DT><B>--exclude-glob</B> <I>glob</I><DD>
glob 形式の表現
<I>glob</I>

にマッチするファイルするディレクトリを除外する。
ファイルへのマッチではフルパスを用いない。
シェルにおいては、glob 表現を適切な引用符で括り、
解釈されないようにする必要がある。
<DT><B>--exclude-regexp</B> <I>regex</I><DD>
フルパス名が
<I>regex</I>

にマッチするファイルやディレクトリを除外する。
シェルにおいては、正規表現を適切な引用符で括り、
解釈されないようにする必要がある。
<DT><B>--exclude-script</B> [<I>expr</I>|<I>file</I>]<DD>
<DL COMPACT><DT><DD>
各ファイルに対する処理を行なう前に、スクリプト <I>expr</I> を実行する。
このスクリプトは
C 言語スタイルの文ブロックからなり、`<B>return</B> <I>expression</I>;'
で終了する。
<I>expression</I>

の値は
<B>INCLUDE</B>,

<B>EXCLUDE</B>,

<B>UNKNOWN</B>

<B>IGNORE</B>

(上述の <B>-ifP を見よ)
のいずれかであり、そのファイルに対して成すべき動作を示す。
</B><I>expr</I>

にセミコロン (;) が含まれていない場合は、
これはファイル名とみなされ、そのファイルがロードされる。
それ以外の場合は、テキストは高速化のために
逆ポーランド形式にコンパイルされる。
このオプションは複数指定でき、
その場合スクリプトは
<B>UNKNOWN</B>

以外の値が返るまで、順に実行される。
<B>UNKNOWN</B>

が返った場合は、コマンドラインにあるその他の
<B>--exclude-</B>

形式のオプションが効力を持つ。
<P>

インタープリタがおかしなエラーを報告したり、
セグメンテーションフォールトを起こした場合は、
その原因となったスクリプトを私に送ってほしい。
<P>

このスクリプト言語自体は、C プログラミング言語のサブセットである。
例えば以下のようなものは正しいスクリプトである。
<P>

<PRE>
/* PATH はファイルのフルパス名で、DIR は末尾に
   スラッシュ (/) の無いディレクトリ、CWD は
   カレントワーキングディレクトリ、dpath() は
   フォワードスラッシュ (/) の個数-1 を返す。*/
if (depth (DIR) - depth (CWD) &gt; 3) {
    printf (&quot;%s: excluded\n&quot;, PATH);
    return EXCLUDE;
} else
    return INCLUDE;
</PRE>

<P>

このスクリプト言語は代入演算子をサポートしない。
したがってユーザ定義変数をサポートしない。
<P>

以下の定義済みマクロを利用できる。
マクロの展開は、ディレクトリにもファイルと等しく同じように適用される。
<DL COMPACT>
<DT><B>FILE</B><DD>
現在のファイル (パス無し)
<DT><B>NAME</B><DD>
パス・拡張子の無いファイル名。末尾にドット (.) は付かない。
<DT><B>EXTENSION</B><DD>
ファイルの拡張子。先頭にドット (.) は付かない。
<DT><B>DIR</B><DD>
ファイル名の無いディレクトリ。末尾にスラッシュ (/) は付かない。
<DT><B>PATH</B><DD>
フルパスのファイル名
<DT><B>CWD</B><DD>
カレントワーキングディレクトリ
<DT><B>TIME</B><DD>
現在時刻 (秒単位)
</DL>
<P>

C のすべての論理演算子・算術演算子・ビット演算子がサポートされている。
すなわち <B>(</B>
<B>)</B>
<B>&gt;=</B>
<B>&lt;=</B> 
<B>&gt;</B>
<B>&lt;</B>
<B>!=</B>
<B>==</B>
<B>&amp;&amp;</B>
<B>||</B>
<B>!</B>
<B>-</B>
<B>+</B>
<B>*</B>
<B>/</B>
<B>%</B>
<B>&amp;</B>
<B>^</B> で、これらは全て C のものと同じ意味を持つ。
<P>

さらに以下に示すマクロも利用できる。
各々は整数 (C での <B>long int</B> 型) を返す。
これらはそのファイルに対する <B>lstat</B>
(または <B>--follow-symlinks</B> が用いられている場合は <B>stat</B>)
を基にしている。詳しい説明は
<B><A HREF="../../LDP_man-pages/man2/stat.2.html">stat</A></B>(2)

を参照のこと。
<P>

<B>stat.st_dev</B> - デバイス
<BR>

<B>stat.st_ino</B> - i-ノード
<BR>

<B>stat.st_mode </B> - 許可属性 (permission)
<BR>

<B>stat.st_nlink</B> - ハードリンクの数
<BR>

<B>stat.st_uid</B> - 所有者のユーザ id
<BR>

<B>stat.st_gid</B> - 所有者のグループ id
<BR>

<B>stat.st_rdev </B> - デバイスタイプ
<BR>

<B>stat.st_size </B> - ファイルサイズ (バイト単位)
<BR>

<B>stat.st_blksize</B> - ファイルシステム I/O のブロックサイズ
<BR>

<B>stat.st_blocks</B> - アロケート済みのブロック数

<BR>

<B>stat.st_atime</B> - 最後にアクセスされた時刻 (秒単位)
<BR>

<B>stat.st_mtime</B> - 最後に変更された時刻 (行単位)
<BR>

<B>stat.st_ctime</B> - 作成された時刻
<P>

以下の関数はブール値を返す。
<DL COMPACT>
<DT><B>strncmp</B>(<I>string1</I>, <I>string2</I>, <I>integer</I>);<DD>
string1 が string2 より小さい場合は 0 以下の整数を、
マッチする場合は 0 を、
大きい場合は 0 以上の整数を返す。
<DT><B>glob</B>(<I>glob</I>, <I>string</I>);<DD>
<I>string</I>

が glob 表現
<I>glob</I>

にマッチする場合は 0 を返す。
下層の実装における効率を良くしたい場合は、
あなたが書くコードでの glob 表現をひとつに限ってみること。
<DT><B>regexp</B>(<I>regexp</I>, <I>string</I>);<DD>
<I>string</I>

が正規表現
<I>regexp</I>

にマッチする場合は 0 を返す。
下層の実装における効率を良くしたい場合は、
あなたが書くコードでの正規表現をひとつに限ってみること。
<DT><B>strstr</B>(<I>string1</I>, <I>string2</I>);<DD>
<I>string1</I>

の長さの範囲に最初に現れる
<I>string2</I>

の位置を返す。現れない場合は 0 を返す。
</DL>
<P>

以下の関数もブール値を返す。これらは
<B><A HREF="../../LDP_man-pages/man2/stat.2.html">stat</A></B>(2)

で説明されているマクロに対応している。
これらは、指定された条件が真の場合に非ゼロの値を返す。
<P>

<B>S_ISLNK</B>(<I>integer</I>); - ファイルはシンボリックリンク
<BR>

<B>S_ISREG</B>(<I>integer</I>); - ファイルは通常のファイル
<BR>

<B>S_ISDIR</B>(<I>integer</I>); - ファイルはディレクトリ
<BR>

<B>S_ISCHR</B>(<I>integer</I>); - ファイルはキャラクタデバイス
<BR>

<B>S_ISBLK</B>(<I>integer</I>); - ファイルはブロックデバイス
<BR>

<B>S_ISFIFO</B>(<I>integer</I>); - ファイルは fifo
<BR>

<B>S_ISSOCK</B>(<I>integer</I>); - ファイルはソケット
<P>

以下の関数は文字列を操作する。
<DL COMPACT>
<DT><B>strcat</B>(<I>string1</I>, <I>string2</I>);<DD>
<I>string1</I>

に
<I>string2</I>

を連結して返す。
<B>+</B>

演算子も文字列を連結することに注意。
<DT><B>depth</B>(<I>string</I>);<DD>
<I>string</I>

に現れるフォワードスラッシュ (/) の個数から 1 を引いたものを返す。
<DT><B>printf</B>(<I>format</I>, ...);<DD>
<B><A HREF="../../LDP_man-pages/man3/printf.3.html">printf</A></B>(3)

のように動作する。ただし重要な例外がある:
<B>long int</B>

のフォーマット指定以外は使ってはならない。
これ以外の指定を行なったときの変換結果は未定義である。
例えば、<B>&quot;%d&quot;</B> ではなく <B>&quot;%ld&quot;</B> を用いること。
結果は標準出力に表示される。
</DL>
<P>

以下の関数はシステムコールを実行する。
<DL COMPACT>
<DT><B>system</B>(<I>command</I>);<DD>
<B>/bin/sh -c</B>

<I>command</I>

を実行する。しかし C 言語のものとは異なり、
コマンドの終了コードを返す。
つまり、一行だけのシェルスクリプト
<I>command</I>

を実行する。
<DT><B>exec</B>(<I>argv0</I>, <I>argv1</I>, ...);<DD>
プロセス
<I>argv0</I>

を引数
<I>argv1...</I>

で実行する。
<I>argv0</I>

フルパスで指定しなければならない。
これは <B>sh</B> を経由しないので <B>system</B> より速い。
<DT><B>popen</B>([<I>string</I>, ] <I>shell_command</I>);<DD>
<B>system</B>

と似ているが、
<I>shell_command</I>

の出力を文字列として返す。
<I>string</I>

が与えられている場合には、その文字列を
<I>shell_command</I>

の標準入力に与え、成功したら 0 を返す。
</DL>
<P>

以下の整数定数も利用可能で、stat.h で定義されているマクロ
(説明は
<B><A HREF="../../LDP_man-pages/man2/stat.2.html">stat</A></B>(2)

にある) に対応する。
<P>

<B>S_IFMT S_IFSOCK S_IFLNK S_IFREG S_IFBLK S_IFDIR S_IFCHR S_IFIFO
S_ISUID S_ISGID S_ISVTX S_IRWXU S_IRUSR S_IWUSR S_IXUSR S_IRWXG
S_IRGRP S_IWGRP S_IXGRP S_IRWXO S_IROTH S_IWOTH S_IXOTH</B>
<P>

以下の定数のひとつを
<B>return</B>

文を用いて返し、呼出し元に意図を伝える必要がある。
何も返さない場合は、返り値は
<B>UNKNOWN</B>

であるとみなされる。
<DL COMPACT>
<DT><B>UNKNOWN</B><DD>
どうすべきか分からない。引き続き他の
<B>--exclude-</B>

タイプのオプションを実行する。
<DT><B>INCLUDE</B><DD>
そのファイルを処理に含める。
<DT><B>IGNORE</B><DD>
そのファイルが mirror ディレクトリにあろうと無かろうと、
何も行なわない。
<DT><B>EXCLUDE</B><DD>
そのファイルが control ディレクトリに存在しないものとみなす。
よって mirror ディレクトリからは削除される
(これは
<B>--keep-files</B>

オプションよりも優先される)。
</DL>
<P>

以下は C のようなフロー制御を行なう。
<P>

以下の
<B>if</B>

文は
<I>integer</I>

が真 (つまり非ゼロ)
ならば
<I>statement1</I>,

<I>statement2</I>

などを実行し、
それ以外の場合は
<I>statementA</I>,

<I>statementB</I>

などを実行する。

<B>else</B>

{...} の部分は省略可能である。
<P>

<PRE>
    <B>if</B> (<I>integer</I>) {
        <I>statement1</I>;
        <I>statement2</I>;
        .
        .
        .
    } <B>else</B> {
        <I>statementA</I>;
        <I>statementB</I>;
        .
        .
        .
    }
</PRE>

<P>

<B>return</B>

文は
<B>mirrordir</B>

に値を返し、スクリプトを終了させる。
<P>

<PRE>
    <B>return</B> <I>expression</I>;
</PRE>

<P>

<B>exit</B>

関数は、
<B>mirrordir</B>

を指定した終了コードで終了させる。
<P>

<PRE>
    <B>exit</B>(<I>integer</I>);
</PRE>

<P>

通常 C スクリプトは、特定のファイルを除外するために用いる。
これはスクリプト言語の実装としてはやりすぎで、
機能のすべてを一般用途向けに書いたわけではない。
典型的なスクリプトは、例えばデバイスファイルを除外する、
という程度のことに留まるだろう。
<P>

<PRE>
if (S_ISSOCK(stat.st_mode) || S_ISFIFO(stat.st_mode)
         || S_ISBLK(stat.st_mode) || S_ISCHR(stat.st_mode)) {
    return EXCLUDE;
} else
    return INCLUDE;
</PRE>

<P>

<B>--recurs-mode</B>

オプションとともに用いれば、
C スクリプトはファイルを検索するためにも利用できる
(<B>recursdir</B>

コマンドと同じ):
<P>

<PRE>
/* core ファイルを全て削除する */
/* この例は <B>例</B> セクションに移動した。 */
</PRE>

</DL>

</DL>
<P>

<DL COMPACT>
<DT><B>--exclude-from</B> <I>file</I><DD>
ファイル
<I>file</I>

に書かれているリストに含まれるパスを除外する。
空行とコメント行 (行頭の文字が # の行) は無視される。
このファイルのリストはソートされ二分木探索されるので、
たくさんのファイル名を除外したい場合には、
ここにそれらのファイルを書く方が性能は良くなる。
このオプションは複数指定でき、複数個のファイルを指定できる。
<B>バグ:</B>

<I>file</I>

の最後に与えたパスは、改行で終らなければならない。
<DT><B>--backup-extension</B> <I>level</I><DD>
ファイルを削除したり置き換えたりする前に、
それらのファイルのバックアップを作る。
<I>extension</I>

は C 形式のフォーマット文字列で、例えば .ORIG.%d
(% へのシェル代入に注意) のようにする。
<I>level</I>

は保存しておくリビジョンの最大数。
<I>extension</I>

がファイル名に追加され、古いファイルほど大きな番号を持つ。
<DT><B>--backup-outdate </B><I>sec</I><DD>
<I>sec</I>

秒よりも古いバックアップファイルを削除する。
<DT><B>--nice</B> <I>num</I> <DD>
時々スリープして、他のプロセスに対して行儀良く振る舞う。
--nice を指定すると、プロセスはアクティブであった時間の
<I>num</I>

倍の時間スリープする。したがって 1 を指定すると
(非常におおざっぱに言えば) コピーに要する時間は 2 倍になり、
3 を指定すれば 4 倍になる。
これは定期的なバックアップを、
CPU 負荷を小さくして行ないたい場合に利用するとよい。
システムによっては --nice は利用できないかもしれない。
<DT><B>--no-chmod</B><DD>

通常はファイルの許可属性設定が行なわれる。
アクセス権限が制限されていて、許可属性を変更できない場合は、
このオプションを指定すれば許可属性設定を無効にできる。
<DT><B>--no-chown</B><DD>

通常はファイルの所有権設定が行なわれる。
アクセス権限が制限されていて、所有者を変更できない場合は、
このオプションを指定すれば所有権設定を無効にできる。
<DT><B>--mtime-threshold</B> <I>sec</I><DD>
mtime の違いがこの値よりも小さい場合には、
ファイルは上書きされない。ftp サイトをミラーした場合、
そのミラー中の mtime は分の単位の精度しか持たないので、
これを nfs ミラーしようとするとすべてのファイルがコピーされる。
これを直すには --mtime-threshold 60 を用いればよい。
<DT><B>--time-offset</B> [[<I>+</I>]|<I>-</I>][<I>H</I>]<I>H</I>[<I>:MM</I>]<DD>
vfs な (つまり ローカルでない) ディレクトリの時刻オフセットを設定する。
例えば私は New York より 8 時間東にいるので、
New York からミラーする場合には
<B>--time-offset -8:00</B>

を使っている。
<DT><B>--test-only, --dry-run</B><DD>
実際には変更を行なわない。
--verbose と共に用いると、
どのような変更がなされるかを表示できる。
これはディレクトリ間の比較をするのにも効果的な方法である。
<I>これはテストされていない。
すなわち、このオプションが</I><B>本当に</B><I>変更をしないかどうかは、
私は保証できない。</I>
<DT><B>--skip-symlinks</B><DD>
シンボリックリンクは、読み込まれなかったかのように扱われる。
よってそれらが mirror ディレクトリにあると、削除される。
<DT><B>--keep-files</B><DD>
ファイルが
<I>control</I>

に無い場合でも、そのファイルを
<I>mirror</I>

から削除しない。こうすると
<B>mirrordir</B>

はある意味
<B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1)

のようになる。
<DT><B>--no-hard-links</B><DD>
このオプションが指定されない限り、
<B>mirrordir</B>

はハードリンク属性を正しくミラーする。
指定されると、ハードリンクは通常ファイルのようにコピーされる。
<DT><B>--follow-symlinks</B><DD>
このオプションが指定されなければ、
<B>mirrordir</B>

はシンボリックリンクを適切にミラーする。
指定されると、シンボリックリンクは通常ファイルとしてコピーされる。
Debian ツリーをミラーするときに便利である。
注意してほしいのは、
シンボリックリンクは control と mirror の両方で解決される、
という点である。
依ってシンボリックリンクが mirror ディレクトリに存在していると、
それらはそのままシンボリックリンクのまま残る。
<B>--follow-symlinks</B>

を指定すると、暗黙のうちに
<B>--no-hard-links</B>

も指定したことになる。
<DT><B>--strict-locking</B><DD>
ファイルを読み込むとき、共有読み込みのロックを作成する。
これはファイルコピーの事故を予防する。
特にメールディレクトリに対して有効である
(メールプログラムは
<B>mirrordir</B>

がファイルを読み込もうとしているときに、
同時にそれらに書き込みを行なおうとするかもしれない)。
このオプションは仮想ファイルシステムに対しては効力を持たない。
<DT><B>--max-bytes </B>[[<B></B><I>num</I>[<B>k</B>|<B>M</B>|<B>G</B>]]<B></B>|<B></B><I>num</I>]

<DD>
このバイト数を越えると `filled up all blocks - first file/dir not mirrored:
<I>path</I>' というメッセージが標準出力に表示される。
残りのファイルは <I>mirror</I> から削除されるが、
これはリストされた順序で行なわれる。よって
<B>mirrordir</B>

が走り続けていると、アーカイブの大きさが <I>num</I> を越えることがある。
この偶発分のゆとりをとって、
<I>num</I> は利用できるスペースより小さくしておくこと。
またファイルシステムによっては、
完全にいっぱいになる前に `No space left on device'
というメッセージを出すことがある。
<B>mirrordir</B>

には <B>--starting-file</B> <I>path</I> オプションがあり、
これを用いると別のデバイスで作業を継続できる。
こうすれば、複数のデバイスに対して
<B>mirrordir</B>

を用いたバックアップができる。
<I>num</I>

には
<B>k</B>,

<B>M</B>,

<B>G</B>

(大文字小文字を区別する) のいずれかを後置でき、
それぞれキロバイト、メガバイト、ギガバイトを指定する。
どれかひとつのファイルがこの数値よりも大きいと、
エラーメッセージが表示される。
<B>--block-size</B>

も参照のこと。
<DT><B>--password </B><I>password</I>

<DD>
FTP 接続・mc:// 接続に対するパスワードを設定する。
匿名接続の場合のパスワードは、
デフォルトで「ログイン名@ローカルマシン名」になっている。
それ以外のログインパスワードは、プロンプトが出て尋ねられる。
いつもの警告だが、
パスワードをスクリプトに含めるのはセキュリティ上のリスクがある。
パスワードは
<B>~/.netrc</B>

ファイルに入れ、
<B>--no-netrc</B>

オプションを指定しないかたちの方がずっと良い。
詳細は
<B>man ftp</B>

を見よ。
<DT><B>--password-exact</B> <I>password</I>]<DD>
匿名パスワードの前に <B>-</B> を前置しない。
ftp の匿名パスワードでは、通常パスワード文字列の前に
<B>-</B> が置かれる。私は
Midnight Commander vfs がなぜこのようにしていたのか知らないが、
あるユーザがこの問題に突き当たったので、
このオプションを設け、パスワードを
<I>password</I>

に指定した通りに送れるようにしている。
<DT><B>--test-login</B><DD>
<B>--login-mode</B>

や
<B>pslogin</B>

を用いるとき、非対話的なアクセスをテストしてみたいことがあるだろう
(例えばシェルスクリプトで用いたいときなど)。
これを行なうには、
<B>pslogin</B>

をこのオプションとともに実行し、終了ステータスを見ればよい。
<B>secure-mcserv</B>

は、ユーザがパスワードサーバにログインできるかどうかを調べるために、
これを用いている。
<DT><B>--no-warn-first-login</B><DD>
あるマシンに対して最初に安全な接続を試みた時は、
公開鍵がローカルマシンに存在しない。
よって「間に人」攻撃に対して無防備である。
この内容に関する警告が表示され、
ユーザにプロンプトが出され、継続したいかどうか尋ねられる。
このオプションはこの警告を出さないようにし、
一切を無視して先に進む。
<DT><B>--read-password-from-stdin</B><DD>
パスワードをコマンドラインから指定するのではなく、
標準入力から与える。
これは見えないパスワードをタイプ入力するのと同じではない。
こちらは端末が無い場合にでも使える。
これは他のプログラムから、例えば
<B><A HREF="../../LDP_man-pages/man3/popen.3.html">popen</A></B>(3)

などを用いて利用する場合に都合が良い。
<B>secure-mcserv</B>

は、ユーザがパスワードサーバにログインできるかどうかを調べるために、
これを用いている。
<DT><B>--netrc</B>

<DD>
<B>~/.netrc</B>

をスキャンする。デフォルトでこのオプションは on になっている。
<DT><B>--no-netrc</B>

<DD>
<B>~/.netrc</B>

ファイルの読み込みを行なわない。
<DT><B>--proxy-host</B> <I>host</I><DD>
ftp ダウンロードのプロキシを設定する。
これがどのように動作するのか、
あるいは実際に動作するかどうかは私にはわからない。
プロキシのサポートについては
<B>mc</B>(1)

にあたってほしい。
<DT><B>--secure</B>

<DD>
(<I>この機能はβ段階である</I>) 私は
<B>mirrordir</B>

用に安全なソケット層を実装した。これはこのオプションで有効となり、
<B>secure-mcserv</B>

の接続 (すなわち <B>mc://</B> 形式の URL) に適用される。
安全なソケットのライブラリは
<B>libdiffie.a</B>

とヘッダファイル
<B>diffie-socket.h</B>

からなる。
<B>sys/socket.h</B>

の後に
<B>diffie-socket.h</B>

をインクルードし、そのプログラムを際コンパイルすれば、
通常のソケットが全て安全なソケットになる
(これは Unix のソケットコールを用いる、あらゆるプログラムに当てはまるが、
しかしテストはされていない)。
これをサポートする最初のサービスは
<B>secure-mcserv</B>

で、デフォルトでコンパイルされ、インストールされる。
よって、リモートのホストも
<B>secure-mcserv</B>

を走らせていれば、
<B>mc://</B> ファイルシステムは
<B>--secure</B>

オプションで利用できる (<B>secure-mcserv -h</B> とすればヘルプが表示される)。
<B>--secure</B>

は、DES などのブロック cipher よりずっと安全で高速なストリーム cipher を、
公開鍵サーバ認証 (Diffie-Hellman 及び p-NEW スキーム) の
離散対数鍵交換で用いている。

詳細はソース配布の
<B>diffie-socket.h</B>

を見てほしい。デフォルトの鍵のサイズは 512 ビットである。
<I>gcc</I>

を用いている場合は、
<B>mirrordir</B>

のコンパイル時に
<B>-O3 -fomit-frame-pointer -s -Wall</B>

オプションをつけると、鍵生成が高速化される。
<DT><B>--key-size </B><I>bits</I>

<DD>
デフォルトの鍵サイズは 512 ビットである。
サイズを変更するには素数を生成して fileld.c に書き込まなければならないので、
field.c にリストされているサイズだけがサポートされており、

現時点ではこれは 512, 768, 1024, 1536 である。
遅い計算機を用いている場合には、中程度のセキュリティとなる 768 を奨める。
それ以外なら、長い目で見れば 1536 も非合理で偏執的な値、というわけでもない。
巨大企業・良くつないでくるハッカー・政府などがあなたの接続を
盗聴している心配がなければ、512 でも構わないだろう。
ストリーム cipher は <B>bits</B>/2 の長さを持つので、クラックされる確率は、
宝くじを換金しているあいだに隕石にぶち当たる確率よりは低い。
ただしある人間が接続を盗聴し、長い間出力をとり続ければ、
破ることは不可能ではない。
20 年も経てば、1536 ビットの鍵も小さいと考えられるかもしれない。
また (ここで用いられている) 離散対数問題は、
素因数分解よりも解くのが難しいと考えられているので、
鍵は RSA よりも実効的にやや大きいことになる。
これは私の (どちらかというと無学な) 意見である。
<DT><B>--download-scripts</B><DD>
<B>mirrordir</B>

には 2 つの版、<I>International</I> 版と <I>US</I> 版がある
(<B>--version</B>

を見よ)。<I>US</I> 版は暗号化に類するコードを一切含んでいない。
その代わり、必要なアルゴリズムを (<B>南アフリカ</B> にある)
<B>encrypt.obsidian.co.za</B>

からダウンロードするようになっている。
これらは高速かつネイティブな、C 形式のインタープリタ言語で書かれている。
これらは 4 つのスクリプトからなる。それぞれ、
Diffie-Hellman 鍵交換サーバ、Diffie-Hellman 鍵交換クライアント、
ストリーム cipher の初期化、実際にストリーム cipher を用いた暗号化、
のためのものである。
<B>mirrordir</B>

は、あなたがセキュリティ機能を用いようとすると、
自動的にこれらのスクリプトをダウンロードする。しかしこの
<B>--download-script</B>

オプションを用いると、いつでもダウンロードを実行できる。
<I>International</I> 版にはストリーム cipher が組み込まれていて、
2 つのスクリプトだけを用いるが、
これらは配布に含まれているのでダウンロードの必要はない。
Diffie-Hellman 交換をスクリプトで用いても、速度的な劣化は生じない。
しかし暗号化に関しては、
スクリプトと組み込みの間の違いが結構大きいかもしれない。
<DT><B>--version</B><DD>
バージョン番号と、
この
<B>mirrordir</B>

が
<I>International</I>

版か
<I>US</I>

版かを表示する。
<B>--download-scripts</B>

を見よ。
<DT><B>-z</B>, <B>--gzip</B><DD>
<B>mc://</B>

接続で圧縮を有効にする。
実際には符号化よりも低いレベルにある圧縮ソケット層を呼出す。
圧縮は
<B><A HREF="../../GNU_gzip/man1/gzip.1.html">gzip</A></B>(1)

の
<B>libz</B>

ライブラリを用いて行なう。圧縮の程度は、
転送時間を最小化するように動的に設定される。
高速なイーサネット接続なら無圧縮にまで低くなりうるし、
モデム経由の遅い接続では最大圧縮にまで高くなる。
このアルゴリズムは、TCP の write コールが、
同量のデータを
<I>deflate</I>

する (つまり圧縮する) 時間の 2〜5 % の範囲になるように、
圧縮レベルを調整する。
<DT><B>--gzip-backups</B><DD>
バックアップは通常は単にファイルのコピーである。
このオプションを指定すると各ファイルは圧縮され、
<B>.gz</B>

がデフォルトの拡張子として付加される。
バックアップの拡張として、あなたが自分で
<B>--backup-extension</B>

の指定を行なった場合は、その末尾が
<B>.gz</B>

で終らないと、比較が正しく動作しない。
<DT><B>--case-insensitive</B>, <B>--for-Robert-Seese</B><DD>
ファイル名やリンク名の比較に、大文字小文字の違いを無視する。
これは、特定の頭の悪い OS と通信するときに便利だろう。
このオプションがすべての状況で正しく動作するかどうかは、あまり自信が無い。
<DT><B>--to-lower</B><DD>
<DT><B>--to-upper</B><DD>
すべての新しいファイル名を大文字または小文字に変換する。
<B>--case-insensitive</B>

と共に用いると、新しいファイルを作成する場合にのみ適用される。
<B>--case-insensitive</B>

なしで指定すると、既存かどうかに関らす、
すべてのファイルが大文字・小文字に変換される。
このときの方法は非効率的なもので、
古いファイルを一度消してから、新しいファイルを再度コピーする。
これは、特定の頭の悪い OS と通信するときに便利だろう。
このオプションがすべての状況で正しく動作するかどうかは、あまり自信が無い。
<DT><B>--no-use-passive-connections</B><DD>
<B>could not setup passive mode</B>

というエラーメッセージを受け取った場合、
このオプションを有効にする必要があると考えられる。
私は `passive' の意味するところを完全には理解していないので、
私には聞かないでほしい。
<DT><B>--tar-file</B> <I>filename</I><DD>
これは
<B>recursdir</B>

と共にのみ用いる。tar アーカイブを GNU
<B><A HREF="../../GNU_tar/man1/tar.1.html">tar</A></B>(1)

と同じフォーマットで作成し、
<I>filename</I>

に保存する。先頭の特殊なプレフィックスと末尾のスラッシュは削除される。
すなわち
<I><A HREF="http://machine/dir/file">http://machine/dir/file</A></I>

は
<I>dir/file</I>

になる。ファイル名の先頭文字が | の場合、
テキストの残りは出力がパイプされるコマンドとみなされる。
よって gzip 圧縮アーカイブは、例えば以下のようにすれば作成できる。
<BR>

recursdir <A HREF="ftp://machine/dir">ftp://machine/dir</A> --tar-file '| gzip -d &gt; foo.tar.gz'
<DT><B>--tar-block-size</B> <I>N</I><DD>
tar 出力のブロックサイズを 512 * <I>N</I> にする。
これはデータをアーカイブに書き込むときの単位である。
デフォルトは 20。
これはブロックデバイスに書き込むときに限って意味を持つ。
これを
<B>--block-size</B>

と混同しないこと。
<DT><B>--block-size </B><I>bytes</I>

<DD>
デフォルトのブロックサイズは 1024 バイトである。
消費されるブロックの総数を計算する際、
ファイルサイズは隣接するブロック末尾に切り上げられる。
実際のブロックサイズがこの値よりも大きいと、
書き込み時に実際に利用されるブロック数よりも、
計算値が小さくなる可能性がある。
よって
<B>--max-bytes</B>

オプションを用いるときには、実際のブロックサイズと同じ、
またはより大きな値を指定することがとても大切である。
<DT><B>--strict-mtimes</B>

<DD>
通常ファイルをコピーする場合、
<B>mirrordir</B>

は通常 mirror のファイルが
control のファイルよりも「古い」場合に限って上書きコピーを行なう。
このオプションを用いると、
ファイル間に修正時刻の「何らかの」差異があれば、コピーを行なう。
<DT><B>--no-mtimes</B><DD>
サイズが違う場合に限ってコピーする。
ファイルの修正時刻は無視する。
<DT><B>--ignore-size</B><DD>
ファイルのコピーを mtime に基づいて行ない、
サイズの違いは無視する。
<DT><B>--starting-file </B><I>path</I>

<DD>
<I>path</I>

はファイルまたはディレクトリ。
<I>path</I>

が読まれるまでは、ファイルやディレクトリは除外ファイル
(つまり
<I>mirror</I>

にある場合は削除される) のように扱われる。
<I>path</I>

を含むディレクトリは、存在していなければ作成される。
<I>path</I>

が読み込まれると、ファイルやディレクトリは通常にミラーされる。
<I>path</I>

そのものもミラーされる。
<I>path</I>

またはそのサブディレクトリが存在していない場合は、

<B>mirrordir</B>

は直ちに終了する。
これは
<B>mirrordir</B>

が作業前に終了する唯一の場合である。
これは
<I>path</I>

が見つからない場合に、ファイルシステム全体が削除されるのを防ぐためである。
</DL>
<A NAME="lbAG">&nbsp;</A>
<H2>FTP のサポート</H2>

ftp 転送が、
Midnight Commander の仮想ファイルシステム
(Virtual File System: <B>VFS</B>) を利用する形でサポートされている。
要するにつまり、URL もローカルディレクトリと同じようにサポートされている。
以下に例を示そう。
<PRE>
    mirrordir --verbose \ 
        <A HREF="ftp://lava.obsidian.co.za/pub/mirrordir">ftp://lava.obsidian.co.za/pub/mirrordir</A> \ 
            /home/mirrordir
</PRE>

あるいは
<PRE>
    mirrordir --verbose /home/mirrordir \ 
        <A HREF="ftp://psheer@lava.obsidian.co.za/home/ftp/pub/mirrordir">ftp://psheer@lava.obsidian.co.za/home/ftp/pub/mirrordir</A>
</PRE>

も動作する。ただし後者ではまずパスワードを尋ねられる。
ftp サーバに「アップロード」を行う場合は、
--strict-mtimes オプションは on にすべきでない。
ftp では修正時刻の設定はできないので、
すべてがコピーされてしまう。
<P>

(--verbose を設定すれば)
<B>mirrordir</B>

が繰り返し ftp
で修正時刻とアクセス時刻をセットしようとしていることに気づくだろう。
用いている VFS のタイプにおける制限をユーザに知らせるために、
これらのメッセージは残しておくつもりである。
これらの試行は、明らかな性能の劣化としては現われない。
しかしこのプロトコルを用いたアップロードの性能が悪い場合は、代わりに
<B>mc://</B>

を用いてみるといいだろう。
なおダウンロードは常にアップロードよりも高速である。
<P>

一般に cron ジョブでは ftp アップロードを用いるべきではない。
またディレクトリの同期を取る目的にも向いていない。
ディレクトリを同期したい場合は、反対側からのダウンロードを用いること。
アップロードは一回きりのアップロードにしか有用でない。
<A NAME="lbAH">&nbsp;</A>
<H2>例</H2>

ここでは
<B>mirrordir</B>

を用いて行える、ちょっと気の効いた作業を紹介する。
<DL COMPACT>
<DT><B>ミニマリスト的コピー</B>

<DD>
<DL COMPACT><DT><DD>
ソースツリーが 2 つあり、
古い版をパッチを適用するために保管しておきたいとする。
これには
<B>mkdir tree.OLD</B>

して、
<P>

<PRE>
    <B>  mirrordir -v tree tree.OLD</B>
</PRE>

<P>

するだけでよい。
もう一度
<B>mirrordir</B>

を実行すれば、最小限の変更のみ (つまり更新されたファイルのみ)
がコピーされる (実は
<B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1)

も同じことをする)。
</DL>

<DT><B>システムバックアップ</B>

<DD>
<DL COMPACT><DT><DD>
システムによっては、
定期的なバックアップをテープアーカイブに行っていることがある。
また RAID デバイスを用いて、
あるパーティションと同一のコピーを恒常的に保持しているシステムもあるだろう。
<B>mirrordir</B>

はさらに別の選択肢を提供する。
システムに 2 台のドライブを装備する。ひとつは普段用いるもの、
もう一つはバックアップするためのものである。
そして
<B>mirrordir</B>

を
<B><A HREF="../../cron/man8/cron.8.html">cron</A></B>(8)

のテーブルに追加するのだ。
変更されたファイルのバックアップには、様々なオプションが利用できる。
バックアップディレクトリはユーザから読み取り可能にしておき、
各人のバックアップファイルを閲覧できるようにしておくといいだろう。
特定のファイルの古いバージョンを取り戻したいユーザは、
バックアップから入手できるようになる。
<B>mirrordir</B>

は変更されたファイルの最小限だけを処理するので、非常に高速である。
一日に何回も実行したり、あるいは --nice オプションを付けて
途切れることなく実行させることさえ可能である。
<P>
マシンが壊れたときに対する備えをさらに強固にしたければ、
FTP を用いてリモートマシンにバックアップを行うこともできる。
</DL>

<DT><B>2 台のマシンを毎時バックアップする</B>

<DD>
<DL COMPACT><DT><DD>
<B>dar2</B>

というマシン上で、私は次のような cron ジョブを 6 時間ごとに実行している。
<P>

<PRE>
#!/bin/sh

# (this is just in case of any bugs I don't know about,
# but I don't think it is necessary)
killall -9 tee
killall mirrordir &gt;&amp; /dev/null
sleep 2
killall -9 mirrordir &gt;&amp; /dev/null

(                                                               \
date                                                        ;   \
echo &quot;mirrordir says (if it said nothing it is bad):&quot;       ;   \
    mirrordir mc://dar1:12346/ -p abcdefg /mnt/dar1/            \
    -i --exclude-regexp '^mc://dar1:12346/var/lock/subsys/atd'  \
    --exclude-regexp '^mc://dar1:12346/proc/'                   \
    --exclude-regexp '^mc://dar1:12346/mnt/[^/]*/.*$'           \
    -i --exclude-regexp '^mc://dar1:12346/boot/'                \
    -i --exclude-regexp '^mc://dar1:12346/etc/lilo.conf'        \
    -C                                                          \
'
if (S_ISDIR (stat.st_mode)) {
    if (!regexp (&quot;^mc://dar1:12346/[^/]*$&quot;, PATH))
        printf (&quot;Backing up: %s, PATH);
}
'                                                   ;           \
date                                                ;           \
echo &quot;Done&quot;                                         ;           \
) 2&gt;&amp;1                                                          \
| tee --ignore-interrupts --append /var/log/mirrordir.log       \
| mail -s 'dar1 backup results' <A HREF="mailto:psheer@obsidian.co.za">psheer@obsidian.co.za</A>
</PRE>

<P>

</DL>

<DT><B>安全な転送とログイン</B>

<DD>
<DL COMPACT><DT><DD>
<B>turing.co.uk</B>

において以下のコマンドを実行しておく
<BR>

<PRE>
    <B>secure-mcserv -p 12345 -d</B>
</PRE>

<BR>

どこか外部のマシンから
<BR>

<PRE>
    <B>copydir --secure -K 512 -z \ 
    mc://<A HREF="mailto:alan@turing.co.uk">alan@turing.co.uk</A>:12345/usr/src/linux/.config .</B>
</PRE>

<BR>

とすれば、512 ビットの鍵を用いた安全なファイルコピー (圧縮つき) ができる。
また
<BR>

<PRE>
    <B>pslogin mc://<A HREF="mailto:alan@turing.co.uk">alan@turing.co.uk</A>:12345/</B>
</PRE>

<BR>

とすれば、このマシンに安全にログインできる。
<BR>

</DL>

<DT><B>FTP サイトのミラー</B>

<DD>
<DL COMPACT><DT><DD>
ftp サイトでは ls の -R オプションが禁止されていることが多いので、
従来用いられてきた
<B>mirror (1)</B>

は失敗することがあった。
<B>mirrordir</B>

にはこの制限はない。
<P>

<PRE>
    <B>mirrordir -v <A HREF="ftp://metalab.unc.edu/pub">ftp://metalab.unc.edu/pub</A> /home/ftp/pub</B>
</PRE>

<P>

</DL>

<DT><B>FTP 転送</B>

<DD>
<DL COMPACT><DT><DD>
よくある FTP 転送は、--copy-mode オプションを用いた
一行のコマンドで簡単に実現できる。
複数のファイルをどちら向きにも、
また別々の ftp サイトにすら (間接的にではあるが)、
<B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1)

のようにコピーできる。
<BR>

<PRE>
    <B>copydir -v mirrordir-0.9.15.tar.gz \ 
    mirrordir.lsm <A HREF="ftp://metalab.unc.edu/incoming/Linux">ftp://metalab.unc.edu/incoming/Linux</A></B>
</PRE>

とすると
<B>mirrordir</B>

を sunsite にアップロードする。
<P>

anonymous でない ftp 転送のパスワードは、標準的な ftp の慣習に従って
<B>~/.netrc</B>

ファイルに置き、--netrc オプションを用いるのがよい。
あるいは
<B><A HREF="ftp://myname@machine/">ftp://myname@machine/</A></B>

を用いてもかまわない。
</DL>

<DT><B>ファイル探索</B>

<DD>
<B>recursdir / -C</B> 
<BR>

<B>'if (!glob (*.c, FILE)) printf (%s\\n, PATH);'</B>

<BR>

とするとシステムにあるすべての C ファイルを表示する。
<BR>

<B>recursdir / -C</B> 
<BR>

<B>'if (S_ISCHR(stat.st_mode)) printf (%s\\n, PATH);'</B>

<BR>

とすればシステムにあるすべてのキャラクタデバイスを表示する。
<DT><B>FTP サイトをテープにバックアップする</B>

<DD>
<DL COMPACT><DT><DD>
リモートサイトをテープにバックアップするには
<BR>

<PRE>
    <B>recursdir <A HREF="ftp://user@remote.machine/">ftp://user@remote.machine/</A> \ 
    --exclude-regexp '//[^/]*/proc/' --tar-file /dev/mt</B> 
</PRE>

とすればよい。
<BR>

</DL>

<DT><B>core ファイルの削除</B>

<DD>
<DL COMPACT><DT><DD>
これはシステムからすべての core ファイルを削除する:
<P>

<PRE>
recursdir / -C '
long l;
if (strncmp (PATH, &quot;/proc&quot;, 5)) {
    if (S_ISREG (stat.st_mode) &amp;&amp; !strcmp (&quot;core&quot;, FILE)) {
        if (strstr (popen (&quot;file &quot; + PATH), &quot;ELF 32-bit LSB core&quot;)) {
            l = l + stat.st_size;
            printf (&quot;removing: %s, cumu. total = %ldkB\n&quot;, PATH, l &gt;&gt; 10);
            exec (&quot;rm&quot;, &quot;-f&quot;, PATH);    /* could also use system() */
        }
    }
}
'
</PRE>

<P>

</DL>

</DL>
<A NAME="lbAI">&nbsp;</A>
<H2>環境変数</H2>

<DL COMPACT>
<DT><B>TMPDIR</B>

<DD>
一時的なファイルを保管させたいディレクトリ。
ftp ファイルシステムは、
まずファイルをこの一時ディレクトリにダウンロードし、
正しい場所にそのファイルをコピーする。後述の <B>バグ</B> を参照のこと。
<P>
TMPDIR が指定されないと、
デフォルトでは現在進行中のファイルがあるディレクトリに保存される。
</DL>
<A NAME="lbAJ">&nbsp;</A>
<H2>返り値</H2>

<B>mirrordir</B>

は以下の値を返す:
<DL COMPACT>
<DT><B>0</B>

<DD>
成功。
<DT><B>1</B>

<DD>
何らかのエラー (書き込みエラー、許可属性エラーなど) が起った。
この場合、エラーの詳細は stderr に書き込まれているはずである。
<DT><B>2</B>

<DD>
あるファイルが利用中でコピーできなかったが、それ以外は成功した。
この場合は `unable to open control file for writing'
というエラーが書き込まれているはずである。
標準エラーでこのメッセージを grep し、これらのファイルに対してのみ
もう一度 mirrordir を実行すればよい。
<B><A HREF="../../GNU_grep/man1/grep.1.html">grep</A></B>(1)

を参照のこと。
</DL>
<A NAME="lbAK">&nbsp;</A>
<H2>バグ</H2>

<B>atd</B>

デーモンのあるバージョンでは、
ロックファイル (や pid ファイル?) をそのファイルもロック付きで作成するため、
<B>secure-mcserv</B>

が永遠にブロックする。
これを防ぐには、
<B>atd</B>

を停止させるか、このファイルを対象から除外しなければならない。
<P>
サマータイムの時間補正があるところと ftp でミラーを行うと、
1 時間の時間のオフセットが生じるように見える。
とりあえずの回避策としては --time-offset を用いてほしい。
これが
<B>mirrordir</B>

のせいなのかどうかは私にはわからない。
<P>
<B>mirrordir</B>

のせいで CPU が食い尽くされ、停止してしまうように見えるバグは修正された。
<P>
コマンドラインから多数の --exclude 式を指定すると、
処理が遅くなる。たくさんのファイルのリストを除外対象したい人は、
そのリストをテキストファイルに書いて、
<B>--exclude-from</B>

オプションを利用する方がよい。
<P>
シンボリックリンク (それが指すファイルではない)
の修正時刻とアクセス時刻は複製されない。
<P>
以前にあった、ハードリンクファイルが通常ファイルとして扱われてしまうという
制限は解決された。--no-hard-links オプションを指定すれば、
0.9.8 以前の動作をエミュレート可能である。
<P>
ハードリンクがデバイスをまたいで作成されているかどうかはチェックしていない。
この場合はそれに見合ったエラーが報告されることになろう。
<P>
ftp ファイルシステムは、まずファイルを一時ディレクトリに
<B>*ftpfs*</B> という名前でダウンロードする。
これはスペースの無駄だが、vfs ライブラリのデフォルトの動作なのだ。
このディレクトリに十分な容量がないと、おそらく
<B>mirrordir</B>

はハングする。
上述の <B>環境変数</B> を参照のこと。
<P>
ファイル除外に用いる C スクリプト言語は、
実装のやりすぎである。
<A NAME="lbAL">&nbsp;</A>
<H2>ファイル</H2>

<DL COMPACT>
<DT><B>~/.netrc</B>

<DD>
マシンとそのパスワードのリスト。
オプション
<B>--netrc</B>

を参照のこと。
<DT><B>/etc/ssocket/accept.cs</B>

<DD>
このスクリプトは、接続のサーバ側で、鍵交換と署名生成を行う。
<DT><B>/etc/ssocket/connect.cs</B>

<DD>
このスクリプトは、接続のクライアント側で、鍵交換と署名生成を行う。
<DT><B>/etc/ssocket/arcinit.cs</B>

<DD>
ストリーム cipher 暗号化を初期化する
(国際版では存在しない)。
<DT><B>/etc/ssocket/arcencrypt.cs</B>

<DD>
ストリーム cipher 暗号化を行う
(国際版では存在しない)。
<DT><B>/etc/ssocket/private/</B>

<DD>
このディレクトリには、ホストの秘密鍵が置かれる。
鍵はそれぞれ別々のファイルに保存される。
ファイル名は 512, 1024 などである。
鍵のデータベースを使うようにすると、
鍵管理用のユーティリティが必要になるので、
こちらのほうがよい。
すぐに Reiser ファイルシステムが標準的になるだろうから、
データベースファイルはいずれにしても不要になるだろう。
<DT><B>/etc/ssocket/public/</B>

<DD>
こちらは公開鍵のもの。後は <B>/etc/ssocket/private/</B> と同様。
</DL>
<A NAME="lbAM">&nbsp;</A>
<H2>準拠</H2>

mirrordir は作成者の発明であり、
いかなる OS の標準にも従っていない (そうするべきではあるが!)
<A NAME="lbAN">&nbsp;</A>
<H2>入手方法</H2>

このプログラムの最新版は、
<B><A HREF="ftp://metalab.unc.edu/pub/Linux/system/backup">ftp://metalab.unc.edu/pub/Linux/system/backup</A></B> または
<B><A HREF="ftp://lava.obsidian.co.za/pub/linux/mirrordir">ftp://lava.obsidian.co.za/pub/linux/mirrordir</A></B>
から入手できる。
<A NAME="lbAO">&nbsp;</A>
<H2>著者</H2>

Paul Sheer  &lt;<A HREF="mailto:psheer@obsidian.co.za">psheer@obsidian.co.za</A>&gt;  &lt;<A HREF="mailto:psheer@icon.co.za">psheer@icon.co.za</A>&gt;

<A NAME="lbAP">&nbsp;</A>
<H2>関連項目</H2>

<B>mirror</B>(1), <B>pavuk</B>(1), <B><A HREF="../../0MultiFileIdx/man1/cp.1.html">cp</A></B>(1), <B>scp</B>(1),
<B><A HREF="../../GNU_findutils/man1/find.1.html">find</A></B>(1), <B>mc</B>(1), <B><A HREF="../../netkit/man1/ftp.1.html">ftp</A></B>(1), <B>ssh</B>(1),
<B><A HREF="../../GNU_tar/man1/tar.1.html">tar</A></B>(1), <B><A HREF="../../netkit/man1/rlogin.1.html">rlogin</A></B>(1), <B><A HREF="../../netkit/man8/rlogind.8.html">rlogind</A></B>(8), <B><A HREF="../man1/forward.1.html">forward</A></B>(1)
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">名前</A><DD>
<DT><A HREF="#lbAC">書式</A><DD>
<DT><A HREF="#lbAD">説明</A><DD>
<DT><A HREF="#lbAE">セキュリティと暗号化</A><DD>
<DT><A HREF="#lbAF">オプション</A><DD>
<DT><A HREF="#lbAG">FTP のサポート</A><DD>
<DT><A HREF="#lbAH">例</A><DD>
<DT><A HREF="#lbAI">環境変数</A><DD>
<DT><A HREF="#lbAJ">返り値</A><DD>
<DT><A HREF="#lbAK">バグ</A><DD>
<DT><A HREF="#lbAL">ファイル</A><DD>
<DT><A HREF="#lbAM">準拠</A><DD>
<DT><A HREF="#lbAN">入手方法</A><DD>
<DT><A HREF="#lbAO">著者</A><DD>
<DT><A HREF="#lbAP">関連項目</A><DD>
</DL>
<HR>
This document was created by
<A HREF="../../man/man1/man2html.1.html">man2html</A>,
using the manual pages.<BR>
Time: 03:33:39 GMT, December 05, 2022
</BODY>
</HTML>
