
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Man page of SUDOERS</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../jm.css">
</HEAD>
<BODY>

<H1>SUDOERS</H1>
Section: File Formats Manual (5)<BR>Updated: January 20, 2016<BR><A HREF="#index">Index</A>
<A HREF="../../../index.html">JM Home Page</A>
<A HREF="../../../manual/sudo/release/man5/sudoers.5">roff page</A><HR>




<A NAME="lbAB">&nbsp;</A>
<H2>名前</H2>

<B>sudoers</B> - sudo のデフォルトのセキュリティポリシー・プラグイン
<A NAME="lbAC">&nbsp;</A>
<H2>説明</H2>

<B>sudoers</B> ポリシー・プラグインは、ユーザにどんな <B>sudo</B> 権限があるかを決定する。
このプラグインが <B>sudo</B> のデフォルトのポリシー・プラグインである。
ポリシーの運用は <I>/etc/sudoers</I> ファイルによって行われるが、
LDAP を使用することも可能である。ポリシーを設定するときの書式は、
「SUDOERS ファイルの書式」セクションで詳しく説明している。
<B>sudoers</B> ポリシーの情報を LDAP に格納することについては、
<A HREF="../man5/sudoers.ldap.5.html">sudoers.ldap</A>(5) をご覧いただきたい。
<A NAME="lbAD">&nbsp;</A>
<H3>sudoers ポリシー・プラグインを使うための sudo.conf の設定</H3>

<B>sudo</B> は <A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルを参照して、
どのポリシー・プラグインと入出力ロギング・プラグインをロードするかを決める。
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルが存在しない場合や、存在しても Plugin 行を含まない場合は、
<B>sudoers</B> プラグインがポリシーの決定や 入出力ロギングに使用されることになる。
<B>sudoers</B> プラグインを使用するように明示的に設定するには、
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) に次のよう書き込めばよい。
<PRE>

<DL COMPACT><DT><DD>Plugin sudoers_policy sudoers.so
Plugin sudoers_io sudoers.so
</DL>
</PRE>

<P>

<B>sudo</B> 1.8.5 以来、<B>sudoers</B> プラグインに対する任意の引き数を
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) で指定することが可能になっている。
そうした引き数が存在する場合は、プラグインのパスの後ろに続けることになる
(すなわち、<I>sudoers.so</I> の後ろだ)。
引き数がいくつもあるときは、ホワイトスペースで区切って指定すればよい。
一例を挙げる。
<PRE>

<DL COMPACT><DT><DD>Plugin sudoers_policy sudoers.so sudoers_mode=0400
</DL>
</PRE>

<P>

以下のプラグインに対する引き数が使用できる。
<DL COMPACT>
<DT>ldap_conf=pathname<DD>
<I>ldap_conf</I> 引き数を使用すると、
<I>ldap_conf</I> ファイルのパスをデフォルトのものから変更することができる。
<DT>ldap_secret=pathname<DD>
<I>ldap_secret</I> 引き数を使用すると、
<I>ldap_secret</I> ファイルのパスをデフォルトのものから変更することができる。
<DT>sudoers_file=pathname<DD>
<I>sudoers_file</I> 引き数を使用すると、
<I>sudoers</I> ファイルのパスをデフォルトのものから変更することができる。
<DT>sudoers_uid=uid<DD>
<I>sudoers_uid</I> 引き数を使用すると、
sudoers ファイルの所有者をデフォルトのものから変更することができる。
指定には、ユーザ ID 番号を使うべきである。
<DT>sudoers_gid=gid<DD>
<I>sudoers_gid</I> 引き数を使用すると、
sudoers ファイルのグループをデフォルトのものから変更することができる。
指定には、グループ ID 番号を使用しなければならない (グループ名ではない)。
<DT>sudoers_mode=mode<DD>
<I>sudoers_mode</I> 引き数を使用すると、
sudoers ファイルのファイル・モードをデフォルトのものから変更することができる。
指定には、8 進数の値を使うべきである。
</DL>
<P>

<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) の設定についてさらに詳しいことをお知りになりたかったら、
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) のマニュアルをご覧になっていただきたい。
<A NAME="lbAE">&nbsp;</A>
<H3>ユーザの認証</H3>

<B>sudoers</B> セキュリティポリシーでは、ユーザはたいていの場合、
本人であることを証明してからでなければ。<B>sudo</B> を使用できない。ただし、
<B>sudo</B> の実行者が root だったり、変身対象ユーザが <B>sudo</B> の実行者と同一であったり、
ポリシーがその実行者やコマンドに対して認証を免除している場合は、パスワードが要求されることはない。
<A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1) とは違って、<B>sudoers</B> ポリシーが認証に当たってチェックするのは、
<B>sudo</B> を実行するユーザの認証情報 (訳注: 通常はパスワード) であって、
変身対象ユーザの (あるいは、root の) 認証情報ではない。この動作は、後述する
<I>rootpw</I>, <I>targetpw</I>, <I>runaspw</I> フラグによって変更することができる。
<P>

ポリシーに登録されていないユーザが <B>sudo</B> を使って、コマンドを実行しようとすると、
しかるべき権威者にメールが送付される。そうしたメールの宛先は、
後述する「デフォルト設定」の <I>mailto</I> 行によって設定できるが、
デフォルトでは root になっている。
<P>

<B>sudo</B> を使用する権限のないユーザが、<B>-l</B> や <B>-v</B> オプションを付けて
<B>sudo</B> の実行を試みても、認証に失敗し、しかも <I>mail_always</I> または
<I>mail_badpass</I> フラグが有効になっている場合を除いて、
メールは送付されないことに注意していただきたい。そうした動作にすることで、自分に
<B>sudo</B> の使用が許可されているかどうか、ユーザが自分で判断できるようにしているのである。
<B>sudo</B> 実行の試みは (成功、失敗にかかわらず)、すべてログに記録される。
メールが送られるかどうかには関係がない。
<P>

<B>sudo</B> が root によって実行されたとき、環境変数 SUDO_USER が設定されていると、
<B>sudoers</B> ポリシーは、実際のユーザが誰かを判断するのに、その値を使用することになる。
ユーザとしては、この動作を利用することで、すでにルートシェルを起動している場合でも、
自分が <B>sudo</B> を介して実行したコマンドのログを取ることができる。
また、この動作のおかげで、<B>sudo</B> で実行するスクリプトやプログラムから呼び出される場合でさえ、
<B>-e</B> オプションが役に立つものになっている。ただし、そうした場合でも、
<I>sudoers</I> ファイルの参照はやはり root に対してなされるのであって、
SUDO_USER が指定しているユーザに対してではないことに注意していただきたい。
<P>

<B>sudoers</B> は、認証情報の一時保存 (credential caching) にユーザごとのタイムスタンプ・ファイルを使用する。
ユーザの認証が済むと、記録が書き込まれるが、それには、認証に使用された uid、
端末セッション ID、タイムスタンプ (利用できるならば、単調増加時計 (monotonic clock)
を使用する) が含まれている。ユーザは、その後しばらくの間 (<I>timestamp_timeout</I>
オプションによって変更されていなければ、5 分間)、パスワードなしで <B>sudo</B> を使うことができる。
<B>sudoers</B> はデフォルトでは、各 tty ごとに別の記録を使用する。
そこで、認証は、ユーザのログイン・セッションごとに独立して行われることになる。
<I>tty_tickets</I> オプションを無効にすれば、あるユーザのすべてのセッションに対して、
単一のタイムスタンプの使用を強制することができる。
<A NAME="lbAF">&nbsp;</A>
<H3>ロギング</H3>

<B>sudoers</B> は <B>sudo</B> の実行が成功したときも失敗したときも、
その旨を (エラーの内容とともに) <A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) や独自のファイル、
あるいはその両方に記録することができる。<B>sudoers</B> はデフォルトでは、
<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でログを記録することになっているが、この動作はデフォルト設定の
<I>syslog</I> と <I>logfile</I> を使って変更することができる。
ログファイルの書式については、「ログの書式」セクションの説明をご覧いただきたい。
<P>

また <B>sudoers</B> は、擬似 tty でコマンドを実行して、
すべての入力や出力をログに記録することもできる。
標準入力、標準出力、標準エラーが端末と結びついていない場合でさえ、
それをログに記録することができるのだ。入出力ロギングは、デフォルトでは ON になっていないが、
<I>log_input</I> や <I>log_output</I> オプションを使って有効にすることができる。
コマンド・タグの LOG_INPUT や LOG_OUTPUT を使用して有効にすることも可能だ。
入出力ログファイルがどんなふうに格納されるかについては、
「入出力ログファイル」セクションに詳細な説明がある。
<A NAME="lbAG">&nbsp;</A>
<H3>コマンド環境</H3>

環境変数はプログラムの動作に影響を与えることがあるので、<B>sudoers</B> は、
実行されるコマンドがユーザの環境からどんな変数を引き継ぐかについて、
制御する手段を用意している。すなわち、<B>sudoers</B> は二つの異なった方法で、
環境変数を処理することができる。
<P>

デフォルトでは <I>env_reset</I> オプションが有効になっている。
この場合、コマンドは新しい、最小の環境で実行されることになる。
AIX (及び PAM を使用していない Linux システム) では、<I>/etc/environment</I>
ファイルの内容で環境が初期化される。新しい環境には、TERM, PATH,
HOME, MAIL, SHELL, LOGNAME, USER, USERNAME, 及び SUDO_* という変数、
それに、呼び出し側のプロセスから来た変数で、<I>env_check</I> や <I>env_keep</I>
オプションによって許可されたものが含まれている。これは、言わば、
環境変数のホワイトリストである。値が () で始まる環境変数は、
変数名と値の両方が <I>env_keep</I> や <I>env_check</I> の指定にマッチしないかぎり、
除去されるが、それは、<B>bash</B> シェルの古いバージョンでは関数と解釈されることになるからである。
1.8.11 より前のバージョンでは、そうした変数は無条件で除去されていた。
<P>

これに対して、<I>env_reset</I> オプションが無効になっている場合は、
<I>env_check</I> や <I>env_delete</I> オプションによって明示的に拒否されていないかぎり、
いかなる環境変数も呼び出し側のプロセスから継承される。
この場合、<I>env_check</I> や <I>env_delete</I> は、ブラックリストのように振る舞うわけだ。
値が () で始まる環境変数は、ブラックリストの一つにマッチしない場合でも、
必ず除去される。危険性のある環境変数のすべてをブラックリストに載せることは不可能なので、
<I>env_reset</I> を有効にしておくデフォルトの動作を採用することをお勧めする。
<P>

デフォルトでは、環境変数のマッチは変数名によって行われる。
しかしながら、マッチに使われるパターンに等号 ('=') が含まれる場合は、
変数名と値の両方がマッチしなければならない。たとえば、旧式の
(shellshock 問題以前の export 方法による)
<B>bash</B> のシェル関数にマッチさせるならば、次のように指定すればよいだろう。
<PRE>

<DL COMPACT><DT><DD>env_keep += &quot;my_func=()*&quot;
</DL>
</PRE>

<P>

旧式の <B>bash</B> のシェル関数は、デフォルトでは保存されないので、
&quot;=()*&quot; という後続部分がなかったら、こうした環境変数はマッチしないことになる。
<DL COMPACT>
<DT>[<B>訳注</B>]:<DD>
shellshock 以前の bash では、たとえば &quot;my_func='() { ls -F; }'&quot;
といったシェル変数を export することで、
my_func という関数をサブシェルに渡すことができた。
shellshock 以後の bash では、この方法による関数の継承はできなくなり、
値が &quot;() { ls -F; }&quot; である my_func という変数が、
渡されるだけになっている。だから、
sudoers ファイルの Defaults 行に上のように書いても、
shellshock 以後の bash を使っているかぎり、
my_func という環境変数が保存されるだけで、関数が渡されるわけではない。
</DL>
<P>

<B>sudo</B> が許可、または拒否する環境変数すべてのリストは、&quot;sudo -V&quot; を
root の資格で実行したときの出力中に含まれている。このリストは、
<B>sudo</B> が実行されるオペレーティングシステムによって異なることに気をつけていただきたい。
<P>

PAM をサポートしているシステムで、<B>pam_env</B> モジュールが
<B>sudo</B> に対して有効になっていると、
PAM の管理する環境にある変数が、環境にマージされることになるだろう。
ただし、PAM 環境にある変数がユーザの環境にすでに存在している場合に、
その値が上書きされることになるのは、
その変数が <B>sudoers</B> によって保存されていないときだけである。
すなわち、<I>env_reset</I> が有効になっているときは、
<I>env_keep</I> のリストによって <B>sudo</B> を実行するユーザの環境から保存された変数が、
PAM 環境にある変数より優先される。また、
<I>env_reset</I> が無効になっているときは、
<B>sudo</B> を実行するユーザの環境にある変数が、
<I>env_delete</I> のリストのパターンにマッチしていないかぎり、
PAM 環境にある変数よりも優先されるのである。
<P>

たいていのオペレーティングシステムのダイナミック・リンカは、
ダイナミック・リンキングを制御する働きがある環境変数を、
<B>sudo</B> もその一つである setuid 実行ファイルの環境から除去するようになっていることに注意していただきたい。
オペレーティングシステムによって名前は様々だが、_RLD*, DYLD_*, LD_*,
LDR_*, LIBPATH, SHLIB_PATH などが、この範疇に含まれるだろう。
そうした変数は、<B>sudo</B> の実行が始まるよりも前に、環境から除去されるので、
<B>sudo</B> がそうした変数を保存することは不可能である。
<P>

特例として、<B>sudo</B> に <B>-i</B> (initial login) オプションが指定されている場合は、
<B>sudoers</B> は <I>env_reset</I> の有効・無効にかかわらず、環境を初期化する。
環境変数 DISPLAY, PATH, TERM は変更されないが、HOME, MAIL, SHELL, USER, LOGNAME
は、変身対象ユーザのそれにセットされる。ATX (及び PAM を使用していない
Linux システム) では、<I>/etc/environment</I> の内容も取り込まれる。
それ以外の環境変数はすべて捨てられる。
<P>

最後に、<I>env_file</I> オプションが設定されている場合は、
そのファイルに記載されたいかなる変数も、
すでに存在している環境変数と衝突しないかぎり、
そこで指定されている値にセットされることになる。
<A NAME="lbAH">&nbsp;</A>
<H2>SUDOERS ファイルの書式</H2>

<I>sudoers</I> ファイルは二種類のエントリから構成されている。
(要するに変数である) エイリアスと (誰が何を実行できるかを指定している) ユーザ設定だ。
(訳注: 訳者としては、「エイリアス、デフォルト設定、ユーザ設定の三種類のエントリから構成されている」と言った方が、
現在の実態に合っているのではないかと思う。)
<P>

一人のユーザに複数のエントリがマッチするときは、順番に適用される。
複数の指定がマッチしている箇所については、最後にマッチしたものが使用される
(それが一番明示的なマッチだとはかぎらないが)。
<P>

以下では <I>sudoers</I> ファイルの文法を拡張 Backus-Naur 記法 (EBNF) を用いて記述する。
EBNF を御存じないからといって、あきらめないでいただきたい。
わりと簡単なものだし、以下に出てくる定義には詳しい説明をつけておきますから。
<A NAME="lbAI">&nbsp;</A>
<H3>EBNF の基礎の基礎</H3>

EBNF は言語の文法を記述する簡潔で厳密な方法である。
EBNF の個々の定義は生成規則からできている。たとえば、
<P>

シンボル ::= 定義 | 別の定義 1 | 別の定義 2 ...
<P>

個々の生成規則は、ほかの生成規則を参照し、そのようにして言語の文法を作り上げている。
また EBNF には以下の演算子が含まれるが、正規表現で御存じの読者も多いだろう。
だが、いわゆる「ワイルドカード」文字と混同しないでいただきたい。
あれは別の意味を持っている。
<DL COMPACT>
<DT>?<DD>
直前のシンボル (または、シンボルのグループ) が、あってもなくてもよいことを意味する。
すなわちそのシンボルは、1 回現れてもよいし、1 回も現れないでもよい。
<DT>*<DD>
直前のシンボル (または、シンボルのグループ) が 0 回以上現れる。
<DT>+<DD>
直前のシンボル (または、シンボルのグループ) が 1 回以上現れる。
</DL>
<P>

丸カッコを使うと、複数のシンボルをグループにまとめることができる。
なお、混乱を避けるため、以下の定義では、それが (シンボル名ではなく)
文字どおりの文字列や記号であることを示す場合には、シングルクォート
(' ') で囲むことにする。
<A NAME="lbAJ">&nbsp;</A>
<H3>エイリアス</H3>

エイリアスには四種類ある。User_Alias, Runas_Alias, Host_Alias,
Cmnd_Alias である。
<PRE>

<DL COMPACT><DT><DD>Alias ::= 'User_Alias'  User_Alias (':' User_Alias)* |
          'Runas_Alias' Runas_Alias (':' Runas_Alias)* |
          'Host_Alias'  Host_Alias (':' Host_Alias)* |
          'Cmnd_Alias'  Cmnd_Alias (':' Cmnd_Alias)*

User_Alias ::= NAME '=' User_List

Runas_Alias ::= NAME '=' Runas_List

Host_Alias ::= NAME '=' Host_List

Cmnd_Alias ::= NAME '=' Cmnd_List

NAME ::= [A-Z]([A-Z][0-9]_)*
</DL>
</PRE>

<P>

個々のエイリアスの定義は、次の形をとる。
<PRE>

<DL COMPACT><DT><DD>Alias_Type NAME = item1, item2, ...
</DL>
</PRE>

<P>

上記において <I>Alias_Type</I> は、User_Alias, Runas_Alias, Host_Alias,
Cmnd_Alias のうちの一つである。NAME は、アルファベットの大文字、数字、
アンダースコア ('_') からなる文字列であるが、
先頭の文字はアルファベットの大文字でなければならない。
同じタイプのエイリアス定義を、コロンで (':') つないで、一行に複数書くこともできる。
たとえば、
<PRE>

<DL COMPACT><DT><DD>Alias_Type NAME = item1, item2, item3 : NAME = item4, item5
</DL>
</PRE>

<P>

既存のエイリアスを再定義するのは、文法エラーである。
異なるタイプのエイリアスに対して同じ名前を使用することはできるが、
お薦めできることではない。
<P>

エイリアスの有効な要素となるものの定義は、以下のようになる。
<PRE>

<DL COMPACT><DT><DD>User_List ::= User |
              User ',' User_List

User ::= '!'* user name |
         '!'* #uid |
         '!'* %group |
         '!'* %#gid |
         '!'* +netgroup |
         '!'* %:nonunix_group |
         '!'* %:#nonunix_gid |
         '!'* User_Alias
</DL>
</PRE>

<P>

User_List を構成するのは、一個以上の次のものである。
ユーザ名、ユーザID (接頭辞 '#' が付く)、
システムグループ名やその ID (それぞれ、接頭辞 '%' と '%#' が付く)、
ネットグループ名 (接頭辞 '+' が付く)、
non-Unix グループ名やその ID (それぞれ、接頭辞 '%:' と '%:#' が付く)、
それに User_Alias。
リストの各項目の前には一個以上の '!' 演算子を付けてもよい。
奇数個の '!' はその項目の値を否定する。偶数個の場合は互い相殺されるだけだ。
なお、ユーザのネットグループについては、
ネットグループの成員中のユーザとドメインの要素のみを使って、マッチングが行われる。
ホストの要素はマッチングに使用されない。
<P>

ユーザ名、uid、グループ名、gid、ネットグループ名、non-Unix グループ名、
non-Unix グループ の gid は、ダブルクォートで囲めば、特殊文字をエスープしないですむ。
ダブルクォートで囲まずに特殊文字を使いたいなら、エスケープした 16 進数を指定してやればよい。
たとえば、スペースなら \x20 という具合だ。
ダブルクォートを使用する場合は、接頭辞があれば、それをダブルクォートの内側に入れなければならない。
<P>

non-Unix グループやその gid を指定するときのの書式が、
実際にどんなものになるかは、
利用するグループ・プロバイダー・プラグイン (group provider plugin) 次第である。
たとえば、QAS (Quest Authentication Services) の AD プラグインは、
以下の書式をサポートしている。
<DL COMPACT>
<DT><B>&bull;</B><DD>
同じドメインのグループ:　&quot;%:Group Name&quot;
<DT><B>&bull;</B><DD>
任意のドメインのグループ: &quot;%:Group <A HREF="mailto:Name@FULLY.QUALIFIED.DOMAIN">Name@FULLY.QUALIFIED.DOMAIN</A>&quot;
<DT><B>&bull;</B><DD>
グループ SID: &quot;%:S-1-2-34-5678901234-5678901234-5678901234-567&quot;
</DL>
<P>

詳細については、
「グループ・プロバイダー・プラグイン」セクションをご覧いただきたい。
<P>

グループ名を囲む引用符は任意であることに注意していただきたい。
文字列を引用符で囲まない場合は、バックスラッシュ ('\') を使って、
スペースや特殊文字をエスケープしなければならない。
エスケープする必要がある文字のリストについては、
「ほかの特殊文字と予約語」のセクションを参照していただきたい。
<PRE>

<DL COMPACT><DT><DD>Runas_List ::= Runas_Member |
               Runas_Member ',' Runas_List

Runas_Member ::= '!'* user name |
                 '!'* #uid |
                 '!'* %group |
                 '!'* %#gid |
                 '!'* %:nonunix_group |
                 '!'* %:#nonunix_gid |
                 '!'* +netgroup |
                 '!'* Runas_Alias
</DL>
</PRE>

<P>

Runas_List は User_List に似ている。違うのは、User_Alias ではなく、
Runas_Alias が使えることだ。ユーザ名やグループ名のマッチは、
文字列として行われることに気を付けていただきたい。
言い換えると、二つのユーザ名 (あるいは、グループ名) は、
仮に同じ uid (gid) を持っていても、別個のものと見なされるのである。
だから、もし同じ uid を持ったすべてのユーザ名にマッチさせたかったら
(たとえば、root と toor がそうだとしよう)、ユーザ名の代わりに uid を使えばよい
(この例なら、#0 である)。
<PRE>

<DL COMPACT><DT><DD>Host_List ::= Host |
              Host ',' Host_List

Host ::= '!'* host name |
         '!'* ip_addr |
         '!'* network(/netmask)? |
         '!'* +netgroup |
         '!'* Host_Alias
</DL>
</PRE>

<P>

Host_List を構成するのは、一個以上の次のものである。
ホスト名、IP アドレス、ネットワークアドレス、
ネットグループ名 (接頭辞 '+' が付く)、および他のエイリアス。
ここでもまた、項目の値は、'!' 演算子によって否定することができる。なお、
ホストのネットグループについては、ネットグループの成員中のホスト
(完全修飾名とそうでないもののどちらでも) とドメインの要素のみを使って、
マッチングが行われる。ユーザの要素はマッチングに使用されない。
ネットワークアドレスをネットマスクなしで指定した場合は、
<B>sudo</B> はローカルホストのネットワークインターフェースを一つ一つ参照し、
指定されたネットワークアドレスと同じアドレスを持つインターフェースがあれば、
そのネットマスクを使用することになる。ネットマスクの指定は、
標準の IP アドレス表記 (たとえば 255.255.255.0 や ffff:ffff:ffff:ffff::) でもよく、
CIDR 表記 (ビット数、たとえば 24 や 64) でもよい。
ホスト名の一部にシェル風のワイルドカードを使用することができるが
(下記の「ワイルドカード」セクションを参照)、
ご使用のマシンの hostname コマンドが完全修飾ドメイン名 (FQDN) を返さない場合、
ワイルドカードを利用するには <I>fqdn</I> オプションを使う必要がある。
なお、<B>sudo</B> がチェックするのは、
実在のネットワークインターフェースだけだということに留意してほしい。
すなわち、IP アドレス 127.0.0.1 (localhost) がマッチすることは、絶対にないのである。
また、&quot;localhost&quot; というホスト名がマッチするのは、
それが実際のホスト名であるときだけであり、
それは通常、ネットワークにつながっていないシステムの場合にしか当てはまらない。
<PRE>

<DL COMPACT><DT><DD>digest ::= [A-Fa-f0-9]+ |
           [[A-Za-z0-9+/=]+

Digest_Spec ::= &quot;sha224&quot; ':' digest |
                &quot;sha256&quot; ':' digest |
                &quot;sha384&quot; ':' digest |
                &quot;sha512&quot; ':' digest

Cmnd_List ::= Cmnd |
              Cmnd ',' Cmnd_List

command name ::= file name |
                 file name args |
                 file name '&quot;&quot;'

Cmnd ::= Digest_Spec? '!'* command name |
         '!'* directory |
         '!'* &quot;sudoedit&quot; |
         '!'* Cmnd_Alias
</DL>
</PRE>

<P>

Cmnd_List は一個以上の、コマンド名、ディレクトリ、
他のエイリアスからなるリストである。コマンド名は絶対パスのファイル名であり、
シェル風のワイルドカードを含んでいても構わない(下記の「ワイルドカード」セクションを参照)。
単にファイル名だけ指定した場合、
ユーザはお望みのどんな引き数でも付けてそのコマンドを実行することができる。
とは言え、コマンドライン引き数を (ワイルドカードを含めて)
指定しても構わないし、また、引き数に &quot;&quot; を指定して、そのコマンドは、
コマンドライン引き数を付けずに実行することしかできないと指示することもできる。
ディレクトリは '/' で終わる絶対パス名である。
Cmnd_List にディレクトリを指定すると、
ユーザーはそのディレクトリ内の任意のファイルを実行できるようになる
(だが、そのサブディレクトリにあるファイルは実行できない)。
<P>

Cmnd がコマンドライン引き数を伴っている場合は、 Cmnd 中の引き数は、
ユーザがコマンドラインで打ち込む引き数と正確に一致しなければならない
(Cmnd 中の引き数にワイルドカードがあるならば、
それがコマンドラインの引き数とマッチしなければならない)。
以下に挙げる文字をコマンド引き数の中で用いるときは、
'\' によってエスケープしなければならないことに注意していただきたい。
',', ':', '=', '\' がそれである。
Cmnd に &quot;sudoedit&quot; という <B>sudo</B> の組み込みコマンドを指定すると、
ユーザに <B>sudo</B> を <B>-e</B> オプション付きで
(あるいは、<B>sudoedit</B> というコマンド名で) 実行することを許可することになる。
この場合、コマンドライン引き数も指定することができるのは、
普通のコマンドとまったく同様だ。
&quot;sudoedit&quot; は、<B>sudo</B> そのものに組み込まれたコマンドなので、<I>sudoers</I>
ファイルではパスを前に付けずに指定しなければならないことに注意していただきたい。
<P>

コマンド名の前に Digest_Spec が付いている場合、コマンドのマッチに成功するのは、
指定された SHA-2 ダイジェストを使って照合できたときだけである。
ダイジェストのフォーマットとしては、
sha224, sha256, sha384, sha512 をサポートしている。
文字列は、16 進数形式でも base64 形式でも指定できる (base64 の方が短くて済む)。
SHA-2 ダイジェストを 16 進数形式で生成できるユーティリティはいくつかある。
openssl, shasum, sha224sum, sha256sum, sha384sum, sha512sum
といったものがそうだ。
<P>

たとえば、openssl を使うなら、
<PRE>

<DL COMPACT><DT><DD>$ openssl dgst -sha224 /bin/ls
SHA224(/bin/ls)= 118187da8364d490b4a7debbf483004e8f3e053ec954309de2c41a25
</DL>
</PRE>

<P>

openssl を使って、base64 の出力を生成することもできる。
<PRE>

<DL COMPACT><DT><DD>$ openssl dgst -binary -sha224 /bin/ls | openssl base64
EYGH2oNk1JC0p9679IMATo8+BT7JVDCd4sQaJQ==
</DL>
</PRE>

<P>

注意: もしユーザがコマンドそのものに対して (直接であれ、<B>sudo</B> コマンドを通してであれ)
書き込み権限を持っているならば、そのユーザは、ダイジェストチェックが済み、
コマンドが実行されるまでの間に、コマンドを別のものに置き換えることができるかもしれない。
同様の競合状態が、fexecve(2) システムコールを持っていないシステムでは、
コマンドが存在するディレクトリがユーザによって書き込み可能であるときに起こりえる。
<P>

コマンド・ダイジェストをサポートしているのは、バージョン 1.8.7 以上だけである。
<A NAME="lbAK">&nbsp;</A>
<H3>デフォルト設定 (Defaults)</H3>

かなりの設定オプションが、
一行以上の Default_Entry 行を指定することで実行時にデフォルトの値から変更可能だ。
その効果の及ぶ範囲は、あらゆるホストのすべてのユーザにすることもできるし、
ある特定のホストのすべてのユーザ、ある特定のユーザ、ある特定のコマンド、
ある特定のユーザとして実行するコマンドなどに限定することもできる。
気を付けてほしいのは、コマンドに限定した Defaults 行にコマンドライン引き数まで書くことができないことだ。
引き数を指定する必要がある場合は、Cmnd_Alias を定義して、代わりにそれを参照すればよい。
<PRE>

<DL COMPACT><DT><DD>Default_Type ::= 'Defaults' |
                 'Defaults' '@' Host_List |
                 'Defaults' ':' User_List |
                 'Defaults' '!' Cmnd_List |
                 'Defaults' '&gt;' Runas_List

Default_Entry ::= Default_Type Parameter_List

Parameter_List ::= Parameter |
                   Parameter ',' Parameter_List

Parameter ::= Parameter '=' Value |
              Parameter '+=' Value |
              Parameter '-=' Value |
              '!'* Parameter
</DL>
</PRE>

<P>

パラメータは<B>フラグ</B>、<B>整数値</B>、<B>文字列</B>、<B>リスト</B>のどれであってもよい。
フラグは要するにブーリアン (真偽値) であり、'!' 演算子で off にできる。
整数値、文字列、リストのパラメータにも、真偽値として使用して、
それを無効にできるものがいくつか存在する。
パラメータの値が複数の単語を含むときは、
値をダブルクオート (&quot;&quot;) で囲むとよい。
特殊文字はバックスラッシュ ('\') でエスケープすることができる。
<P>

リストには代入演算子が = のほかにもう二つある。+= と -= である。
こうした演算子は、それぞれ、リストに付け加えたり、リストから削除したりするのに使用する。
-= 演算子を使って、リストに存在しない要素を消去しようとしても、エラーにはならない。
<P>

Defaults 行の解析は、次の順序で行われる。まず、汎用、Host、User の Defaults
が解析され、それから Runas の Defaults、最後にコマンドの Defaults の順番になる。
<P>

Defaults 行で使用できるパラメータのリストについては、
「SUDOERS のオプション」を御覧いただきたい。
<A NAME="lbAL">&nbsp;</A>
<H3>ユーザ設定 (User Specification)</H3>

<PRE>
<DL COMPACT><DT><DD>User_Spec ::= User_List Host_List '=' Cmnd_Spec_List \
              (':' Host_List '=' Cmnd_Spec_List)*

Cmnd_Spec_List ::= Cmnd_Spec |
                   Cmnd_Spec ',' Cmnd_Spec_List

Cmnd_Spec ::= Runas_Spec? SELinux_Spec? Tag_Spec* Cmnd

Runas_Spec ::= '(' Runas_List? (':' Runas_List)? ')'

SELinux_Spec ::= ('ROLE=role' | 'TYPE=type')

Tag_Spec ::= ('EXEC:' | 'NOEXEC:' | 'FOLLOW:' | 'NOFOLLOW' |
              'LOG_INPUT:' | 'NOLOG_INPUT:' | 'LOG_OUTPUT:' |
              'NOLOG_OUTPUT:' | 'MAIL:' | 'NOMAIL:' | 'PASSWD:' |
              'NOPASSWD:' | 'SETENV:' | 'NOSETENV:')
</DL>
</PRE>

<P>

<B>ユーザ設定</B>は、あるユーザが、指定されたホストで (どのユーザに変身して)
どのコマンドを実行できるかを決定する。デフォルトでは、コマンドは <B>root</B>
に変身して実行されるが、これはコマンドごとに変更することができる。
<P>

ユーザ設定の基本構造は、&quot;who where = (as_whom) what&quot; である
(&quot;誰が どのホストで = (誰に変身して) 何を&quot;)。構成部分に分けて説明しよう。
<A NAME="lbAM">&nbsp;</A>
<H3>Runas_Spec</H3>

Runas_Spec は変身の対象となるユーザやグループを規定している。
完全な形の Runas_Spec は、(上で定義しているように) コロン (':') で区切られ、
カッコで囲まれた、二つの Runas_List からなっている。一つ目の Runas_List は、
<B>sudo</B> で <B>-u</B> オプションを使ったときに変身できるユーザを指している。
二番目の方が規定しているのは、<B>sudo</B> の <B>-g</B> オプションによって指定できるグループのリストだ。
両方の Runas_List が指定されている場合は、それぞれの Runas_List
にリストされているユーザとグループの任意の組み合わせで、
コマンドを実行することができる。一つ目の Runas_List だけが指定されている場合は、
リスト中のいかなるユーザにでも変身してコマンドを実行できるが、
<B>-g</B> オプションを指定することはできない。一つ目の Runas_List が空で、
二番目だけ指定されている場合は、<B>sudo</B> を実行するユーザの資格で、
グループを Runas_List にリストされている任意のグループに設定して、
コマンドを実行することができる。Runas_Lists が両方とも空の場合は、
<B>sudo</B> を実行するユーザの資格でしかコマンドを実行できない。
Runas_Spec がまったく指定されていない場合は、<B>root</B> としてコマンドを実行できるが、
グループを指定することはできない。
<P>

Runas_Spec は、それに続くコマンドに対してデフォルトを定める。
それはどういうことかと言うと、次のようなエントリがあったとしよう。
<PRE>

<DL COMPACT><DT><DD>dgb     boulder = (operator) /bin/ls, /bin/kill, /usr/bin/lprm
</DL>
</PRE>

<P>

ユーザ <B>dgb</B> は <I>/bin/ls</I>, <I>/bin/kill</I>, <I>/usr/bin/lprm</I> を実行することができる。
ただし、<B>operator</B> として実行できるだけだ。たとえば、次のようにである。
<PRE>

<DL COMPACT><DT><DD>$ sudo -u operator /bin/ls
</DL>
</PRE>

<P>

エントリの後ろの方の Runas_Spec を変更することも可能だ。
上のエントリをこんなふうに書き変えたとしよう。
<PRE>

<DL COMPACT><DT><DD>dgb     boulder = (operator) /bin/ls, (root) /bin/kill, /usr/bin/lprm
</DL>
</PRE>

<P>

すると、ユーザ <B>dgb</B> は、<I>/bin/ls</I> こそ <B>operator</B> としてだが、
<I>/bin/kill</I> や <I>/usr/bin/lprm</I> は <B>root</B> の資格で実行できるようになる。
<P>

<B>dgb</B> が /bin/ls を実行するとき、変身対象ユーザとグループのどちらでも
<B>operator</B> になれるように、この記述を拡張することもできる。
<PRE>

<DL COMPACT><DT><DD>dgb     boulder = (operator : operator) /bin/ls, (root) /bin/kill,\
        /usr/bin/lprm
</DL>
</PRE>

<P>

注意してほしいが、Runas_Spec のグループの部分は、
コマンドをそのグループとして実行することをユーザに許可しているのであって、
そうすることをユーザに強制しているのではない。
コマンドラインでグループを指定しない場合は、コマンドは、
パスワード・データベースにある変身対象ユーザのエントリに登録されているグループとして実行されることになるのだ。
以下のコマンドはすべて、上記の sudoers エントリによって許可されることになるだろう。
<PRE>

<DL COMPACT><DT><DD>$ sudo -u operator /bin/ls
$ sudo -u operator -g operator /bin/ls
$ sudo -g operator /bin/ls
</DL>
</PRE>

<P>

次の例では、ユーザ <B>tcm</B> がモデムのデバイスファイルにアクセスするコマンドを
dialer グループとして実行できるようにしている。
<PRE>

<DL COMPACT><DT><DD>tcm     boulder = (:dialer) /usr/bin/tip, /usr/bin/cu,\
        /usr/local/bin/minicom
</DL>
</PRE>

<P>

この例では、グループしか指定できないことに注意してほしい。コマンドは、
ユーザ <B>tcm</B> の資格のまま実行されるのである。たとえば、次のように。
<PRE>

<DL COMPACT><DT><DD>$ sudo -g dialer /usr/bin/cu
</DL>
</PRE>

<P>

Runas_Spec には複数のユーザやグループが存在してもよい。
その場合、ユーザは <B>-u</B> や <B>-g</B> オプションを使って、
ユーザとグループのどんな組み合わせでも選択することができる。
<PRE>

<DL COMPACT><DT><DD>alan    ALL = (root, bin : operator, system) ALL
</DL>
</PRE>

<P>

この例では、ユーザ <B>alan</B> は root と bin のどちらのユーザにでも変身して、
任意のコマンドを実行することができる。また、グループを
operator や system に設定することも自由である。
<A NAME="lbAN">&nbsp;</A>
<H3>SELinux_Spec</H3>

SELinux をサポートするシステムでは、<I>sudoers</I> ファイルのエントリで
SELinux の role や type をコマンドに関連付けることも可能である。
role や type を特定のコマンドについて指定すると、
<I>sudoers</I> 中でデフォルトとして設定されている role や type があっても、
それよりも優先される。もっとも、role や type をコマンドラインで指定すれば、
そちらが <I>sudoers</I> 中の値よりさらに優先されることになる。
<A NAME="lbAO">&nbsp;</A>
<H3>Tag_Spec</H3>

コマンドは 0 個以上のタグを伴うことができる。使用できるタグの値は 14 個あり、
EXEC, NOEXEC, FOLLOW, NOFOLLOW, LOG_INPUT, NOLOG_INPUT, LOG_OUTPUT,
NOLOG_OUTPUT, MAIL, NOMAIL, PASSWD, NOPASSWD, SETENV, NOSETENV が、それである。
ある Cmnd にタグをセットすると、
Cmnd_Spec_List 中のそれ以後の Cmnd は、
反対の意味を持つタグによって変更されないかぎり、そのタグを継承することになる
(すなわち、PASSWD は NOPASSWD を無効にし、NOEXEC は EXEC を無効にする)。
<DL COMPACT>
<DT><I>EXEC</I> と <I>NOEXEC</I><DD>
<P>
<B>sudo</B> が <I>noexec</I> サポートつきでコンパイルされ、
使用しているオペレーティングシステムがそれに対応している場合、NOEXEC タグを利用すれば、
動的にリンクされた実行ファイルが、そこからさらにコマンドを実行するのを防ぐことができる。
<P>
次の例では、ユーザ <B>aaron</B> は <I>/usr/bin/more</I> と
<I>/usr/bin/vi</I> を実行できるが、シェル・エスケープは利用できない。
<PRE>

<DL COMPACT><DT><DD>aaron   shanty = NOEXEC: /usr/bin/more, /usr/bin/vi
</DL>
</PRE>

<DL COMPACT><DT><DD>
<P>
NOEXEC がどんなふうに働くのか、お使いのシステムで利用できるかどうか、
などについてさらに詳しく知りたかったら、
後述の「シェル・エスケープの防止」セクションを御覧になるとよい。
</DL>

<DT><I>FOLLOW</I> と <I>NOFOLLOW</I><DD>
バージョン 1.8.15 以来、<B>sudoedit</B> は、
<I>sudoedit_follow</I> オプションが有効になっていないかぎり、
ファイルがシンボリックリンクならば、それを開かないようになっている。
<I>FOLLOW</I> と <I>NOFOLLOW</I> タグは、<I>sudoedit_follow</I> の値を上書きするので、
これを使用すれば、シンボリックリンクの編集をコマンドごとに許可したり、
禁止したりすることができる。
この二つのタグが効果があるのは、<I>sudoedit</I> コマンドに対してのみであり、
他のどんなコマンドに対しても無視される。
<DT><I>LOG_INPUT</I> と <I>NOLOG_INPUT</I><DD>
<P>
この二つのタグは <I>log_input</I> オプションの値をコマンドごとに変更する。
詳しい情報については、後述する「SUDOERS のオプション」セクションの
<I>log_input</I> の説明をご覧になっていただきたい。
<DT><I>LOG_OUTPUT</I> と <I>NOLOG_OUTPUT</I><DD>
<P>
この二つのタグは <I>log_output</I> オプションの値をコマンドごとに変更する。
詳しい情報については、後述する「SUDOERS のオプション」セクションの
<I>log_output</I> の説明をご覧になっていただきたい。
<DT><I>MAIL</I> と <I>NOMAIL</I><DD>
<P>
この二つのタグを使えば、
<I>mail_all_cmnds</I> オプションの値をコマンドごとに上書きすることによって、
ユーザがコマンドを実行したときにメールを送付するかどうかについて、
きめ細かな制御を行うことができる。
<B>sudo</B> が <B>-l</B> や <B>-v</B> オプションを付けて実行されたときには、効果がない。
<I>NOMAIL</I> は、<I>mail_always</I> や <I>mail_no_perms</I> オプションも上書きする。
詳細については、後述の「SUDOERS のオプション」セクションにある
<I>mail_all_cmnds</I>, <I>mail_always</I>, <I>mail_no_perms</I> の説明をご覧いただきたい。
<DT><I>PASSWD</I> と <I>NOPASSWD</I><DD>
<P>
デフォルトでは、<B>sudo</B> はコマンドを実行する前に、ユーザが本人であることを証明するように求める。
この振舞いは NOPASSWD タグによって変更することができる。Runas_Spec と同様、
NOPASSWD タグも Cmnd_Spec_List 中のそれに続くコマンドに対してデフォルトを定める。
PASSWD の働きは反対であり、振舞いを元に戻したいときに使える。たとえば、
<PRE>

<DL COMPACT><DT><DD>ray     rushmore = NOPASSWD: /bin/kill, /bin/ls, /usr/bin/lprm
</DL>
</PRE>

<DL COMPACT><DT><DD>
<P>
とすれば、ユーザ <B>ray</B> はマシン rushmore 上で認証をしないでも
<B>root</B> として <I>/bin/kill</I>, <I>/bin/ls</I>, <I>/usr/bin/lprm</I>
を実行できるようになる。もし <B>ray</B> がパスワードなしで実行できるコマンドを
<I>/bin/kill</I> だけに絞りたいのなら、エントリはこうなるだろう。
<PRE>

<DL COMPACT><DT><DD>ray     rushmore = NOPASSWD: /bin/kill, PASSWD: /bin/ls, /usr/bin/lprm
</DL>
</PRE>

<P>
ただし、ユーザが <I>exempt_group</I> オプションで指定されているグループに属する場合は、
PASSWD タグが効果を持たないことに注意してほしい。
<P>
デフォルトでは、現在使用中のホストに関するユーザのエントリのうちに
NOPASSWD タグが指定されているものが一つでもあれば、
そのユーザはパスワードなしで &quot;sudo -l&quot; を実行できる。
なお、ユーザがパスワードなしで &quot;sudo -v&quot; を実行できるのは、
現在使用中のホストに関するそのユーザのエントリのすべてで
NOPASSWD タグが生きているときのみである。この動作は、<I>verifypw</I> や <I>listpw</I>
オプションによって変更できる。
</DL>

<DT><I>SETENV</I> と <I>NOSETENV</I><DD>
<P>
上記のタグは <I>setenv</I> オプションの値をコマンドごとに変更する。
あるコマンドに対して SETENV を設定すると、
ユーザがコマンドラインから <B>-E</B> オプションを使用して、
<I>env_reset</I> オプションを無効にできるようになることに注意してほしい。
それだけではない。コマンドラインから設定する環境変数が <I>env_check</I>,
<I>env_delete</I>, <I>env_keep</I> による規制を受けないようにもなる。
それ故、こうした形で環境変数を設定することを許可するのは、
信用できるユーザだけに限るべきである。なお、マッチするコマンドが
<B>ALL</B> だった場合は、暗黙のうちに SETENVタグがそのコマンドに付けられるが、
このデフォルトの動作は UNSETENV タグを使えば打ち消すことができる。
</DL>
<A NAME="lbAP">&nbsp;</A>
<H3>ワイルドカード</H3>

<I>sudoers</I> ファイルでは、ホスト名、コマンドのパス名、
コマンドライン引き数にシェル形式のワイルドカード (メタ文字とか
glob キャラクタとも言う) が使用できる。ワイルドカードのマッチングは、
IEEE Std 1003.1 (&quot;POSIX.1&quot;) で規定されている <A HREF="../../LDP_man-pages/man3/glob.3.html">glob</A>(3) や <A HREF="../../LDP_man-pages/man3/fnmatch.3.html">fnmatch</A>(3)
関数を用いて行われる。
<DL COMPACT>
<DT>*<DD>
0 個以上の任意の文字 (ホワイトスペースも含む) にマッチする。
<DT>?<DD>
任意の 1 文字 (ホワイトスペースも含む) にマッチする。
<DT>[...]<DD>
指定された範囲の任意の 1 文字にマッチする。
<DT>[!...]<DD>
指定された範囲<I>以外</I>の任意の 1 文字にマッチする。
<DT>\x<DD>
'x' がどんな文字であっても、'x' そのものとして評価する。
この表記法は '*', '?', '[', ']'
といった特殊文字をエスケープするために使用される。
</DL>
<P>

<B>上記のものは正規表現ではないことに注意していただきたい。</B>
正規表現とは違って、範囲内の文字一つ以上にマッチさせる方法は存在しない。
<P>

使用しているシステムの <A HREF="../../LDP_man-pages/man3/glob.3.html">glob</A>(3) や <A HREF="../../LDP_man-pages/man3/fnmatch.3.html">fnmatch</A>(3) 関数が文字クラスに対応しているなら、
文字クラスが使用できる。ただし、':' 文字は、
<I>sudoers</I> で特別な意味を持っているので、エスケープしなければならない。
一例を上げる。
<PRE>

<DL COMPACT><DT><DD>/bin/ls [[\:alpha\:]]*
</DL>
</PRE>

<P>

<I>sudoers</I> 中で上のように書けば、アルファベットの文字で始まるどんなファイル名にもマッチするだろう。
<P>

コマンドのファイル名の部分で使われたワイルドカードはフォワードスラッシュ
('/') に<I>マッチしない</I>ことに注意していただきたい。そこで、次のようなパスは、
<PRE>

<DL COMPACT><DT><DD>/usr/bin/*
</DL>
</PRE>

<P>

<I>/usr/bin/who</I> にマッチするが、<I>/usr/bin/X11/xterm</I> にはマッチしない。
<P>

だが、コマンドライン引き数の部分のマッチングでは、
ワイルドカードはスラッシュに<I>しっかりマッチする</I>。
コマンドライン引き数には、任意の文字列を含むことが認められており、
パス名しか許されていないわけではないからだ。
<P>

<I>sudoers</I> <B>中でコマンドライン引き数にワイルドカードを使用するときは、</B>
<B>注意しなければならない。</B>
<BR>

コマンドライン引き数は、結合して一つの文字列にした上で、マッチングを行う。
そのため、'?' や '*' といったワイルドカード文字が、
ユーザが指定したコマンドライン引き数と、
単語の境界をまたいでマッチしてしまうことになるのだ。
これは想定外のことかもしれない。たとえば、<I>sudoers</I> に次のような行があると、
<PRE>

<DL COMPACT><DT><DD>%operator ALL = /bin/cat /var/log/messages*
</DL>
</PRE>

<P>

以下のコマンドが実行できることになるが、
<PRE>

<DL COMPACT><DT><DD>$ sudo cat /var/log/messages.1
</DL>
</PRE>

<P>

また、以下のコマンドの実行も可能になってしまう。
<PRE>

<DL COMPACT><DT><DD>$ sudo cat /var/log/messages /etc/shadow
</DL>
</PRE>

<P>

後者は、おそらく意図に反しているだろう。たいていの場合、
コマンドラインの処理は、<I>sudoers</I> ファイルの中ではなく、
スクリプト言語中で行った方が間違いがない。
<A NAME="lbAQ">&nbsp;</A>
<H3>ワイルドカード・ルールの例外</H3>

上記ルールには以下の例外がある。
<DL COMPACT>
<DT>&quot;&quot;<DD>
<I>sudoers</I> ファイルのエントリにおいて、空文字列 &quot;&quot;
が唯一のコマンドライン引き数だった場合は、
そのコマンドは引き数を<I>付けずに</I>実行しなければならないことを意味している。
<DT>sudoedit<DD>
組み込みコマンド <I>sudoedit</I> にコマンドラインで渡す引き数は、
常にパス名であるはずだ。そこで、ワイルドカードはフォワードスラッシュ
('/') にマッチしないようになっている
(訳注: <I>sudoers</I> 中で <I>sudoedit</I> に対して引き数を指定する場合、
それは一般のコマンドライン引き数と同じ扱いではなく、パス名扱いになるということ)。
</DL>
<A NAME="lbAR">&nbsp;</A>
<H3>sudoers に他のファイルをインクルードする</H3>

#include 命令や #includedir 命令を使えば、現在解析中の <I>sudoers</I> ファイルに、
外部にあるほかの <I>sudoers</I> ファイルをインクルードすることができる。
<P>

この方法を使えば、たとえば、サイト全体で使用する <I>sudoers</I> ファイルのほかに、
マシンごとのローカルな <I>sudoers</I> ファイルを持つことができる。
ここでは、サイト全体の <I>sudoers</I> ファイルを <I>/etc/sudoers</I> とし、
マシンごとの方は <I>/etc/sudoers.local</I> とすることにしよう。
<I>/etc/sudoers</I> に <I>/etc/sudoers.local</I> をインクルードするには、
<I>/etc/sudoers</I> 中に次の行を書き込めばよい。
<PRE>

<DL COMPACT><DT><DD>#include /etc/sudoers.local
</DL>
</PRE>

<P>

<B>sudo</B> は解析中この行に出会うと、カレントファイル (<I>/etc/sudoers</I> だ)
の処理を一時中止して、処理の対象を <I>/etc/sudoers.local</I> に切り替える。
そして、<I>/etc/sudoers.local</I> の末尾まで達したら、<I>/etc/sudoers</I> の残りを処理するのである。
インクルードされるファイルが、さらに他のファイルをインクルードしていてもよい。
インクルートのネストには、128 ファイルまでというハード・リミットがあって、
インクルードファイルのループが起きないようになっている。
<P>

インクルードファイルのパスが絶対パスでない場合は (すなわち、パスが
'/' で始まっていない場合は)、インクルードする側の sudoers
ファイルと同じディレクトリに、インクルードされるファイルも存在しなければならない。
たとえば、<I>/etc/sudoers</I> に次のような行があったら、
<PRE>

<DL COMPACT><DT><DD>#include sudoers.local
</DL>
</PRE>

<P>

インクルードされるファイルは、<I>/etc/sudoers.local</I> である。
<P>

なお、ファイル名には %h エスケープが使える。これはホスト名の短縮形を示している。
たとえば、マシンのホスト名が &quot;xerxes&quot; のとき、
<PRE>

<DL COMPACT><DT><DD>#include /etc/sudoers.%h
</DL>
</PRE>

<P>

と書けば、<B>sudo</B> はファイル <I>/etc/sudoers.xerxes</I>
をインクルードすることになる。
<P>

#includedir 命令を使えば、<I>sudoers.d</I> ディレクトリを作っておいて、
システムのパッケージ管理者がパッケージをインストールする際に <I>sudoers</I>
のルールを記したファイルをそこに入れてやる、といったことが可能になる。
たとえば、次のように書くと、
<PRE>

<DL COMPACT><DT><DD>#includedir /etc/sudoers.d
</DL>
</PRE>

<P>

<B>sudo</B> は <I>/etc/sudoers.d</I> にあるファイルを一つづつ読み込む。
ただし、末尾が '~' だったり、'.' 文字を含んでいたりするファイル名はスキップするが、
これは、パッケージマネージャやエディタが作った、
テンポラリファイルやバックアップファイルを読み込むような問題を起こさないためである。
ファイルは辞書順にソートされて、解析される。すなわち、<I>/etc/sudoers.d/01_first</I> は
<I>/etc/sudoers.d/10_second</I> より前に解析されるということだ。
ソートは辞書順であって、数値の順ではないので、
<I>/etc/sudoers.d/1_whoops</I> というファイルがあっても、
<I>/etc/sudoers.d/10_second</I> <I>より後で</I>ロードされることに注意していただきたい。
ファイル名の先頭を 0 で埋めて数字の桁を揃えれば、
こうした問題を回避することができる。
<P>

気をつけていただきたいが、#include でインクルードされたファイルとは違って
(訳注: <B>visudo</B> は <I>/etc/sudoers</I> を編集するとき、#include
で指定したファイルがあれば、続けてそれも編集する)、
<B>visudo</B> が #includedir で指定したディレクトリのファイルまで編集するのは、
シンタクスエラーを含むものがあるときだけである。
とは言え、<B>visudo</B> を <B>-f</B> オプション付きで実行して、
ディレクトリ中のファイルを直接編集することは可能だが、その場合は、
他のファイルで定義されているエイリアスが再定義されていても、
それを見つけて指摘してくれることはない。
<A NAME="lbAS">&nbsp;</A>
<H3>ほかの特殊文字と予約語</H3>

パウンド記号 ('#') はコメントを示すのに使用される
(例外は、#include 命令の一部であるときや、ユーザ名に関連して現れ、
その後に一個以上の数字が続くときであり、後者の場合は uid と見なされる)。
コメント記号とそれに続くテキストは、行末にいたるまで無視される。
<P>

予約語 <B>ALL</B> は組込みのエイリアスであり、何に対してでもマッチする。
<B>ALL</B> は、Cmnd_Alias, User_Alias, Runas_Alias, Host_Alias
を代わりに使えるところなら、どこでも使用できる。
<B>ALL</B> という名前のエイリアスを自分で定義しようとしてはいけない。
組込みのエイリアスの方が、自分で作ったエイリアスより優先して使われるからだ。
<B>ALL</B> の使用には危険が伴うことがあるのを忘れないでいただきたい。
なぜなら、<B>ALL</B> をコマンドに関して使うと、
ユーザにシステム上の<I>どんな</I>コマンドでも実行することを許してしまうからである。
<P>

エクスクラメーションマーク ('!') は、リストやエイリアス中はもちろん、
Cmnd の前でも論理 <I>not</I> 演算子として使用することができる。
これによってある値を除外することが可能になるわけだ。
ただし、'!' 演算子が効果を持つためには、
そこから除外する対象が存在しなければならない。
たとえば、root 以外のすべてのユーザにマッチさせたい場合は、
次の表現を使用する。
<PRE>

<DL COMPACT><DT><DD>ALL,!root
</DL>
</PRE>

<P>

次のように <B>ALL</B> の記述を省くと、
<PRE>

<DL COMPACT><DT><DD>!root
</DL>
</PRE>

<P>

確かに root を明示的に否定することにはなるが、
他のどんなユーザともマッチすることがない。
この点が、正真の「否定」演算子とは違っている。
<P>

とは言え、組込みエイリアス <B>ALL</B> と '!' を組み合わせて、
「二三のコマンド以外のすべての」コマンドの実行をあるユーザに許可しようとしても、
意図どおりの動きになることはめったにないことに気をつけていただきたい
(下記の「セキュリティに関する注意点」を参照)。
<P>

長い行は、行末にバックスラッシュ '\' を置けば、継続することができる。
<P>

リストにおける要素間やユーザ設定における構文用特殊文字 ('=', ':',
'(', ')') の前後に空白 (white space) を入れることは、任意である。
<P>

次の文字を単語 (ユーザ名とかホスト名とか) の一部として使うときは、
バックスラッシュ ('\') でエスケープしなければならない。
'!', '=', ':', ',', '(', ')', '\' がそれである。
<A NAME="lbAT">&nbsp;</A>
<H2>SUDOERS のオプション</H2>

すでに説明したように、<B>sudo</B> の動作は Default_Entry 行によって変更することができる。
Defaults に与えることのできるパラメータについて、
サポートされているもののすべてを、タイプ別にまとめて以下に列挙する。
<P>

<B>ブーリアン・フラグ</B> (真偽値)
<DL COMPACT>
<DT>always_query_group_plugin<DD>
<I>group_plugin</I> の設定がなされている場合に、
%group の形式のグループを解決するのに、
同名のシステム・グループが同時に存在しないかぎり、
指定された <I>group_plugin</I> を使用する。
<I>always_query_group_plugin</I> が設定されていない通常の状態では、
%:group の形式のグループのみが <I>group_plugin</I> に渡されるのである。
このフラグはデフォルトでは <I>off</I> である。
<DT>always_set_home<DD>
これを有効にすると、<B>sudo</B> は環境変数 HOME を変身対象ユーザの
(<B>-u</B> オプションが使用されていないかぎり、root の)
ホームディレクトリに設定することになる。事実上、
暗黙のうちに <B>sudo</B> に <B>-H</B> オプションが常に指定されることになるわけだ。
気をつけていただきたいが、デフォルトでは、
<I>env_reset</I> オプションが有効になっている場合は、
HOME の値は、変身対象ユーザのホームディレクトリに設定されることになる。
だから、<I>always_set_home</I>
の指定に効果があるのは、<I>env_reset</I> を無効に設定している場合か、
<I>env_keep</I> のリストに HOME が存在する場合だけである。
このフラグはデフォルトでは <I>off</I> である。
<DT>authenticate<DD>
これをセットすると、ユーザはコマンドの実行を許可される前に、パスワードで
(あるいは、ほかの認証方法で) 自分が本人であることを証明しなければならなくなる。
このデフォルト値は PASSWD や NOPASSWD タグで変更できる。
このフラグはデフォルトでは <I>on</I> である。
<DT>closefrom_override<DD>
これをセットすると、ユーザが <B>sudo</B> の <B>-C</B>
オプションを使用できるようになる。<B>-C</B> オプションというのは、
<B>sudo</B> が開いているファイル・ディスクリプタを閉じていくとき、
どのディスクリプタから閉じていくかという、デフォルトの始点を変更するものだ。
このフラグはデフォルトでは <I>off</I> である。
<DT>compress_io<DD>
これをセットすると、
<B>sudo</B> がコマンドの入出力のログを取るように設定されている場合に、
入出力のログを <B>zlib</B> を使って、圧縮することになる。
<B>sudo</B> が <B>zlib</B> をサポートするようにコンパイルされている場合、
このフラグのデフォルトは <I>on</I> である。
<DT>exec_background<DD>
デフォルトでは、<B>sudo</B> 自体がフォアグラウンドで実行されているかぎり、
コマンドは <B>sudo</B> によってフォアグラウンド・プロセスとして実行される。それに対して、
<I>exec_background</I> フラグが有効になっている場合は、
コマンドが (入出力ロギングや <I>use_pty</I> フラグのために) pty で実行されていると、
そのコマンドはバックグラウンド・プロセスとして実行されることになる。
このとき、そのコマンドが制御ターミナルから読み込みを行おうとすると
(あるいは、ターミナルの設定を変更しようとすると）、
コマンドは SIGTTIN シグナル (ターミナル設定の場合は SIGTTOU シグナル)
によってサスペンドされる。そうしたことが起きても、
<B>sudo</B> がフォアグラウンド・プロセスならば、
そのコマンドは制御ターミナルの使用を許可され、
ユーザが何の操作をしないでも、フォアグラウンドで実行が再開される。
コマンドの実行をバックグラウンドで始めることの利点は、
そうすれば、コマンドが明示的に要求しないかぎり、
<B>sudo</B> はターミナルから読み込みを行う必要がないということである。
そうしない場合は、コマンドが入力を要求しているか否かに関わりなく、
いかなる入力もコマンドに渡さなければならないのだ
(カーネルがターミナルのバッファリングをしているので、
コマンドが本当にその入力を必要としているかどうかを、
判断することはできないのである)。
この動作は、従来の <I>sudo</I> の動作とは異なっている。
また、コマンドが pty で実行されていないときの動作とも異なっている。
<P>
この動作がシームレスに行われるためには、オペレーティングシステムが、
システムコールの自動的な再スタートをサポートしていなければならない。
残念なことに、すべてのオペレーティングシステムが、
デフォルトでそれを行ってくれるわけではなく、
それを行ってくれるオペレーティングシステムにも、バグがあることがある。たとえば、
Mac OS X は、<B>tcgetattr</B>() や <B>tcsetattr</B>() システムコールの再スタートに失敗する
(これは Mac OS X のバグである)。それだけではなく、この動作は、
コマンドが SIGTTIN や SIGTTOU シグナルで停止することを当てにしているので、
そうしたシグナルは捕獲し、別のシグナル (たいていは SIGSTOP)
で自分を停止させるプログラムは、自動的にフォアグラウンド化できない。
linux の <A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1) コマンドの動作が、系統によっては、そんなふうになっている。
このフラグはデフォルトでは <I>off</I> である。
<P>
この設定は、バージョン 1.8.7 以上でのみサポートされている。
また、入出力ロギングが有効になっている場合や、
<I>use_pty</I> フラグが有効になっている場合以外、この設定には効果がない。
<DT>env_editor<DD>
これをセットすると、<B>visudo</B> はデフォルトのエディタ・リストを利用する前に、
環境変数 EDITOR や VISUAL の値を使用するようになる。
それがセキュリティホールになりかねないことに注意していただきたい。
ユーザが root として任意のコマンドを、
ログに記録されることなく実行できるようになるからだ。
こうした環境変数を利用するときの、<I>env_editor</I> を有効にするよりも安全な方法は、
<I>sudoers</I> ファイルの <I>editor</I> オプションにコロンで区切ったエディタのリストを書いておくことだ。そうすれば、
<B>visudo</B> が EDITOR や VISUAL を使うのは、それが <I>editor</I>
オプションに指定した値とマッチしたときだけになる。
<I>env_reset</I> フラグが有効な場合に、<B>sudo</B> 経由で <B>visudo</B> を起動したとき
<I>env_editor</I> フラグが効果を持つためには、
環境変数 EDITOR や VISUAL が <I>env_keep</I> のリストに存在していなければならない。
このフラグはデフォルトでは <I>off</I> である。
<DT>env_reset<DD>
これをセットすると、<B>sudo</B> は最小限の環境でコマンドを実行することになる。
その環境には、以下の変数が含まれている。TERM, PATH, HOME,
MAIL, SHELL, LOGNAME, USER, USERNAME、及び SUDO_* という変数。
それに、<B>sudo</B> を起動するユーザの環境にある変数のうち、
<I>env_keep</I> や <I>env_check</I> のリストにマッチするものが加わり、
さらに、<I>env_file</I> オプションによって指定されたファイルがあれば、
そのファイルに記載されたすべての変数が追加される。
<I>env_keep</I> や <I>env_check</I> のリストにどんな変数が存在するかについては、
root ユーザとして <B>sudo</B> に <B>-V</B> オプションを付けて実行すれば、
<I>sudoers</I> 中でグローバルな Defaults パラメータによって変更された結果を、
見ることができる。
なお、<I>secure_path</I> オプションが設定されているときは、
その値が環境変数 PATH の値として使用される。
このフラグはデフォルトでは <I>on</I> である。
<DT>fast_glob<DD>
通常 <B>sudo</B> はパス名のマッチングをするとき、<A HREF="../../LDP_man-pages/man3/glob.3.html">glob</A>(3)関数を使用して、
シェル・スタイルのワイルドカード展開 (glob) を行う。
しかし、<A HREF="../../LDP_man-pages/man3/glob.3.html">glob</A>(3) はファイルシステムにアクセスするので、
指定パターンによっては、作業を完了するまでに時間がかかることがある。
必要に応じてマウントするようになっている (つまりオートマウントの)
ネットワーク・ファイル・システムを参照するときは、とりわけ時間がかかる。
<I>fast_glob</I> オプションを指定すると、<B>sudo</B> が <A HREF="../../LDP_man-pages/man3/fnmatch.3.html">fnmatch</A>(3) 関数を使うようになるが、
こちらの関数はマッチングを行う際にファイルシステムにアクセスしない。
<I>fast_glob</I> の欠点は、<I>./ls</I> や <I>../bin/ls</I>
のような相対パスに対するマッチができないことである。そのため、
ワイルドカードを含むパス名が、否定演算子 '!'
と一緒に使われている場合に、セキュリティ上の問題が生じるおそれがある。
そうしたルールは簡単に迂回できるからだ。
従って、<I>sudoers</I> ファイルに、ワイルドカードを含むパス名を否定するルールが存在する場合は、
このオプションを使ってはいけない。このフラグはデフォルトでは <I>off</I> である。
<DT>fqdn<DD>
ローカル・ホスト名 (hostname コマンドが返すもの) がドメイン名を含まないとき、
<I>sudoers</I> ファイルで完全修飾ホスト名を使用したかったら、
このフラッグをセットするとよい。すなわち、myhost ではなく、
myhost.mydomain.edu を使いたい場合だ。そのときでも、
そうしたければ、短縮形も使用できる (両方を混ぜて使うこともできる)。
このオプションに効果があるのは、<B>getaddrinfo</B>() や <B>gethostbyname</B>()
関数が返すホストの「正規名 (canonical name)」が、
完全修飾ドメイン名であるときだけである。
システムがホスト名の解決に DNS を使用するように設定されているときは、普通そうなる。
<P>
システムが DNS よりも優先して <I>/etc/hosts</I> を使用するように設定されている場合、
ホストの正規名は完全修飾名ではないかもしれない。
ホスト名解決のために問い合わせる情報源の順番は、普通 <I>/etc/nsswitch.conf</I>,
<I>/etc/netsvc.conf</I>, <I>/etc/host.conf</I> ファイルで指定されている。
<I>/etc/resolv.conf</I> のこともある。<I>/etc/hosts</I> ファイルでは、
エントリの最初のホスト名が正規名と見なされる。後に続く名前はエイリアスであり、
<B>sudoers</B> によって使用されることはない。たとえば、hosts ファイルに
&quot;xyzzy&quot; というマシンについて下記の行があるとき、
完全修飾ドメイン名がホストの正規名であり、短い方の名前はエイリアスである。
<P>
<DL COMPACT><DT><DD>
192.168.1.1<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT>xyzzy.sudo.ws xyzzy<BR>
</DL>

<DL COMPACT><DT><DD>
<P>
hosts ファイルにおけるマシンのエントリの書式が不適切だと、
hosts ファイルへの問い合わせが DNS より前に行われる場合、<I>fqdn</I>
オプションを指定しても、効果がない。
<P>
気を付けてほしいのは、ホスト名の解決に DNS を使用する場合、
<I>fqdn</I> 有効にすると、<B>sudoers</B> は DNS に問い合わせをしなければならないので、
DNS が稼働していないと (たとえば、マシンがネットワークから切り離されていると)、
<B>sudo</B> が使えなくなるということである。
もう一つ気を付けるべきことがある。hosts ファイルを使用する場合と同じことだが、
DNS が知っているホストの正規名を使わなければならない。
言い換えれば、ホストのエイリアス (CNAME のエントリ) を使ってはいけない。
パフォーマンスの問題もあるし、DNS からエイリアスをすべて取得する方法はないからでもある。
<P>
このフラグはデフォルトでは <I>off</I> である。
</DL>

<DT>ignore_dot<DD>
これをセットすると、環境変数 PATH 中に &quot;.&quot; や &quot;&quot;
(どちらもカレントディレクトリを意味する) があっても、
<B>sudo</B> はそれを無視する。PATH そのものは変更されない。
このフラグはデフォルトでは <I>off</I> である。
<DT>ignore_local_sudoers<DD>
LDAP の方でこのフラグをセットすると、<I>/etc/sudoers</I> の解析がスキップされることになる。
このフラグは、ローカルにある sudoers ファイルの使用を禁じて、
LDAP のみを使うようにしたい諸企業のためにある。
たちの悪いオペレータが <I>/etc/sudoers</I> に手を加えて、
自分の権限を増やそうとしても、そうした悪だくみは阻止されるわけだ。
このオプションが設定されているときは、
<I>/etc/sudoers</I> ファイルは存在する必要すらない。このオプションは、
LDAP 中に、マッチする特定のエントリが存在しなかったときに、
いかに振舞うべきかを <B>sudo</B> に指示するものだから、
これを指定する sudoOption は、cn=defaults のセクションになければ意味がない。
このフラグはデフォルトでは <I>off</I> である。
<DT>insults<DD>
これをセットすると、不正なパスワードが入力されたとき、
<B>sudo</B> がユーザに悪態をつく。このフラグはデフォルトでは <I>off</I> である。
<DT>log_host<DD>
これをセットすると、ホスト名が (syslog 経由ではない) <B>sudo</B> のログファイルに記録されることになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>log_input<DD>
これをセットすると、<B>sudo</B> は、擬似 tty でコマンドを実行し、
ユーザの入力をすべてログに取ることになる。入出力がリダイレクトされているとか、
コマンドがパイプラインの一部だとかいう理由で、標準入力がユーザの tty
に結びつけられていない場合でも、その入力はやはりキャプチャーされ、
独立したログファイルに書き込まれる。
より詳しい情報については、「入出力ログファイル」セクションをご覧になるとよい。
このフラグはデフォルトでは <I>off</I> である。
<DT>log_output<DD>
これをセットすると、<B>sudo</B> は、<I>擬似 tty</I> でコマンドを実行し、
スクリーンに送られたすべての出力をログに取ることになる。
<A HREF="../../util-linux/man1/script.1.html">script</A>(1) コマンドと似たことをやるわけだ。
より詳しい情報については、「入出力ログファイル」セクションをご覧になるとよい。
このフラグはデフォルトでは <I>off</I> である。
<DT>log_year<DD>
これをセットすると、四桁の年が (syslog 経由ではない) <B>sudo</B> のログファイルに記入されることになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>long_otp_prompt<DD>
<B>S/Key</B> や <B>OPIE</B> のような One Time Password (OTP) スキームを採用しているときにこれを有効にすると、
チャレンジをローカルウィンドウにカット・アンド・ペーストしやすいように、
二行のプロンプトが使用される。デフォルトのプロンプトほど見栄えはよくないが、
こちらの方が便利だと思う人もいる。このフラグはデフォルトでは <I>off</I> である。
<DT>mail_all_cmnds<DD>
ユーザが <B>sudo</B> 経由でコマンドの実行を試みるたびに
(<B>sudoedit</B> の実行も含む)、<I>mailto</I> ユーザにメールを送付する。
ただし、ユーザが <B>sudo</B> に <B>-l</B> や <B>-v</B> オプションを付けて実行したときは、
認証エラーがあり、しかも <I>mail_badpass</I> フラグがセットされていないかぎり、
メールを送付することはない。このフラグはデフォルトでは <I>off</I> である。
<DT>mail_always<DD>
ユーザが <B>sudo</B> を実行するたびに、<I>mailto</I> ユーザにメールを送る。
このフラグはデフォルトでは <I>off</I> である。
<DT>mail_badpass<DD>
<B>sudo</B> を実行するユーザが正しいパスワードを入力しなかったら、
<I>mailto</I> ユーザにメールを送付する。ユーザが実行しようとしているコマンドが
<B>sudoers</B> によって許可されていない場合に、<I>mail_all_cmnds</I>,
<I>mail_always</I>, <I>mail_no_host</I>, <I>mail_no_perms</I>, <I>mail_no_user</I>
フラグのどれかがセットされていると、このフラグは効果を持たないことになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>mail_no_host<DD>
これをセットすると、<B>sudo</B> を起動したユーザが <I>sudoers</I>
ファイルに記載されてはいるものの、
使用中のホストでコマンドの実行を許可されていない場合に、
<I>mailto</I> ユーザにメールを送付する。このフラグはデフォルトでは
<I>off</I> である。
<DT>mail_no_perms<DD>
これをセットすると、<B>sudo</B> を起動したユーザが
<B>sudo</B> の使用を許可されているが、
実行しようとしているコマンドが <I>sudoers</I> ファイルの
そのユーザのエントリに登録されていないか、明示的に禁止されている場合に、
<I>mailto</I> ユーザにメールを送付する。このフラグはデフォルトでは
<I>off</I> である。
<DT>mail_no_user<DD>
これをセットすると、<B>sudo</B> を起動したユーザが <I>sudoers</I>
ファイルに記載されていない場合に、<I>mailto</I> ユーザにメールを送付する。
このフラグはデフォルトでは <I>on</I> である。
<DT>netgroup_tuple<DD>
これをセットすると、
ネットグループの検索がネットグループのタプル全部を使って行われることになる
(すなわち、ホスト名、ユーザ名、ドメインの三つが、それぞれ設定されているならば、
使用される)。従来の <B>sudo</B> では、
User_List で使用されるネットグループについては、
ユーザ名とドメインだけを照合し、Host_List で使用されるネットグループについては、
ホスト名とドメインだけを照合していた。このフラグはデフォルトでは <I>off</I> である。
<DT>noexec<DD>
これをセットすると、<B>sudo</B> を通して実行されるすべてのコマンドが、
EXEC タグで無効にされないかぎり、
あたかも NOEXEC タグが設定されているかのごとく振舞うようになる。
前述の「<I>EXEC</I> と <I>NOEXEC</I>」の説明、および、
このマニュアルの終わりの方にある「シェル・エスケープの防止」というセクションを参照していただきたい。
このフラグはデフォルトでは <I>off</I> である。
<DT>pam_session<DD>
認証に PAM を使用するシステムでは、<B>sudo</B> は新しい PAM セッションを作成し、
その中でコマンドを実行する。PAM の実装が古い場合や、
PAM セッションの開始が utmp や wtmp ファイルを変更するオペレーティングシステムでは、
<I>pam_session</I> を無効にする必要があるかもしれない。
ただし、PAM セッションのサポートを無効にすると、
実行されるコマンドに対するリソースの上限が更新されないかもしれない。
なお、<I>pam_session</I>, <I>pam_setcred</I>, <I>use_pty</I> が無効になっていて、
しかも 入出力ロギングが設定されていない場合は、
<B>sudo</B> はコマンドを子プロセスとしてではなく、
直接実行する。このフラグはデフォルトでは <I>on</I> である。
<P>
この設定は、バージョン 1.8.7 以上でのみサポートされている。
<DT>pam_setcred<DD>
認証に PAM を使用するシステムでは、<B>sudo</B> はデフォルトでは、
使用している認証システムがサポートしているなら、変身対象ユーザの認証情報
(credential) が有効であることを確認しようとする。認証情報の例を一つ挙げれば、
Kerberos のチケットがそれである。<I>pam_session</I>, <I>pam_setcred</I>,
<I>use_pty</I> が無効になっていて、しかも 入出力ロギングが設定されていない場合は、
<B>sudo</B> はコマンドを子プロセスとしてではなく、直接実行する。
このフラグはデフォルトでは <I>on</I> である。
<P>
この設定は、バージョン 1.8.8 以上でのみサポートされている。
<DT>passprompt_override<DD>
通常、<I>passprompt</I> オプションによって指定されたパスワードプロンプトが使用されるのは、
PAM のようなシステムが用意しているパスワードプロンプトが、
&quot;Password:&quot; という文字列にマッチしているときだけである。
<I>passprompt_override</I> をセットすると、<I>passprompt</I> が無条件で使われることになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>path_info<DD>
通常 <B>sudo</B> は、環境変数 PATH 中にコマンドが見付からないと、
ユーザにその旨を知らせる。これを利用すれば、
一般ユーザにアクセス権のない実行ファイルのありかについて情報を収集できるという理由から、
この動作を無効にしたいサイトもあるかもしれない。
その場合の欠点は、実行ファイルが単にユーザの PATH 中になかっただけの場合でも、
実行の許可がないと <B>sudo</B> がユーザに告げることになって、
実情がわかりにくいかもしれないことである。
このフラグはデフォルトでは <I>on</I> である。
<DT>preserve_groups<DD>
デフォルトでは、<B>sudo</B> は所属グループの初期値として、
変身対象ユーザが所属しているグループのリストを設定する。
<I>preserve_groups</I> をセットすると、
<B>sudo</B> を実行するユーザの所属グループのリストが、
変更されずにそのまま維持される。とは言え、実グループ ID や実効グループ ID が、
変身対象ユーザのそれに設定されることに変わりはない。
このフラグはデフォルトでは <I>off</I> である。
<DT>pwfeedback<DD>
ほかのたいていの Unix のプログラムと同様、
<B>sudo</B> はパスワードを読み込むとき、デフォルトでは、ユーザが Return
(または Enter) キーを押すまで、エコーを off にする。
この動作にとまどうユーザが存在する。
彼らには <B>sudo</B> が急に反応しなくなったように見えるのだ。
<I>pwfeedback</I> をセットすると、ユーザがキーを押すたびに、
<B>sudo</B> が目に見える反応を返すようになる。
これには、セキュリティ上の問題があることに注意していただきたい。
側で見ている人が、打ち込まれたパスワードの文字数を特定できてしまうかもしれないのだ。
このフラグはデフォルトでは <I>off</I> である。
<DT>requiretty<DD>
これをセットすると、<B>sudo</B> が実行されるのは、ユーザが実際の tty
にログインしたときだけになる。すなわち、<B>sudo</B> を実行できるのは、
ログイン・セッションからだけであって、<A HREF="../../cron/man8/cron.8.html">cron</A>(8) や cgi-bin スクリプトといった、
ほかの方法を介して実行することはできないということだ。
このフラグは、デフォルトでは <I>off</I> である。
<DT>root_sudo<DD>
これをセットすると、root も <B>sudo</B> を実行できるようになる。
このフラグを無効にすると、ユーザがたとえば &quot;sudo sudo /bin/sh&quot;
といったように <B>sudo</B> コマンドを「連鎖的に」使って、
ルートシェルを獲得することができなくなる。
ところで、<I>root_sudo</I> が off だと、
root が <B>sudoedit</B> まで実行できなくなることに注意していただきたい。
<I>root_sudo</I> を無効にしても、セキュリティが実際に向上するわけではない。
このフラグが存在しているのは、
もっぱら歴史的な理由からなのだ。このフラグはデフォルトでは <I>on</I> である。
<DT>rootpw<DD>
これをセットすると、<B>sudo</B> は、コマンドを実行したり、
ファイルを編集したりするとき、起動したユーザのパスワードではなく、
root のパスワードを要求するようになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>runaspw<DD>
これをセットすると、<B>sudo</B> は、コマンドを実行したり、
ファイルを編集したりするとき、起動したユーザのパスワードではなく、
<I>sudoers</I> ファイルの <I>runas_default</I> オプションで指定しているユーザーの
(デフォルトでは root である) パスワードを要求するようになる。
このフラグはデフォルトでは <I>off</I> である。
<DT>set_home<DD>
これが有効なときに <B>sudo</B> を <B>-s</B> オプション付きで起動すると、
環境変数 HOME が変身対象ユーザの (<B>-u</B> オプションが使用されないかぎり、
それは root である) ホームディレクトリに設定される。すなわち、
<B>-s</B> オプションが <B>-H</B> オプションを事実上兼ねることになるわけだ。
気をつけてほしいのは、<I>env_reset</I> が有効な場合、HOME はすでに
(訳注: 変身対象ユーザのホームディレクトリに) 設定済みだということだ。
だから、<I>set_home</I> の効果があるのは、<I>env_reset</I> が無効に設定されているか、
<I>env_keep</I> のリストに HOME が存在する場合だけである。
このフラグはデフォルトでは <I>off</I> である。
<DT>set_logname<DD>
通常 <B>sudo</B> は環境変数 LOGNAME, USER, USERNAME を変身対象ユーザの名前
(<B>-u</B> オプションが指定されていない場合、普通は root) にセットする。
しかし、プログラムによっては
(たとえば、RCS リビジョンコントロールシステムがその一つだが)
ユーザが実際には誰であるかを判定するのに LOGNAME を使用していることがあり、
そのため、この振舞いを変更したい場合もある。
set_logname オプションに '!' を付けて否定することで、それができる。
なお <I>env_reset</I> オプションを無効にしていない場合に、
<I>env_keep</I> のリストに LOGNAME, USER, USERNAME などが入っていると、
<I>set_logname</I> は効果を持たないので、注意していただきたい。
このフラグはデフォルトでは <I>on</I> である。
<DT>set_utmp<DD>
これが有効になっていると、<B>sudo</B> は擬似 tty を割り当てるときに、
utmp (または utmpx) ファイルにエントリを作成する。
<B>sudo</B> によって擬似 tty の割り当てが行われるのは、<I>log_input</I>,
<I>log_output</I>, <I>use_pty</I> といったフラグが有効になっているときである。
デフォルトでは、新しいエントリは、そのユーザの utmp エントリが存在すれば、
そのコピーであり、tty, time, type, pid フィールドが更新される。
このフラグはデフォルトでは <I>on</I> である。
<DT>setenv<DD>
これをセットすると、ユーザがコマンドラインで <B>-E</B> オプションを指定して、
<I>env_reset</I> オプションを無効にできるようになる。
さらに、コマンドラインから設定する環境変数が
<I>env_check</I>, <I>env_delete</I>, <I>env_keep</I> による制限を受けなくなる。
それ故、そのようなやり方で変数を設定することを許可するのは、
信用できるユーザのみに限るべきだ。
このフラグはデフォルトでは <I>off</I> である。
<DT>shell_noargs<DD>
これがセットされているとき、<B>sudo</B> を引き数なしで起動すると、
<B>sudo</B> は <B>-s</B> オプションが指定されたかのように振舞う。
すなわち、root ユーザとしてシェルを実行するわけだ (シェルは、環境変数
SHELL がセットされていれば、それによって決まり、
セットされていなければ、<B>sudo</B> を起動したユーザの
/etc/passwd エントリに登録されたものになる)。このフラグはデフォルトでは
<I>off</I> である。
<DT>stay_setuid<DD>
通常 <B>sudo</B> は、コマンドを実行するとき、実 UID と実効 UID
を変身対象ユーザ (デフォルトでは root) のものにセットする。
このオプションは、その振舞いを変更して、<B>sudo</B> を起動したユーザの
UID が、そのまま実 UID として残るようにするのだ。言い換えると、
このオプションは <B>sudo</B> を setuid ラッパーとして動作するようにするわけである。
プログラムを setuid で動かすと、危険をもたらしかねないという理由から、
ある種の機能を使えないようにしているシステムでは、
このオプションが役に立つかもしれない。このオプションは、システムコールの
setreuid() や setresuid() をサポートしているシステムでのみ有効である。
このフラグはデフォルトでは <I>off</I> である。
<DT>sudoedit_checkdir<DD>
<BR>

これをセットすると、
<B>sudoedit</B> は、編集対象ファイルのパス中にあるディレクトリ部分のすべてについて、
<B>sudoedit</B> を実行するユーザとって書き込み可能かどうかを、チェックすることになる。
ユーザに書き込み可能なディレクトリに存在するいかなるシンボリックリンクも、
たどられることがなく、また、ユーザに書き込み可能なディレクトリにあるファイルの編集は、
拒否されることになる。
ただし、こうした制限は、<B>sudoedit</B> を実行するユーザが root の場合には、行われない。
システムによっては、編集対象ファイルのパス中にあるディレクトリ部分のすべてが、
変身対象ユーザにとって読み込み可能でないかぎり、
<B>sudoedit</B> でファイルを編集できないものもある。
このフラグはデフォルトでは <I>on</I> である。
<P>
この設定が最初に導入されたのは、バージョン 1.8.15 だったが、
当初のものには競合状態を引き起こす欠陥があった。
編集対象ファイルのパスの途中に書き込み可能なディレクトリがあり、
そこにシンボリックリンクが存在する場合のチェックは、バージョン 1.8.16 で追加された。
<DT>sudoedit_follow<DD>
<B>sudoedit</B> はデフォルトでは、ファイルをオープンするときにシンボリックリンクをたどらない。
<I>sudoedit_follow</I> オプションを有効にすると、
<B>sudoedit</B> がシンボリックリンクをオープンできるようになる。
そうした動作は <I>FOLLOW</I> や <I>NOFOLLOW</I> タグを使えば、
コマンドごとに変更することができる。このフラグはデフォルトでは <I>off</I> である。
<P>
この設定は、バージョン 1.8.15 以上でのみサポートされている。
<DT>targetpw<DD>
これをセットすると、<B>sudo</B> は、コマンドを実行したり、
ファイルを編集したりするとき、起動したユーザのパスワードではなく、
<B>-u</B> オプションで指定されたユーザ (デフォルトでは root)
のパスワードを要求するようになる。
このフラグを設定をすると、<B>-u</B> オプションの引き数として、
passwd データベースに登録されていない uid が使えなくなることに注意してほしい。
このフラグはデフォルトでは <I>off</I> である。
<DT>tty_tickets<DD>
これをセットすると、ユーザは tty ごとに認証をしなければならなくなる。
このフラグが有効な場合、<B>sudo</B> は、各 tty に対して、
タイムスタンプ・ファイル中の、それぞれ別個に記録される情報を使用することになる。
それに対して、このフラグが無効な場合は、すべてのログイン・セッションに対して、
単一の記録が使用されるのである。このフラグはデフォルトでは <I>on</I> である。
<DT>umask_override<DD>
これをセットすると、<B>sudo</B> は umask を <I>sudoers</I> の
umask オプションで指定されたとおりの値に、変更を加えることなく設定する。
このことによって、ユーザ自身の umask 値よりもっと緩やかな umask 値を
<I>sudoers</I> ファイルで指定することが可能になる。<B>sudo</B> の昔の動作と同じになるわけだ。
<I>umask_override</I> をセットしない場合、
現在の <B>sudo</B> は umask を、ユーザの umask 値と <I>sudoers</I> で指定した
umask 値とのビット和に設定することになっている。
このフラグはデフォルトでは <I>off</I> である。
<DT>use_netgroups<DD>
これをセットすると、ユーザやホストを指定する場所でネットグループ
(接頭辞 '+' が付く) が使えるようになる。LDAP を使用する sudoers では、
ネットグループをサポートすると、<I>/etc/ldap.conf</I> ファイルで
<B>NETGROUP_BASE</B> 設定オプションを指定していない場合に、
サーバ側で負荷の高い部分文字列 (substring) のマッチングを行う必要が生じる。
そこで、ネットグループを使用する必要がない場合は、
このオプションを <I>off</I> にすれば、LDAP サーバの負荷を減らすことができる。
このフラグはデフォルトでは <I>on</I> である。
<DT>use_pty<DD>
これをセットすると、<B>sudo</B> は入出力のロギングが行われていないときでも、
擬似 tty でコマンドを実行することになる。
<B>sudo</B> によって実行された悪意のあるプログラムが、
バックグラウンド・プロセスをフォークし、
そのプロセスが、メインプログラムの実行が終了した後でも、
ユーザのターミナルデバイスを握って離さないといったことが考えられる。
このオプションを使えば、そういったことが不可能になる。
このフラグはデフォルトでは <I>off</I> である。
<DT>utmp_runas<DD>
これをセットすると、<B>sudo</B> は utmp (または utmpx) ファイルを更新するとき、
変身対象ユーザの名前を記録するようになる。<B>sudo</B> はデフォルトでは、
<B>sudo</B> を実行したユーザの名前を記録するのだ。
このフラグはデフォルトでは <I>off</I> である。
<DT>visiblepw<DD>
デフォルトでは、ユーザがパスワードを入力しなければならないときに、
使用しているターミナルでエコーの抑制ができなかったら、
<B>sudo</B> は実行を拒否するようになっている。
それに対し、<I>visiblepw</I> フラグが設定されていると、
パスワードがスクリーンに表示されてしまう場合でも、
<B>sudo</B> はプロンプトを出して、パスワードを求めるようになる。
ssh(1) はデフォルトでは、コマンドを実行する際に tty を割り当てないので、
<B>sudo</B> はエコーの抑制ができないが、その場合でも、この設定によって、
&quot;ssh somehost sudo ls&quot; といった操作の実行が可能になるわけだ。
このフラグはデフォルトでは <I>off</I> である。
</DL>
<P>

<B>整数</B>:
<DL COMPACT>
<DT>closefrom<DD>
<B>sudo</B> はコマンドを実行する前に、標準入力、標準出力、標準エラー
(すなわち、ファイルディスクリプタ 0-2 ) を除いて、
開いているすべてのファイル・ディスクリプタをクローズする。
<I>closefrom</I> オプションを使用すると、
0-2 以外のどのファイル・ディスクリプタから閉じて行くかを指定することができる。
デフォルトは 3 である。
<DT>maxseq<DD>
入出力ログファイルで
&quot;%{seq}&quot; エスケープシーケンスに置き換えられる連続番号の最大値
(詳細については、後述の <I>iolog_dir</I> オプションの説明を参照すること)。
&quot;%{seq}&quot; に置き換えられる値は 36 進数だが、<I>maxseq</I> そのものは
10 進数で指定するべきである。2176782336 (38 進数の連続番号では、
&quot;ZZZZZZ&quot; に相当する) より大きい値は 、暗黙のうちに
2176782336 に縮小される。デフォルトの値は 2176782336 である。
<P>
使用している連続番号が <I>maxseq</I> の値に達したら、最初の値の 0 に戻る。
それ以後は、<B>sudoers</B> は存在している入出力ログファイルをサイズ 0 に短縮して、
そのパス名を再利用することになる。
<P>
この設定は、バージョン 1.8.7 以上でのみサポートされている。
<DT>passwd_tries<DD>
<B>sudo</B> が「失敗」をログに記録して終了する前に、
ユーザがパスワードを入力できる回数。デフォルトは 3 回。
</DL>
<P>

<B>真偽値としても使用できる整数</B>:
<DL COMPACT>
<DT>loglinelen<DD>
<B>sudo</B> 独自のログファイルの一行あたりの文字数。この値は、
ログファイルを見やすくするために改行する位置を決めるのに使用される。
この値は、syslog 経由のログファイルには影響せず、
独自のファイルにログを記録するときのみ効果がある。デフォルトは 80 である
(改行をしないようにするには、値を 0 にするか、頭に '!' を付けて、
このオプションを否定する)。
<DT>passwd_timeout<DD>
<B>sudo</B> のパスワードプロンプトが時間切れになるまでの分単位の時間。
0 を指定すると、時間切れなしになる。
分よりももっと細かい時間を指定したかったら、2.5 のように、
小数点以下を付けることもできる。デフォルトは 5 分。
<DT>timestamp_timeout<DD>
<BR>

<B>sudo</B> がパスワードを再び要求するようになるまでの時間を分単位で指定する。
分よりももっと細かい時間を指定したかったら、2.5 のように、
小数点以下を付けることもできる。デフォルトは 5 分である。
これを 0 にセットすると、毎回パスワードを要求するようになる。
0 よりも小さい値にセットすると、ユーザのタイムスタンプは、
システムがリブートされるまで期限切れにならない。
ユーザが &quot;sudo -v&quot; と &quot;sudo -k&quot; を実行することによって、
タイムスタンプを自分で作ったり、消したりできるようにしたかったら、
この手を使えばよい。
<DT>umask<DD>
コマンドを実行するときに使用する umask 値。
ユーザの umask 値をそのまま使いたかったら、'!' を頭に付けて、
このオプションを否定するか、0777 にセットすればよい。
このオプションの値が 0777 以外の場合、実際に使用される umask 値は、
ユーザの umask 値と <I>umask</I> オプションの値とのビット和であり、
後者のデフォルトは 0022 である。
このことによって、<B>sudo</B> がコマンドを実行するときの umask 値が、
ユーザの umask 値より低くならないようになっているわけだ。
PAM を使用しているシステムでは、
PAM のデフォルト設定で umask 値を指定することができるが、
その場合は、それが <I>sudoers</I> で指定する値に優先することに注意していただきたい。
</DL>
<P>

<B>文字列</B>:
<DL COMPACT>
<DT>badpass_message<DD>
ユーザが不正なパスワードを入力したときに表示するメッセージ。
<I>insults</I> フラグが有効になっていないかぎり、
デフォルトは「Sorry, try again.」である。
<DT>editor<DD>
<B>visudo</B> で使用できるエディタをコロン (':') で区切ったリスト。<B>visudo</B> は、
可能ならば、ユーザの EDITOR 環境変数や
VISUAL 環境変数とマッチしたリスト中のエディタを選択する。
それができないときは、このリストにあるエディタで、実際に存在し、
かつ実行可能な最初のエディタを使用する。
環境変数 EDITOR や VISUAL は、<I>env_reset</I> オプションが有効な場合、
デフォルトでは保存されないことに注意していただきたい。
デフォルトは <I>vi</I> である。
<DT>iolog_dir<DD>
このオプションの値をトップレベル・ディレクトリにして、
入出力ログを置くディレクトリのパス名が構成される。この値が使用されるのは、
<I>log_input</I> や <I>log_output</I> オプションが有効になっているときや、
LOG_INPUT や LOG_OUTPUT タグがコマンドに付いているときだけである。
このディレクトリ以下に、セッション ID が連番ならば、
セッションの連番が (訳注: 以下の &quot;%{seq}&quot; の説明にあるような形で)　
格納されることになるわけだ。デフォルトは <I>/var/log/sudo-io</I> である。
<P>
以下のパーセント ('%') エスケープシーケンスが使用できる。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT>%{seq}<DD>
単調に増加する 36 進数の連続番号に展開される。たとえば、0100A5
といった番号であり、二桁づつ使って新しいディレクトリを作っていく。
この場合なら、<I>01/00/A5</I> といった具合だ。

<DT>%{user}<DD>
<B>sudo</B> を実行するユーザーのログイン名に展開される。
<DT>%{group}<DD>
<B>sudo</B> を実行するユーザーの実グループ ID の名前に展開される。
<DT>%{runas_user}<DD>
変身対象ユーザのログイン名に展開される (たとえば root)。
<DT>%{runas_group}<DD>
変身対象ユーザのグループ名に展開される (たとえば wheel)。
<DT>%{hostname}<DD>
ドメイン名なしのローカル・ホスト名に展開される。
<DT>%{command}<DD>
実行されるコマンドのベースネームに展開される。
</DL>
<P>

このほか、システムの <A HREF="../../LDP_man-pages/man3/strftime.3.html">strftime</A>(3) 関数がサポートしているエスケープシーケンスは、
いかなるものでも展開の対象になる。
<P>
'%' 文字そのものを使いたかったら、文字列 '%%' を使用すればよい。
</DL>

<DL COMPACT>
<DT>iolog_file<DD>
<I>iolog_dir</I> を基点とする相対パス名であり、<I>log_input</I> や
<I>log_output</I> オプションが有効になっていたり、LOG_INPUT や LOG_OUTPUT
タグがコマンドに付いている場合に、入出力ログがこの中に格納される。
<I>iolog_file</I> の値が複数のディレクトリ構成要素を含んでいることがあるのに注意していただきたい。
デフォルトは &quot;%{seq}&quot; である。
<P>
使用できるパーセント ('%') エスケープシーケンスのリストについては、
上記の <I>iolog_dir</I> オプションを参照。
<P>
エスケープシーケンスの展開とは別に、パス名が六個以上の X で終わっている場合は、
X の部分が、他と重複しない英数字の組み合わせに置き換えられる。
<A HREF="../../LDP_man-pages/man3/mktemp.3.html">mktemp</A>(3) 関数の場合と同様である。
<P>
<I>iolog_dir</I> と <I>iolog_file</I> を結合して作られるパスがすでに存在している場合は、
<I>iolog_file</I> が 6 個以上の X で終わっていないかぎり、
既存の入出力ログファイルは、サイズ 0 に短縮された上で、上書きされることになる。
<DT>lecture_status_dir<DD>
<B>sudo</B> はこのディレクトリに、
ユーザが訓戒を受けたかどうかを示すファイルを、ユーザごとに入れておく。
ユーザが訓戒を受けると、サイズ 0 のファイルがこのディレクトリに作成され、
<B>sudo</B> はそのユーザに再び訓戒を行わなくなる。このディレクトリは、
システムのブート時に<I>消去すべきではない</I>。
デフォルトは <I>/var/lib/sudo/lectured</I> である。
<DT>mailsub<DD>
<I>mailto</I> ユーザに送付するメールの件名。
エスケープ文字 %h はマシンのホスト名に展開される。
デフォルトは「*** SECURITY information for %h ***」である。
<DT>noexec_file<DD>
<B>sudo</B> バージョン 1.8.1 以来、このオプションはサポートされていない。
現在では、noexec ファイルのパスは <A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルで設定するべきである。
<DT>pam_login_service<DD>
<BR>

PAM を認証に使用しているシステムでは、このオプションの値が、
<B>sudo</B> コマンドに <B>-i</B> オプションが指定されたとき使用されるサービス名になる。
デフォルトの値は、
&quot;sudo&quot; である。<I>pam_service</I> の説明もご覧いただきたい。
<P>
この設定は、バージョン 1.8.8 以上でのみサポートされている。
<DT>pam_service<DD>
PAM を使用しているシステムでは、このオプションで指定するサービス名が、
適用される PAM ポリシーを指定することになる。サービス名は <I>pam.conf</I>
ファイル中のエントリ名や、<I>/etc/pam.d</I> にあるファイル名に対応している。
デフォルトの値は &quot;sudo&quot; である。
<P>
この設定は、バージョン 1.8.8 以上でのみサポートされている。
<DT>passprompt<DD>
パスワードを要求するときに使用するデフォルトのプロンプト。
<B>-p</B> オプションや環境変数 SUDO_PROMPT によって変更することができる。
以下のパーセント ('%') エスケープシーケンスが使用できる。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT>%H<DD>
ドメイン名付きのローカルホスト名に展開される (マシンのホスト名が完全修飾名か、
<I>fqdn</I> オプションがセットされている場合のみ)。

<DT>%h<DD>
ドメイン名なしのローカル・ホスト名に展開される。
<DT>%p<DD>
パスワードを要求されているユーザ名に展開 (<I>sudoers</I> ファイルの
<I>rootpw</I>, <I>targetpw</I>, <I>runaspw</I> フラグを尊重する)。
<DT>%U<DD>
変身対象ユーザの (デフォルトでは root) ログイン名に展開。
<DT>%u<DD>
<B>sudo</B> を実行するユーザーのログイン名に展開される。
<DT>%%<DD>
連続した二個の % は、一個の % 文字そのものを意味する。
</DL>
<P>

デフォルトの値は「Password:」である。
</DL>

<DL COMPACT>
<DT>role<DD>
コマンドの実行に当たって
SELinux の新しいセキュリティ・コンテキストを構成するときに使用する、
デフォルトのロール。デフォルトのロールは、
<I>sudoers</I> ファイルや、コマンドラインオプションを使って、
コマンドごとに変更することができる。このオプションが利用できるのは、
<B>sudo</B> が SELinux サポートつきでビルドされたときだけである。
<DT>runas_default<DD>
コマンドラインで <B>-u</B> オプションが指定されていないときの、
デフォルトの変身対象ユーザ。デフォルトでは root になっている。
<DT>syslog_badpri<DD>
ユーザが認証に失敗したときに使用する syslog の重大度 (priority)。
デフォルトでは alert になっている。
<P>
syslog の重大度には、次のものが指定できる。<B>emerg</B>, <B>alert</B>,
<B>crit</B>, <B>err</B>, <B>warning</B>, <B>notice</B>, <B>info</B>, <B>debug</B>。
<DT>syslog_goodpri<DD>
ユーザが認証に成功したときに使用する syslog の重大度 (priority)。
デフォルトでは notice になっている。
<P>
どんな syslog の重大度が指定できるかについては、
<I>syslog_badpri</I> を参照。
<DT>sudoers_locale<DD>
sudoers ファイルを解析したり、コマンドのログを記録したり、
email を送付したりするときに使用するロケール。
ロケールの変更は、sudoers の解釈に影響があるかもしれないので、
気をつけていただきたい。デフォルトでは &quot;C&quot; になっている。
<DT>timestampdir<DD>
<B>sudo</B> がタイムスタンプ・ファイルを置くディレクトリ。
このディレクトリは、システムがリブートするとき、クリアされるべきである。
デフォルトは <I>/var/run/sudo/ts</I> になっている。
<DT>timestampowner<DD>
ユーザが訓戒を受けたかどうかを示すファイルを入れておくディレクトリや、
タイムスタンプ・ディレクトリ、
及びそうしたディレクトリに置かれるすべてのファイルの所有者。
デフォルトは root である。
<DT>type<DD>
コマンドの実行に当たって
SELinux の新しいセキュリティ・コンテキストを構成するときに使用する、
デフォルトのタイプ。デフォルトのタイプは、
<I>sudoers</I> ファイルや、コマンドラインオプションを使って、
コマンドごとに変更することができる。このオプションが利用できるのは、
<B>sudo</B> が SELinux サポートつきでビルドされたときだけである。
</DL>
<P>

<B>真偽値としても使用できる文字列</B>:
<DL COMPACT>
<DT>env_file<DD>
<I>env_file</I> オプションでは、
実行するプログラムの環境に設定する変数を記載したファイルの絶対パスを指定する。
このファイルに記載する項目は、&quot;VARIABLE=value&quot; か &quot;export VARIABLE=value&quot;
の形でなければならない。変数の値をシングルクォートやダブルクォートで囲んでもよい。
このファイルに含まれる変数は、<I>env_keep</I> や <I>env_check</I> のような
<B>sudo</B> のほかの環境設定の影響を受ける。
<DT>exempt_group<DD>
このグループのユーザはパスワードの入力や <I>secure_path</I> などによる
PATH の限定を免除される。指定するグループ名に接頭辞の % を付けてはいけない。
このオプションはデフォルトではセットされていない。
<DT>group_plugin<DD>
このオプションの値となる文字列には、
<B>sudoers</B> が使用するグループ・プラグインと、必要ならその引き数を指定する。
値となる文字列は、プラグインのパスに続けて、その設定に必要な引き数があれば、
それを付け加えたものだが、パスは絶対パスか、
<I>/usr/local/libexec/sudo</I> を基点とする相対パスにするべきである。
引き数が存在するなら、それはプラグインの初期化関数に渡される。
引き数が存在する場合は、文字列全体をダブルクォート (&quot;&quot;) で囲まなければならない。
<P>
詳細については、
「グループ・プロバイダー・プラグイン」セクションををご覧いただきたい。
<DT>lecture<DD>
<B>sudo</B> はパスワードプロンプトに添えて簡単な訓戒を表示することができる。
このオプションはその訓戒をいつ表示するかを決定する。以下の値が可能である。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT>always<DD>
いつでも必ず訓戒を表示する。

<DT>never<DD>
訓戒をまったく表示しない。
<DT>once<DD>
ユーザがはじめて <B>sudo</B> を実行したときだけ表示する。
</DL>
<P>

値を指定しないと、<I>once</I> を指定したことになる。頭に '!' を付けて、
このオプションを否定すると、値に <I>never</I> が使用される。
デフォルトの値は <I>once</I> である。
</DL>

<DL COMPACT>
<DT>lecture_file<DD>
標準の訓戒とは別の <B>sudo</B> の訓戒を書き込んだファイルのパス。
指名したファイルが存在すれば、<B>sudo</B> は標準の訓戒の代わりに、それを使用する。
デフォルトでは、プログラムに埋め込まれた訓戒が使用される。
<DT>listpw<DD>
このオプションは、<B>sudo</B> を <B>-l</B> オプション付きで実行したとき、
ユーザがパスワードを要求されるのは、どんな場合かを決定する。
以下の値が可能である。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT>all<DD>
パスワードを入力しないですむためには、
<I>sudoers</I> ファイルの使用中のホストに対する当該ユーザのエントリのすべてに
NOPASSWD タグが設定されていなければならない。

<DT>always<DD>
ユーザは <B>-l</B> オプションを使用する際に、必ずパスワードを入力しなければならない。
<DT>any<DD>
パスワードを入力しないですむためには、
<I>sudoers</I> ファイルの使用中のホストに対する当該ユーザのエントリの少なくとも一つに
NOPASSWD タグが設定されていなければならない。
<DT>never<DD>
ユーザは <B>-l</B> オプションを使用する際に、パスワードを入力する必要がまったくない。
</DL>
<P>

値を指定しないと、値は <I>any</I> だと見なされる。'!' を頭に付けて、
このオプションを否定すると、値に <I>never</I> が使われることになる。
デフォルトは <I>any</I> である。
</DL>

<DL COMPACT>
<DT>logfile<DD>
<B>sudo</B> 独自のログファイルのパス (syslog 経由のログファイルではない)。
パスを指定すると、独自ファイルへのロギングが on になり、
'!' を頭に付けて、このオプションを否定すると、off になる。
デフォルトでは、<B>sudo</B> は syslog 経由でログを取る。
<DT>mailerflags<DD>
メーラを起動するときに使用するフラグ。デフォルトは <B>-t</B> になっている。
<DT>mailerpath<DD>
警告メールの送信に使用するメール・プログラムのパス。
デフォルトは configure したときに見つかった sendmail のパス。
<DT>mailfrom<DD>
警告メールやエラー・メールを送るとき、差出人として使用するアドレス。
<B>sudo</B> が @ 記号を解釈しないように、
アドレスはダブルクォート (&quot;&quot;) で囲むべきである。
デフォルトは、<B>sudo</B> を実行しているユーザの名前。
<DT>mailto<DD>
警告メールやエラー・メールを送付する宛先のアドレス。
<B>sudo</B> が @ 記号を解釈しないように、
アドレスはダブルクォート (&quot;&quot;) で囲むべきである。
デフォルトは root になっている。
<DT>secure_path<DD>
<B>sudo</B> から実行されるあらゆるコマンドが使用するパス。
<B>sudo</B> を実行するユーザが、無難な PATH 環境変数 を使っているかどうか確信が持てないなら、
このオプションを使用するとよいだろう。もう一つの使用法は、
「root のパス」と「一般ユーザのパス」を別のものにしておきたい場合だ。
ユーザが <I>exempt_group</I> オプションで指定したグループに属していると、
そのユーザは <I>secure_path</I> の影響を受けない。
このオプションは、デフォルトではセットされていない。
<DT>syslog<DD>
syslog を使ってログを取っている場合の syslog のファシリティ
(syslog 経由でログを取らないなら、'!' を頭に付けて、
このオプションを否定する)。デフォルトでは authpriv になっている。
<P>
syslog のファシリティには、次のものが指定できる。
<B>authpriv</B> (使用 OS が対応している場合), <B>auth</B>, <B>daemon</B>, <B>user</B>,
<B>local0</B>, <B>local1</B>, <B>local2</B>, <B>local3</B>, <B>local4</B>, <B>local5</B>,
<B>local6</B>, <B>local7</B>。
<DT>verifypw<DD>
このオプションは、<B>sudo</B> を <B>-v</B> オプション付きで実行したとき、
ユーザがパスワードを要求されるのは、どんな場合かを決定する。
以下の値が可能である。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT>all<DD>
パスワードを入力しないですむためには、
<I>sudoers</I> ファイルの使用中のホストに対する当該ユーザのエントリのすべてに
NOPASSWD タグが設定されていなければならない。

<DT>always<DD>
ユーザは <B>-v</B> オプションを使用する際に、必ずパスワードを入力しなければならない。
<DT>any<DD>
パスワードを入力しないですむためには、
<I>sudoers</I> ファイルの使用中のホストに対する当該ユーザのエントリの少なくとも一つに
NOPASSWD タグが設定されていなければならない。
<DT>never<DD>
ユーザは <B>-v</B> オプションを使用する際に、パスワードを入力する必要がまったくない。
</DL>
<P>

値を指定しないと、値は <I>all</I> だと見なされる。'!' を頭に付けて、
このオプションを否定すると、値に <I>never</I> が使われることになる。
デフォルトは <I>all</I> である。
</DL>

<P>

<B>真偽値としても使用できるリスト</B>:
<DL COMPACT>
<DT>env_check<DD>
「安全」だと見なされない場合に、ユーザの環境から取り除かれる環境変数。
TZ 以外のすべての環境変数について、「安全」というのは、変数の値に
'%' や '/' という文字を一つも含まないことである。この動作を利用すれば、
出来のよくないプログラムに見られる
printf 形式のフォーマットの脆弱性に対処することが可能になる。
TZ 変数については、以下のどれかが真ならば、安全ではないと見なされる。
</DL>
<P>

<DL COMPACT><DT><DD>

<DL COMPACT>
<DT><B>&bull;</B><DD>
変数の値が絶対パス名であり (コロン (':') が先頭に付いていることもある)、
それが <I>zoneinfo</I> ディレクトリの位置にマッチしない。

<DT><B>&bull;</B><DD>
変数の値に <I>..</I> というパスの要素が存在する。
<DT><B>&bull;</B><DD>
変数の値にホワイトスペースや表示不能文字が存在する。
<DT><B>&bull;</B><DD>
変数の値が PATH_MAX の値より長い。
</DL>
<P>

このオプションの引き数は、ダブルクォートで囲まれ、
スペースで区切られたリストでもよく、
ダブルクォートなしの単一の値でもよい。リストは、=, +=, -=, !
演算子を使って、それぞれ置き換えたり、追加したり、削除したり、
無効にしたりすることができる。<I>env_check</I> で指定された変数は、
<I>env_reset</I> オプショの有効・無効にかかわらず、上記のチェックにパスすれば、
環境に保存されることになる。チェックされる環境変数のグローバルなリストは、
root ユーザが <B>sudo</B> に <B>-V</B> オプションを付けて実行したときに表示される。
</DL>

<DL COMPACT>
<DT>env_delete<DD>
<I>env_reset</I> オプションが無効になっているときに、
ユーザの環境から取り除かれる環境変数。このオプションの引き数は、
ダブルクォートで囲まれ、スペースで区切られたリストでもよく、
ダブルクォートなしの単一の値でもよい。
リストは、=, +=, -=, ! 演算子を使って、それぞれ置き換えたり、追加したり、
削除したり、無効にしたりすることができる。
取り除かれる環境変数のグローバルなリストは、root ユーザが <B>sudo</B> に
<B>-V</B> オプションを付けて実行したときに表示される。
なお、オペレーティングシステムには、危険をもたらしかねない変数を、
いかなる setuid プロセス (<B>sudo</B> もその一つ)
の環境からも取り除くことにしているものが多いことに留意してほしい。
<DT>env_keep<DD>
<I>env_reset</I> オプションが有効になっているときでも、
ユーザの環境にそのまま保存される環境変数。このオプションによって、
<B>sudo</B> から生み出されるプロセスが受け取る環境を、
きめ細かく制御することが可能になる。このオプションの引き数は、
ダブルクォートで囲まれ、スペースで区切られたリストでもよく、
ダブルクォートなしの単一の値でもよい。
リストは、=, +=, -=, ! 演算子を使って、
それぞれ置き換えたり、追加したり、削除したり、無効にしたりすることができる。
保存される変数のグローバルなリストは、root ユーザが <B>sudo</B> に
<B>-V</B> オプションを付けて実行したときに表示される。
</DL>
<A NAME="lbAU">&nbsp;</A>
<H2>グループ・プロバイダー・プラグイン</H2>

<B>sudoers</B> プラグインは、non-Unix グループの検索を可能にするために、
補助的なプラグインに対するインターフェースを備えており、それによって、
標準的な Unix グループ・データベース以外のグループ情報源に対する問い合わせができるようになっている。
先に述べたような、non-Unix グループを指定する書式の使用を可能にしたかったら、
この仕組みが使用できる。
<P>

グループ・プロバイダー・プラグインは、デフォルト設定の <I>group_plugin</I>
によって指定する。<I>group_plugin</I> に対する引き数は、プラグインのパスに続けて、
その設定に必要なオプションがあれば、それを付け加えたものだが、
パスは絶対パスか、<I>/usr/local/libexec/sudo</I>
を基点とする相対パスにするべきである。そうしたオプションは (指定されていれば)
プラグインの初期化関数に渡されることになる。オプションがある場合は、
文字列全体をダブルクォート (&quot;&quot;) で囲まなければならない。
<P>

以下のグループ・プロバイダー・プラグインがデフォルトでインストールされている。
<DL COMPACT>
<DT>group_file<DD>
<I>group_file</I> プラグインは、<I>/etc/group</I> の代わりに、
<I>/etc/group</I> と同じ書式を使用する別のグループファイルを使えるようにする。
プラグインに対するオプションとして、グループファイルのパスを指定するべきである。
たとえば、使用するグループファイルが <I>/etc/sudo-group</I> ならば、
次のように書くことになる。
<PRE>

<DL COMPACT><DT><DD>Defaults group_plugin=&quot;group_file.so /etc/sudo-group&quot;
</DL>
</PRE>

<DT>system_group<DD>
<I>system_group</I> プラグインは、標準 C ライブラリの関数 <B>getgrnam</B>() と
<B>getgrid</B>() によるグループ検索をサポートしている。このプラグインは、
ユーザがそのユーザの補助グループのリストに存在しないグループに所属しているといった場合にも使用できる。
このプラグインはオプションを取らないので、書式は次のようになる。
<PRE>

<DL COMPACT><DT><DD>Defaults group_plugin=system_group.so
</DL>
</PRE>

</DL>
<P>

グループ・プロバイダー・プラグインの API については、sudo_plugin(5)
に詳細な説明がある。
<A NAME="lbAV">&nbsp;</A>
<H2>ログの書式</H2>

<B>sudoers</B> は、何が起きたかを記録するのに、<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) を使用することもできるし、
単独のログ・ファイルを使用することもできる。
どちらの場合も、ログの書式はほとんど同じである。
<A NAME="lbAW">&nbsp;</A>
<H3>実行を許可されたコマンドに関するログ記載事項</H3>

sudo が実行したコマンドは、次の書式を使って記録される
(読みやすいように、ここでは複数行に分けている)。
<PRE>

<DL COMPACT><DT><DD>date hostname progname: username : TTY=ttyname ; PWD=cwd ; \
    USER=runasuser ; GROUP=runasgroup ; TSID=logid ; \
    ENV=env_vars COMMAND=command
</DL>
</PRE>

<P>

各フィールドは以下のようになっている。
<DL COMPACT>
<DT>date<DD>
コマンドが実行された日時。たいていは、&quot;MMM, DD, HH:MM:SS&quot; の形式である。
<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でロギングしている場合に、
日時が実際にどんな形式になるかを決めるのは、syslog デーモンである。
<B>sudo</B> 独自のファイルにロギングしているとき、
<I>log_year</I> オプションが有効だと、日時に年度も含まれることになる。
<DT>hostname<DD>
<B>sudo</B> が実行されたホストの名前。このフィールドは、
<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でロギングしているときにのみ存在する。
<DT>progname<DD>
プログラム名。普通は、<I>sudo</I> か <I>sudoedit</I>。このフィールドは、
<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でロギングしているときのみ存在する。
<DT>username<DD>
<B>sudo</B> を実行したユーザのログイン名。
<DT>ttyname<DD>
<B>sudo</B> が実行された端末の短縮名
(たとえば、&quot;console&quot;, &quot;tty01&quot;, &quot;pts/0&quot; など)。端末が存在しなかった場合は、
&quot;unknown&quot; になる。
<DT>cwd<DD>
<B>sudo</B> が実行されたカレント・ワーキング・ディレクトリ。
<DT>runasuser<DD>
変身対象ユーザ。
<DT>runasgroup<DD>
変身対象グループがコマンドラインで指定されていれば、そのグループ。
<DT>logid<DD>
入出力ログの識別名。コマンドの出力を再生するときに使用できる。
このフィールドは、<I>log_input</I> や <I>log_output</I>
オプションが有効なときにのみ存在する。
<DT>env_vars<DD>
環境変数がコマンドラインで指定された場合、そのリスト。
<DT>command<DD>
実行された実際のコマンド。
</DL>
<P>

メッセージは <I>sudoers_locale</I> で指定されたロケールを使って記録される。
デフォルトは &quot;C&quot; である。
<A NAME="lbAX">&nbsp;</A>
<H3>実行を拒否されたコマンドに関するログ記載事項</H3>

ユーザがコマンドの実行を認められなかった場合、
拒否された理由が、ユーザ名の後に記録されることになる。
理由として挙げられるものには、次のようなものがある。
<DL COMPACT>
<DT>user NOT in sudoers<DD>
そのユーザに関する記載が <I>sudoers</I> ファイルに存在しない。
<DT>user NOT authorized on host<DD>
そのユーザに関する記載が <I>sudoers</I> ファイルに存在するが、
このホストではコマンドの実行を許可されていない。
<DT>command not allowed<DD>
このホストに対するそのユーザの記載が <I>sudoers</I> ファイルに存在するが、
指定されたコマンドの実行を許可されていない。
<DT>3 incorrect password attempts<DD>
ユーザがパスワードの入力に 3 回失敗した。実際に書き込まれる試行回数は、
失敗した回数と <I>passwd_tries</I> オプションの値によって様々である。
<DT>a password is required<DD>
<B>sudo</B> に <B>-n</B> オプションを指定したが、パスワードが必要だった。
<DT>sorry, you are not allowed to set the following environment variables<DD>
ユーザがコマンドラインで環境変数を指定したが、
それは <I>sudoers</I> によって許可されていない。
</DL>
<A NAME="lbAY">&nbsp;</A>
<H3>エラーに関するログ記載事項</H3>

エラーが起きると、<B>sudoers</B> はメッセージをログに記録し、たいていの場合は、
管理者に email で報告する。起きるかもしれないエラーには次のものがある。
<DL COMPACT>
<DT>parse error in /etc/sudoers near line N<DD>
<B>sudoers</B> が上記ファイルの解析中にエラーに出会った。
エラーのタイプによっては、実際のエラーは、記載された行番号より 1 行上、
あるいは、1 行下にあることもある。
<DT>problem with defaults entries<DD>
<I>sudoers</I> ファイル中に意味不明なデフォルト設定 (Defaults setting) が、
一つ以上ある。このエラーがあっても、<B>sudo</B> が実行できなくなることはないが、
<B>visudo</B> を使って <I>sudoers</I> ファイルをチェックするべきである。
<DT>timestamp owner (username): No such user<DD>
<I>timestampowner</I> オプションで指定されたタイムスタンプ・ディレクトリの所有者が、
パスワード・データベースに存在しなかった。
<DT>unable to open/read /etc/sudoers<DD>
<I>sudoers</I> ファイルを読み込もうとしたが、オープンできなかった。
そうしたことは、<I>sudoers</I> ファイルがリモート・ファイルシステムに存在して、
そこではユーザ ID 0 を別の値にマップしている場合に起きることがある
(訳注: たとえば、NFS で root_squash が有効な場合)。
通常 <B>sudoers</B> は、この問題を回避するために、グループのパーミッションを使って
<I>sudoers</I> ファイルをオープンしようとする。
<I>/etc/sudoers</I> の所有権を変更するなり、
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルの <B>sudoers</B> Plugin 行の末尾に &quot;sudoers_uid=N&quot;
('N' は、<I>sudoers</I> ファイルの所有者のユーザ ID)
といった引き数を追加するなりを、考慮すべきである。
<DT>unable to stat /etc/sudoers<DD>
<I>/etc/sudoers</I> ファイルが見つからない。
<DT>/etc/sudoers is not a regular file<DD>
<I>/etc/sudoers</I> は存在するが、通常ファイルでもシンボリック・リンクでもない。
<DT>/etc/sudoers is owned by uid N, should be 0<DD>
<I>sudoers</I> ファイルの所有者が適切ではない。
<I>sudoers</I> ファイルの所有者を変更したい場合には、<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルの
<B>sudoers</B> Plugin 行に &quot;sudoers_uid=N&quot; ('N' は、
<I>sudoers</I> ファイルの所有者のユーザ ID) を付け加えていただきたい。
<DT>/etc/sudoers is world writable<DD>
<I>sudoers</I> ファイルのパーミッションがすべてのユーザに書き込みを許している。
<I>sudoers</I> ファイルは、誰にでも書き込み可であってはならず、
デフォルトのファイルモードは 0440 である (所有者とグループのみ読むことができ、
書き込み権限は誰にもない)。デフォルトのモードは、<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルの
<B>sudoers</B> Plugin 行に &quot;sudoers_mode&quot;
オプションを指定することで変更することができる。
<DT>/etc/sudoers is owned by gid N, should be 1<DD>
<I>sudoers</I> ファイルの所有グループが適切ではない。
<I>sudoers</I> ファイルの所有グループを変更したい場合には、
<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルの <B>sudoers</B> Plugin 行に &quot;sudoers_gid=N&quot;
('N' は、<I>sudoers</I> ファイルの所有グループ ID) を付け加えていただきたい。
<DT>unable to open /var/run/sudo/ts/username<DD>
<B>sudoers</B> がユーザのタイムスタンプ・ファイルを読み込んだり、
作成したりすることができなかった。そうしたことは、
<I>timestampowner</I> が root 以外のユーザに設定されていて、
しかも <I>/var/run/sudo</I> のモードが、
グループやその他のユーザに対して検索不可になっている場合に起きることがある。
<I>/var/run/sudo</I> のデフォルトのモードは、0711 である。
<DT>unable to write to /var/run/sudo/ts/username<DD>
<B>sudoers</B> がユーザのタイムスタンプ・ファイルに書き込むことができなかった。
<DT>/var/run/sudo/ts is owned by uid X, should be Y<DD>
タイムスタンプ・ディレクトリの所有者が <I>timestampowner</I> 以外のユーザである。
そうしたことは、<I>timestampowner</I> の値を変更した時に起きることがある。
<B>sudoers</B> は、ディレクトリの所有者が訂正されるまで、
タイムスタンプ・ディレクトリを無視することになる。
<DT>/var/run/sudo/ts is group writable<DD>
タイムスタンプ・ディレクトリがグループによって書き込み可能になっている。
書き込みが可能なのは、<I>timestampowner</I> のみにするべきだ。
タイムスタンプ・ディレクトリのデフォルトのモードは、700 である。
<B>sudoers</B> は、ディレクトリのモードが訂正されるまで、
タイムスタンプ・ディレクトリを無視することになる。
</DL>
<A NAME="lbAZ">&nbsp;</A>
<H3>syslog 経由でロギングするときの注意点</H3>

デフォルトでは、<B>sudoers</B> は <A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でメッセージをログに記録する。
その場合、<I>date</I>, <I>hostname</I>, <I>progname</I> フィールドをログに付加するのは、
syslog デーモンであって、<B>sudoers</B> ではない。
従って、そうしたフィールドは、システムが違えば書式も違うかもしれない。
<P>

ほとんどのシステムで、<A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) は、かなり小さなログ・バッファしか持っていない。
そこで、コマンドライン引き数の後ろの方が切り捨てられたりしないように、
<B>sudoers</B> は、(date, hostname, 及び &quot;sudo&quot; という文字列を別にして)
ログ・メッセージが 960 字以上になると、それを分割するようになっている。
メッセージが分割される場合、後続部分では、
ユーザ名の後ろに &quot;(command continued)&quot; という文字列が続き、
その後にコマンドライン引き数の残りが続くことになる。
<A NAME="lbBA">&nbsp;</A>
<H3>ファイルにロギングするときの注意点</H3>

<I>logfile</I> オプションを設定すると、<B>sudoers</B> は <I>/var/log/sudo</I>
といったローカルなファイルにログを記録するようになる。ファイルにロギングする場合も、
<B>sudoers</B> は <A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) とほとんど同じ書式を使用するが、
いつくかの重要な違いがある。
<DL COMPACT>
<DT>1.<DD>
<I>progname</I> と <I>hostname</I> フィールドは存在しない。
<DT>2.<DD>
<I>log_year</I> オプションが有効な場合、日付には年度も含まれることになる。
<DT>3.<DD>
<I>loglinelen</I> (デフォルトでは 80) 文字よりも長い行は改行され、
4 文字分のインデントを付けて次の行に続くことになる。
そうすることで、記述情報が人間に読みやすくなるが、
ログファイルに対して <A HREF="../../GNU_grep/man1/grep.1.html">grep</A>(1) を使用することは難しくなる。
<I>loglinelen</I> オプションに 0 を指定すると
(あるいは、頭に '!' をつけて、否定すると)、改行は行われなくなる。
</DL>
<A NAME="lbBB">&nbsp;</A>
<H2>入出力ログファイル</H2>

入出力ロギングを有効にすると、<B>sudo</B> は擬似 tty でコマンドを実行して、
ユーザのすべての入力や出力のログを取ることになる。
入出力は、<I>iolog_dir</I> オプションで指定したディレクトリに
(デフォルトでは <I>/var/log/sudo-io</I>)、
一意なセッション ID を使って記録される。
このセッション ID は、(訳注: syslog 経由であれ、独自ファイルであれ)
<B>sudo</B> に関するログの行に、&quot;TSID=&quot; に続く値として書き込まれているものだ。
<I>iolog_file</I> オプションを使えば、
セッション ID の形式を変更することができる。
<P>

各入出力ログは、独立したディレクトリに収納される。
そうしたディレクトリには、次のようなファイルが入っている。
<DL COMPACT>
<DT><I>log</I><DD>
次のような情報を含むテキストファイル。コマンドが実行された日時、
<B>sudo</B> を実行したユーザの名前、変身対象ユーザ名、変身対象グループ名 (ないこともある)、
<B>sudo</B> が実行された端末、その端末の縦横のサイズ (何行何桁か)、
コマンドがそこから実行されたカレントディレクトリ、
それに、コマンドそのもののパス名 (引き数があれば、それも)
<DT><I>timing</I><DD>
入出力ログに記録される各事項間の時間間隔と各事項の入出力バイト数のログ
(セッションの再生で使用される)
<DT><I>ttyin</I><DD>
ユーザが使用している端末からの入力 (ユーザがタイプしたこと)。
<DT><I>stdin</I><DD>
パイプやファイルからの入力
<DT><I>ttyout</I><DD>
擬似 tty の出力 (コマンドがスクリーンに書き出したこと)
<DT><I>stdout</I><DD>
パイプへ出力されたり、ファイルにリダイレクトされた標準出力
<DT><I>stderr</I><DD>
パイプへ出力されたり、ファイルへリダイレクトされた標準エラー
</DL>
<P>

<I>log</I> 以外のすべてのファイルは、<I>compress_io</I> オプションが無効になっていないかぎり、
gzip 形式で圧縮される。バッファリングを行うので、入出力のデータは、
<B>sudo</B> コマンドが完了するまで、完全なものにはならない。
入出力ログファイルの出力の部分は、<A HREF="../man8/sudoreplay.8.html">sudoreplay</A>(8) を使って再生することができる。
また、<A HREF="../man8/sudoreplay.8.html">sudoreplay</A>(8) ユーティリティは、利用できるログをリスト表示したり、
検索したりするのに使うこともできる。
<P>

ユーザの入力には、パスワードのような (たとえ、
画面にエコーされることはないにしても) 秘密情報が含まれていることがある。
そういった情報も、暗号化されずに、ログファイルに記録されることに注意していただきたい。
たいていの場合、<I>log_output</I> や LOG_OUTPUT を使って、
コマンドの出力をログに記録するだけで十分用が足りる。
<P>

入出力ログは、セッションごとに独立したディレクトリに収納される。
そのため、従来からあるログローテーション・ユーティリティを使用して、
保存しておく入出力ログ数を制限することはできない。
保存する入出力ログ数を制限する最も簡単な方法は、
<I>maxseq</I> オプションで保存したいログの最大数を指定することである。
入出力ログの連番が <I>maxseq</I> に達すると、連番は 0 にリセットされ、
<B>sudoers</B> は既存の入出力ログファイルをサイズ 0 に短縮して、再利用することになる。
<A NAME="lbBC">&nbsp;</A>
<H2>ファイル</H2>

<DL COMPACT>
<DT><I>/etc/sudo.conf</I><DD>
sudo フロントエンドの設定
<DT><I>/etc/sudoers</I><DD>
誰が何を実行できるかのリスト
<DT><I>/etc/group</I><DD>
ローカルのグループファイル
<DT><I>/etc/netgroup</I><DD>
ネットワークグループのリスト
<DT><I>/var/log/sudo-io</I><DD>
入出力のログファイル (訳注: 厳密には、
入出力のログを記録するファイル群をその下に格納するトップディレクトリ)
<DT><I>/var/run/sudo/ts</I><DD>
<B>sudoers</B> セキュリティポリシーが使用するタイムスタンプを格納するディレクトリ
<DT><I>/var/lib/sudo/lectured</I><DD>
<B>sudoers</B> セキュリティポリシーが使用する訓戒状態ファイルを格納するディレクトリ
<DT><I>/etc/environment</I><DD>
Linux や AIX で <B>-i</B> モードを使用するときの初期環境
</DL>
<A NAME="lbBD">&nbsp;</A>
<H2>用例</H2>

以下は <I>sudoers</I> ファイルの記載例である。
正直なところ、いささか凝りすぎの部分もある。
まず最初に継承を許可する環境変数をいくつか指定し、
続いて <I>aliases</I> の定義をする。
<PRE>

<DL COMPACT><DT><DD># sudo 経由で X アプリケーションを実行するとき、HOME は
# .Xauthority ファイルを探すために使用される。ほかのプログラムも
# 設定ファイルを探すのに HOME を使用するので、この指定が
# 権限の昇格を引き起こしかねないことに注意してほしい。
Defaults env_keep += &quot;DISPLAY HOME&quot;

# User alias の指定
User_Alias      FULLTIMERS = millert, mikef, dowdy
User_Alias      PARTTIMERS = bostley, jwfox, crawl
User_Alias      WEBMASTERS = will, wendy, wim

# Runas alias の指定
Runas_Alias     OP = root, operator
Runas_Alias     DB = oracle, sybase
Runas_Alias     ADMINGRP = adm, oper

# Host alias の指定
Host_Alias      SPARC = bigtime, eclipse, moet, anchor :\
                SGI = grolsch, dandelion, black :\
                ALPHA = widget, thalamus, foobar :\
                HPPA = boa, nag, python
Host_Alias      CUNETS = 128.138.0.0/255.255.0.0
Host_Alias      CSNETS = 128.138.243.0, 128.138.204.0/24, 128.138.242.0
Host_Alias      SERVERS = master, mail, www, ns
Host_Alias      CDROM = orion, perseus, hercules

# Cmnd alias の指定
Cmnd_Alias      DUMPS = /usr/bin/mt, /usr/sbin/dump, /usr/sbin/rdump,\
                        /usr/sbin/restore, /usr/sbin/rrestore,\
                        sha224:0GomF8mNN3wlDt1HD9XldjJ3SNgpFdbjO1+NsQ== \
                        /home/operator/bin/start_backups
Cmnd_Alias      KILL = /usr/bin/kill
Cmnd_Alias      PRINTING = /usr/sbin/lpc, /usr/bin/lprm
Cmnd_Alias      SHUTDOWN = /usr/sbin/shutdown
Cmnd_Alias      HALT = /usr/sbin/halt
Cmnd_Alias      REBOOT = /usr/sbin/reboot
Cmnd_Alias      SHELLS = /usr/bin/sh, /usr/bin/csh, /usr/bin/ksh,\
                         /usr/local/bin/tcsh, /usr/bin/rsh,\
                         /usr/local/bin/zsh
Cmnd_Alias      SU = /usr/bin/su
Cmnd_Alias      PAGERS = /usr/bin/more, /usr/bin/pg, /usr/bin/less
</DL>
</PRE>

<P>

以下では、コンパイル時に埋め込まれたデフォルト値のいくつかを変更している。
<B>sudo</B> には <A HREF="../../LDP_man-pages/man3/syslog.3.html">syslog</A>(3) 経由でログを記録し、
ファシリティにはすべての場合に <I>auth</I> を使用させたい。
フルタイムのスタッフには <B>sudo</B> の訓戒を出さないようにしたい。
ユーザ <B>millert</B> はパスワードを入力しないでよい。
コマンドを root として実行するときは、
環境変数 LOGNAME, USER, USERNAME を変更したくない。
さらに、<I>SERVERS</I> という Host_Alias に属するマシンでは、
ローカルなログファイルを副本として作り、
ログの記入事項は数年に渡って保存されるので、
ログの各行に間違いなく年度が入るようにする。
最後に <I>PAGERS</I> という Cmnd_Alias に属するコマンド
(<I>/usr/bin/more</I>, <I>/usr/bin/pg</I>, <I>/usr/bin/less</I>) については、
シェル・エスケープを無効にする。なお、最後の設定は、
許可するコマンドが ALL になっているユーザに対しては、
効果的な抑制にはならないことに注意していただきたい。
<PRE>

<DL COMPACT><DT><DD># built-in defaults の変更
Defaults                syslog=auth
Defaults&gt;root           !set_logname
Defaults:FULLTIMERS     !lecture
Defaults:millert        !authenticate
<A HREF="mailto:Defaults@SERVERS">Defaults@SERVERS</A>        log_year, logfile=/var/log/sudo.log
Defaults!PAGERS         noexec
</DL>
</PRE>

<P>

ユーザ設定が、誰が何を実行できるかを実際に決めている部分だ。
<PRE>

<DL COMPACT><DT><DD>root            ALL = (ALL) ALL
%wheel          ALL = (ALL) ALL
</DL>
</PRE>

<P>

<B>root</B> と <B>wheel</B> グループに属するすべてのユーザには、
どのホストでも任意のユーザとしていかなるコマンドでも実行することを認める。
<PRE>

<DL COMPACT><DT><DD>FULLTIMERS      ALL = NOPASSWD: ALL
</DL>
</PRE>

<P>

フルタイムのシステム管理者 (<B>millert</B>, <B>mikef</B>, <B>dowdy</B>) は、
どのホストでも任意のコマンドを認証なしで実行できる。
<PRE>

<DL COMPACT><DT><DD>PARTTIMERS      ALL = ALL
</DL>
</PRE>

<P>

パートタイムのシステム管理者 (<B>bostley</B>, <B>jwfox</B>, <B>crawl</B>) は、
どのホストでも任意のコマンドを実行できるが、その際に認証をしなければならない
(このエントリには NOPASSWD タグが指定されていないので)。
<PRE>

<DL COMPACT><DT><DD>jack            CSNETS = ALL
</DL>
</PRE>

<P>

ユーザ <B>jack</B> は、<I>CSNETS</I> というエイリアスに属するマシンで、
任意のコマンドを実行できる (すなわち、ネットワークが 128.138.243.0,
128.138.204.0, 128.138.242.0 のマシンだ)。この内、128.138.204.0 にのみ
class C のネットワークであることを示す明示的な (CIDR 表記の)
netmask がある。<I>CSNETS</I> のほかのネットワークについては、
ローカルマシンの netmask がマッチングの際に使われることになる。
<PRE>

<DL COMPACT><DT><DD>lisa            CUNETS = ALL
</DL>
</PRE>

<P>

ユーザ <B>lisa</B> は、エイリアスが <I>CUNETS</I> のいかなるホストでも、
任意のコマンドを実行することができる
(すなわち、128.138.0.0 という class B ネットワークのマシンだ)。
<PRE>

<DL COMPACT><DT><DD>operator        ALL = DUMPS, KILL, SHUTDOWN, HALT, REBOOT, PRINTING,\
                sudoedit /etc/printcap, /usr/oper/bin/
</DL>
</PRE>

<P>

ユーザ <B>operator</B> は、
簡単な保守管理に用途が限定されたコマンドを実行できる。この場合それは、
バックアップしたり、プロセスを kill したり、印刷システムを操作したり、
システムをシャットダウンしたりするのに関係するコマンドと、
<I>/usr/oper/bin/</I> ディレクトリにある任意のコマンドである。
注意: <I>DUMPS</I> という Cmnd_Alias に属するコマンドのひとつ、すなわち
<I>/home/operator/bin/start_backups</I> は、sha224 ダイジェスト付きである。
そうしているのは、そのスクリプトが置かれているディレクトリが
operator ユーザによって書き込み可能だからだ。スクリプトが変更された場合
(その結果、ダイジェストが一致しないことになる)、
<B>sudo</B> 経由でそのスクリプトを実行することはもはや不可能になる。
<PRE>

<DL COMPACT><DT><DD>joe             ALL = /usr/bin/su operator
</DL>
</PRE>

<P>

ユーザ <B>joe</B> は、<A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1) を使って operator になることしかできない。
<PRE>

<DL COMPACT><DT><DD>pete            HPPA = /usr/bin/passwd [A-Za-z]*, !/usr/bin/passwd root

%opers          ALL = (: ADMINGRP) /usr/sbin/
</DL>
</PRE>

<P>

<B>opers</B> グループのユーザは、<I>/usr/sbin/</I> にあるコマンドを、
自分自身の資格で、Runas_Alias <I>ADMINGRP</I> に属する任意のグループ
(すなわち、<B>adm</B> か <B>oper</B> グループ) として実行できる。
<P>

ユーザ <B>pete</B> は、<I>HPPA</I> に属するマシンで
root 以外なら誰のパスワードでも変更することを許されている。
コマンドライン引き数は、結合して一つの文字列にした上で、マッチングを行うので、
ワイルドカード '*' は、<I>複数の</I>単語とマッチすることになる。だから、
この例は、<A HREF="../../shadow/man1/passwd.1.html">passwd</A>(1) がコマンドラインで複数のユーザ名を受け付けないことを前提としているのである。
GNU のシステムでは、
<A HREF="../../shadow/man1/passwd.1.html">passwd</A>(1) に対するオプションをユーザ引き数の後ろに置くことができるのに注意していただきたい。
そのため、このルールは次のようなコマンドも許可してしまうことになる。
<PRE>

<DL COMPACT><DT><DD>passwd username --expire
</DL>
</PRE>

<P>

これは、望ましくないことかもしれない。
<PRE>

<DL COMPACT><DT><DD>bob             SPARC = (OP) ALL : SGI = (OP) ALL
</DL>
</PRE>

<P>

ユーザ <B>bob</B> は、<I>SPARC</I> や <I>SGI</I> に属するマシンで
Runas_Alias <I>OP</I>に登録されている任意のユーザとして
(<B>root</B> と <B>operator</B> である) どんなコマンドでも実行できる。
<PRE>

<DL COMPACT><DT><DD>jim             +biglab = ALL
</DL>
</PRE>

<P>

ユーザ <B>jim</B> は、<I>biglab</I> ネットグループに属するマシンで、
どんなコマンドでも実行できる。
<B>sudo</B> は、&quot;biglab&quot; に '+' の接頭辞が付いているので、
それをネットグループだと認識する。
<PRE>

<DL COMPACT><DT><DD>+secretaries    ALL = PRINTING, /usr/bin/adduser, /usr/bin/rmuser
</DL>
</PRE>

<P>

<B>secretaries</B> ネットグループのユーザは、ユーザの追加や削除はもちろん、
プリンタの管理にも協力する必要がある。
そこで、すべてのマシンでその種のコマンドの実行を認められている。
<PRE>

<DL COMPACT><DT><DD>fred            ALL = (DB) NOPASSWD: ALL
</DL>
</PRE>

<P>

ユーザ <B>fred</B> は、Runas_Alias <I>DB</I> の任意のユーザとして
(<B>oracle</B> か <B>sybase</B> だ)
パスワードを入力しないでもコマンドを実行することができる。
<PRE>

<DL COMPACT><DT><DD>john            ALPHA = /usr/bin/su [!-]*, !/usr/bin/su *root*
</DL>
</PRE>

<P>

ユーザ <B>john</B> は、<I>ALPHA</I> に属するマシンで <A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1) を使って
root 以外の誰にでもなることができるが、
su にオプションを指定することは許されていない。
<PRE>

<DL COMPACT><DT><DD>jen             ALL, !SERVERS = ALL
</DL>
</PRE>

<P>

ユーザ <B>jen</B> は、Host_Alias <I>SERVERS</I> に属するマシン
(master, mail, www, ns) を除くいかなるマシンでも、任意のコマンドを実行できる。
<PRE>

<DL COMPACT><DT><DD>jill            SERVERS = /usr/bin/, !SU, !SHELLS
</DL>
</PRE>

<P>

<B>jill</B> は、Host_Alias <I>SERVERS</I> のいかなるマシンでも
<I>/usr/bin/</I> ディレクトリにある任意のコマンドを実行できるが、
<I>SU</I> や <I>SHELLS</I> という Cmnd_Alias に属するコマンドは実行できない。
ルールのこのくだりでは特に言っていないが、
Cmnd_Alias <I>PAGER</I> のコマンドはすべて <I>/usr/bin</I> にあり、
<I>noexec</I> オプションが設定されている。
<PRE>

<DL COMPACT><DT><DD>steve           CSNETS = (operator) /usr/local/op_commands/
</DL>
</PRE>

<P>

ユーザ <B>steve</B> は、ディレクトリ <I>/usr/local/op_commands/</I>
にある任意のコマンドを実行できるが、
operator というユーザとして実行できるだけだ。
<PRE>

<DL COMPACT><DT><DD>matt            valkyrie = KILL
</DL>
</PRE>

<P>

<B>matt</B> も、自分用のワークステーション valkyrie で、
ハングしたプロセスの kill ぐらいはできる必要がある。
<PRE>

<DL COMPACT><DT><DD>WEBMASTERS      www = (www) ALL, (root) /usr/bin/su www
</DL>
</PRE>

<P>

ホスト www で User_Alias <I>WEBMASTERS</I> に属するいかなるユーザも
(will, wendy, wim だ)、ユーザ www (web ページの所有者)
として任意のコマンドを実行することができる。
単に <A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1) でユーザ www になってもよい。
<PRE>

<DL COMPACT><DT><DD>ALL             CDROM = NOPASSWD: /sbin/umount /CDROM,\
                /sbin/mount -o nosuid\,nodev /dev/cd0a /CDROM
</DL>
</PRE>

<P>

いかなるユーザも、Host_Alias が <I>CDROM</I> のマシンで
(orion, perseus, hercules)、パスワードを入力することなく
CD-ROM をマウント、アンマウントできる。
上記のコマンドを打ち込むのはユーザにとっていささか面倒なので、
シェルスクリプトとしてカプセル化してしまうのがよいだろう。
<DL COMPACT>
<DT>[<B>訳注</B>]:<DD>
注意していただきたいが、
<I>/etc/sudoers</I> ファイルに「user1 ALL = (ALL) ALL」といった設定を書いても、
user1 が <B>sudo</B> 経由であらゆるコマンドを実行できるようになるのは、
自ホスト、すなわち、その <I>/etc/sudoers</I> が存在するホストだけであって、
telnet や ssh で接続したホストで 
<B>sudo</B> 経由でコマンドを実行できるとはかぎらない。
他ホストの <B>sudo</B> は、自分のところにある <I>/etc/sudoers</I> 
ファイルしか参照しないからである。
<P>
それでは、何故、上記の「用例」で自ホスト以外の設定が行われているのだろうか？ 
そもそも、<I>sudoers</I> の書式で自ホスト以外のホストを指定できるのは、
何故なのか？ ホストに <B>ALL</B> を指定できるのは、何故なのか？ 
それは、管理しているサイトのすべてのホストの設定を記した 
<I>sudoers</I> ファイルを一つ作って、それをすべてのホストにコピーして使う、
そういった使い方を想定しているからだろう。昔の習慣の名残りかもしれない。
もし、サイト中のすべてのホストの設定を一ヶ所にまとめて置き、
それをすべてのホストに共有させたいのなら 
(すなわち、<I>sudoers</I> セキュリティポリシー設定の集中管理がしたいのなら)、
<B>LDAP</B> の採用を考えるべきである。
</DL>
<A NAME="lbBE">&nbsp;</A>
<H2>セキュリティに関する注意点</H2>

<A NAME="lbBF">&nbsp;</A>
<H3>'!' 演算子の限界</H3>

一般的に言って、演算子 '!' を使用して <B>ALL</B>
からコマンドの「引き算」をするのは、あまり効果的な方法ではない。
ユーザは実行したいコマンドを名前を変えてコピーし、
それからそれを実行するといった簡単な方法で、裏をかくことができるからだ。
たとえば、
<PRE>

<DL COMPACT><DT><DD>bill    ALL = ALL, !SU, !SHELLS
</DL>
</PRE>

<P>

という行は、<I>SU</I> や <I>SHELLS</I> に列記されているコマンドの <B>bill</B> による実行を、
本当に阻止することにはならない。なぜなら、<B>bill</B> としては、
そうしたコマンドを単に名前を変えてコピーすればよいし、
エディタなどのプログラムからシェル・エスケープを利用することもできるからだ。
だから、この種の制限はやった方がまし程度に考えておくべきである
(そして、しっかりした運用方針によって制限の実効力を上げるべきだ)。
<P>

一般に、もし ユーザに許可するコマンドに <B>ALL</B> が入っているならば、
ユーザが自分でプログラムを作って
(あるいは、シェルを自分専用に別の名前でコピーして)、
ルート・シェルを獲得するのを防ぐことはできない。
ユーザ設定でどんな項目に '!'  を付けようとも防止不可能である。
<A NAME="lbBG">&nbsp;</A>
<H3><I>fast_glob</I> の持つセキュリティ上の問題</H3>

<I>fast_glob</I> オプションが使われている場合、
パス名に glob 文字 (ワイルドカードとも言う)
が含まれるコマンドを確実に無効にすることは不可能である。その理由は、
C ライブラリの <A HREF="../../LDP_man-pages/man3/fnmatch.3.html">fnmatch</A>(3) 関数は、相対パスのパス名展開ができないからだ。
このことは、権限を許可するルールにとっては、
たいていの場合不便なだけにすぎないが、権限を減らしたり、
取り消したりするルールにとっては、セキュリティ上の問題をもたらしかねない。
<P>

たとえば、<I>sudoers</I> ファイルに次のエントリがあったとしよう。
<PRE>

<DL COMPACT><DT><DD>john    ALL = /usr/bin/passwd [a-zA-Z0-9]*, /usr/bin/chsh [a-zA-Z0-9]*,\
              /usr/bin/chfn [a-zA-Z0-9]*, !/usr/bin/* root
</DL>
</PRE>

<P>

それでも、<I>fast_glob</I> が有効になっていれば、<B>john</B> は
&quot;/usr/bin/passwd root&quot; を実行できてしまう。
<I>/usr/bin</I> に移動して、&quot;./passwd root&quot; を実行すればよいのだ。
<A NAME="lbBH">&nbsp;</A>
<H3>シェル・エスケープの防止</H3>

<B>sudo</B> があるプログラムを実行した場合、そのプログラムは、
ほかのプログラムの実行も含めて、何でも自由に好きなことができる。
このことがセキュリティ上の問題になりかねないのは、
プログラムがシェル・エスケープを許しているのは珍しいことではなく、
そのために、ユーザが <B>sudo</B>
のアクセス制御やロギングをすり抜けることが可能になるからだ。
よく使うプログラムでシェル・エスケープを許しているものには、
(当然ながら) シェル、エディタ、
ページャ、メーラ、ターミナルなどがある。
<P>

この問題に対処するには、基本的に二つの方法がある。
<DL COMPACT>
<DT>制限<DD>
ユーザに任意のコマンドの実行を許すようなコマンドに対して、
ユーザがアクセスできないようにする。
エディタの場合は、制限モード (restricted mode) と称して、
シェル・エスケープが使えないモードを持っているものも多い。
とは言え、<B>sudo</B> 経由でエディタを使うのなら、
<B>sudoedit</B> を使用する方がより優れた対策である。
シェル・エスケープを提供するプログラムはたくさんあるので、
それを提供しないプログラムのみを使用するようにユーザを制限するのは、
たいてい実現不可能である。
<DT>noexec<DD>
共有ライブラリをサポートしているシステムには、
環境変数 (たいていは LD_PRELOAD) で別の共有ライブラリを指定することによって、
デフォルトのライブラリ関数を置き換えることができるものが多い。
そういったシステムでは、<B>sudo</B> の <I>noexec</I> 機能を使えば、
<B>sudo</B> から実行されるプログラムが、
何かほかのプログラムを実行するのを防ぐことができる。
とは言え、これが当てはまるのは、
動的にリンクされたネイティブなプログラムだけだということに留意してほしい。
静的にリンクされたプログラムや、
バイナリ・エミュレーションのもとで動くほかの OS のプログラムには効果がない。
<P>
<I>noexec</I> 機能は SunOS, Solaris, *BSD, Linux, IRIX, Tru64 UNIX,
MacOS X, HP-UX 11.x、それに 5.3 以上の AIX で使えることがわかっている。
環境変数 LD_PRELOAD をサポートしているたいていのオペレーティングシステムが、
この機能に対応しているはずだ。
使用しているオペレーティングシステムのマニュアルページを調べて、
ダイナミック・リンカについて (通例 ld.so, ld.so.1, dyld, dld.sl, rld,
loader といった名前になっている) LD_PRELOAD
がサポートされているかどうか確認していただきたい。
<P>
あるコマンドに対して <I>noexec</I> を有効にするには、
上述の「ユーザ設定」セクションで解説したように、NOEXEC タグを使用する。
そのときの例を再掲しよう。
<PRE>

<DL COMPACT><DT><DD>aaron   shanty = NOEXEC: /usr/bin/more, /usr/bin/vi
</DL>
</PRE>

<DL COMPACT><DT><DD>
<P>
この例では、ユーザ <B>aaron</B> 対して、<I>noexec</I> を有効にした上で、
<I>/usr/bin/more</I> と <I>/usr/bin/vi</I> の実行を許可している。
このようにすれば、この二つのコマンドから (シェルのような)
ほかのコマンドを実行することができなくなるわけだ。使用しているシステムが
<I>noexec</I> に対応する能力があるかどうかよくわからない場合でも、
取りあえず試してみることなら、いつだってできる。<I>noexec</I> を有効にして、
シェル・エスケープが可能かどうか確かめてみればよいのだ。
</DL>

</DL>
<P>

注意してほしいが、シェル・エスケープの禁止は万能薬ではない。
root の権限で動いているプログラムには、ほかにも、危険性のあるさまざまな作業
(ファイルの属性を変更するとか、上書きしてしまうとか) が可能であり、
思いがけずに権限を拡大してしまうこともありえるのだ。特にエディタについて言うと、
ユーザには <B>sudoedit</B> を実行する許可を与えるのが、より安全な方法である
(下記参照)。
<A NAME="lbBI">&nbsp;</A>
<H3>安全な編集作業</H3>

<B>sudoers</B> プラグインでは <B>sudoedit</B> が使用できるようになっており、
ユーザは好みのエディタを使って、安全にファイルを編集することができる。
<B>sudoedit</B> は <B>sudo</B> の組み込みコマンドなので、
<I>sudoers</I> ファイル中で指定するときは、
頭にパスを付けてはいけない。ただし、コマンドライン引き数については、
通常のコマンドと全く同じように指定することができる。
<B>sudoedit</B> のコマンドライン引き数にワイルドカードを使用した場合は、
<B>sudoedit</B> の引き数にはパス名が来るはずなので、
ワイルドカードはフォワードスラッシュ ('/') にマッチしないようになっている。
<P>

<B>sudo</B> 経由で実行される他のコマンドとは違って、エディターは
<B>sudo</B> を起動するユーザの資格で、環境を変更せずに実行される。
詳しくは、<A HREF="../man8/sudo.8.html">sudo</A>(8) のマニュアルの <B>-e</B> オプションの説明をご覧になるとよい。
<P>

たとえば、ユーザ operator が &quot;message of the day&quot; ファイルを編集できるようにするには、<I>sudoers</I>
で次のように指定する。
<PRE>

<DL COMPACT><DT><DD>operator        ALL = sudoedit /etc/motd
</DL>
</PRE>

<P>

そして、ユーザ operator は、<B>sudoedit</B> を次のように実行する。
<PRE>

<DL COMPACT><DT><DD>$ sudoedit /etc/motd
</DL>
</PRE>

<P>

エディタは、root ではなく、ユーザ operator の資格で、<I>/etc/motd</I>
の作業用コピーに対して実行される。ファイルの編集が済むと、
<I>/etc/motd</I> は作業用コピーの内容で更新されることになる。
<P>

ユーザが書き込み権限を持っているディレクトリに存在するファイルに対して、
ファイル名を直接指定してであれ、ワイルドカードによって指定してであれ、
<B>sudoedit</B> を使って編集する許可をそのユーザに与えてはいけない。
もし、ユーザがディレクトリに対して書き込み権限を持っているならば、編集を許可されたファイルを、
別のファイルに対するリンクで置き換えることができるわけで、そうすることによって、
任意のどんなファイルでも編集できるようになってしまうからだ。
そうした事態を防ぐために、バージョン 1.8.16 以降の <B>sudoedit</B> では、
<I>sudoedit_checkdir</I> オプションが無効になっている場合や、
<B>sudoedit</B> を実行するユーザが root である場合を除いて、
ユーザが書き込み権限を持っているディレクトリに存在するいかなるシンボリックリンクも、
たどらないようになっている。
また、書き込み権限があるディレクトリに存在するファイルの編集を行うことも拒否する。
さらに、バージョン 1.8.15 以降の <B>sudoedit</B> では、
<I>sudoers</I> ファイルで <I>sudoedit_follow</I> オプションが有効になっているか、
<I>sudoedit</I> コマンドの前に FOLLOW タグが指定してあるかのどちらかでないかぎり、
シンボリックリンクをオープンしないようになっている。
<A NAME="lbBJ">&nbsp;</A>
<H3>タイムスタンプ・ファイルのチェック</H3>

<B>sudoers</B> は、タイムスタンプ・ディレクトリ (デフォルトでは
<I>/var/run/sudo/ts</I>) の所有者を調べて、所有者が root でなかったり、
root 以外のユーザにも書き込み可能であったりすると、
そのディレクトリの中身を無視する。古いバージョンの <B>sudo</B> は、
タイムスタンプ・ファイルを <I>/tmp</I> に置いていたが、
そうしたことは今では推奨できない。
特権を持たないユーザが自分の作ったファイルの所有者を変更できるシステムでは、
ユーザがタイムスタンプを自分で作成することが可能になるかもしれないからだ。
<P>

タイムスタンプ・ディレクトリは、
リブートしたときにその中身を<I>消去されるべき</I>だが、
すべてのシステムに <I>/var/run</I> ディレクトリが存在するとはかぎらない。
問題が起きるのを避けるために、<B>sudoers</B> は、
ブートタイムを参照できるシステムでは、
マシンがブートした時刻よりも古い日時を持つタイムスタンプ・ファイルを無視する。
<P>

グラフィカルなデスクトップ環境を持っているシステムの中には、
特権を持たないユーザにシステム・クロックの変更を許しているものがある。
<B>sudoers</B> は、タイムスタンプが有効か否を確認するのに、
システム・クロックを拠り所にしている。そこで、そうしたシステムでは、
ユーザがクロックを後戻りさせることで、<I>timestamp_timeout</I> よりも長い時間
<B>sudo</B> を実行することが可能になるかもしれない。そうした事態に対抗するため、
<B>sudoers</B> は、システムがサポートしているならば、
タイムスタンプに単調増加時計 (monotonic clock) を使用する
(単調増加時計は後戻りすることがないからだ)。
<P>

<B>sudoers</B> はあまりにも未来に設定されたタイムスタンプを認めない。
タイムスタンプが「現在時 + 2 * TIMEOUT」より新しい日時だった場合、
そのタイムスタンプは無視され、<B>sudoers</B> はログに記録して、警告を発する。
<P>

タイムスタンプ・ファイルはファイルシステム中に作られるものだから、
ユーザのログイン・セッションが終わっても残っている。
そのため、ユーザがログインし、認証を行ってから
<B>sudo</B> を使ってコマンドを実行し、一旦ログアウトして、再度ログインしたとき、
認証なしで <B>sudo</B> を実行することが可能になってしまうかもしれない。
タイムスタンプ・ファイルに記録されているタイムスタンプが 5 分以内のものであれば
(あるいは、<I>sudoers</I> ファイルで設定されているタイムアウト時間以内のものであれば)、
そういうことが可能かもしれないのだ。
<I>tty_tickets</I> オプションが有効な場合は、タイムスタンプの記録に、
ユーザが認証するときに使った端末のデバイス番号が含まれる。それよって、
tty ごとのきめ細かな管理が可能になるが、それでもタイムスタンプの記録が、
ユーザのセッションが終わった後まで有効である可能性もある。また、
タイムスタンプの記録には、最後に認証を行ったプロセスのセッション ID も含まれている。
別の端末セッションのプロセスが、同じタイムスタンプの記録を使えないようにしているのだ。
それはまた、ユーザがログアウトし、再度同じ端末にログインしたときに、
パスワードを入力することなしに <B>sudo</B> を実行できる可能性を減少させる役にも立っている。
<A NAME="lbBK">&nbsp;</A>
<H2>デバッギング</H2>

バージョン 1.8.4 以上の <B>sudoers</B> プラグインは、
デバッグのための柔軟な枠組みをサポートしており、問題が発生したときに、
プラグインの内部で何が起きているかを突き止めるために、
それを利用することができる。設定は <A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) ファイルで行うことが可能だ。
<P>

<B>sudoers</B> プラグインは、
フロントエンドである <B>sudo</B> と同じデバッグ・フラグの書式を使用する。
すなわち、<I>subsystem</I>@<I>priority</I> である。
<P>

<B>sudoers</B> が使用する priority (重大度) を深刻なものから挙げると、
<I>crit</I>, <I>err</I>, <I>warn</I>, <I>notice</I>, <I>diag</I>, <I>info</I>, <I>trace</I>,
<I>debug</I> である。ある priority を指定すると、
それより深刻なすべての priority も併せて指定したことになる。
たとえば、<I>notice</I> という priority を指定すれば、
<I>notice</I> レベル以上のデバッグメッセージがログに記録される。
<P>

<B>sudoers</B> では以下のサブシステムが使用できる。
<DL COMPACT>
<DT><I>alias</I><DD>
User_Alias, Runas_Alias, Host_Alias and Cmnd_Alias の処理
<DT><I>all</I><DD>
すべてのサブシステムにマッチする
<DT><I>audit</I><DD>
Solaris BSM (Basic Security Module) と Linux の監査コード
<DT><I>auth</I><DD>
ユーザの認証
<DT><I>defaults</I><DD>
<I>sudoers</I> ファイルの <I>Defaults</I> 設定
<DT><I>env</I><DD>
環境の取扱い
<DT><I>ldap</I><DD>
LDAP を使用する sudoers
<DT><I>logging</I><DD>
ロギングのサポート
<DT><I>match</I><DD>
<I>sudoers</I> ファイルにおけるユーザ、グループ、ホスト、ネットグループのマッチング
<DT><I>netif</I><DD>
ネットワークインターフェースの取扱い
<DT><I>nss</I><DD>
<B>sudoers</B> におけるネームサービス・スイッチの取扱い
<DT><I>parser</I><DD>
<I>sudoers</I> ファイルの解析
<DT><I>perms</I><DD>
パーミッションの設定
<DT><I>plugin</I><DD>
プラグインにとって <I>main</I> に相当する
<DT><I>pty</I><DD>
擬似 tty 関連コード
<DT><I>rbtree</I><DD>
赤黒木 (redblack tree) の内部情報
<DT><I>sssd</I><DD>
SSSD を使用する sudoers
<DT><I>util</I><DD>
ユーティリティ関数群

</DL>
<P>

一例を挙げておく。
<PRE>

<DL COMPACT><DT><DD>Debug sudoers.so /var/log/sudo_debug <A HREF="mailto:match@info">match@info</A>,<A HREF="mailto:nss@info">nss@info</A>
</DL>
</PRE>


<P>

より詳しい情報については、<A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5) マニュアルをご覧いただきたい。
<A NAME="lbBL">&nbsp;</A>
<H2>関連項目</H2>

ssh(1), <A HREF="../../0MultiFileIdx/man1/su.1.html">su</A>(1), <A HREF="../../LDP_man-pages/man3/fnmatch.3.html">fnmatch</A>(3), <A HREF="../../LDP_man-pages/man3/glob.3.html">glob</A>(3), <A HREF="../../LDP_man-pages/man3/mktemp.3.html">mktemp</A>(3), <A HREF="../../LDP_man-pages/man3/strftime.3.html">strftime</A>(3), <A HREF="../man5/sudo.conf.5.html">sudo.conf</A>(5),
<A HREF="../man5/sudoers.ldap.5.html">sudoers.ldap</A>(5), <A HREF="../man8/sudo.8.html">sudo</A>(8), sudo_plugin(5), <A HREF="../man8/visudo.8.html">visudo</A>(8)
<A NAME="lbBM">&nbsp;</A>
<H2>作者</H2>

多数の人々が長年に渡って <B>sudo</B> の開発に携わってきた。
当バージョンは主として次の者が書いたコードからできている。
<P>
<DL COMPACT><DT><DD>
Todd C. Miller
</DL>

<P>

<B>sudo</B> の開発に貢献してくださった方々の詳細なリストについては、
配布物中の CONTRIBUTORS ファイルをご覧になっていただきたい。
(<A HREF="https://www.sudo.ws/contributors.html)">https://www.sudo.ws/contributors.html)</A>
<A NAME="lbBN">&nbsp;</A>
<H2>警告</H2>

<I>sudoers</I> ファイルの編集には、<B>必ず</B> <B>visudo</B> コマンドを使うべきである。
そうすれば、<B>visudo</B> がファイルをロックし、文法のチェックをやってくれる。
<I>sudoers</I> ファイルに文法的な間違いがあると、<B>sudo</B> が動かなくなるので、
<I>sudoers</I> ファイルには文法エラーが絶対にあってはならないのだ。
<P>

ネットグループを (ユーザについてではなく) マシンについて使用し、
<I>netgroup</I> ファイルに完全修飾ホスト名を記載する場合は
(たいていそうするものだが)、hostname コマンドの返すそのマシンのホスト名が、
完全修飾ホスト名になっていなければならない。そうでないときは、<I>sudoers</I>
ファイルで <I>fqdn</I> オプションを使う必要がある。
<A NAME="lbBO">&nbsp;</A>
<H2>バグ</H2>

<B>sudo</B> にバグを発見したと思ったら、<A HREF="https://bugzilla.sudo.ws/">https://bugzilla.sudo.ws/</A>
にアクセスして、バグレポートを提出していただきたい。
<A NAME="lbBP">&nbsp;</A>
<H2>サポート</H2>

ある程度の無料サポートが sudo-users メーリングリストを通して利用できる。
購読やアーカイブの検索には、次の URL をご覧になるとよい。
<A HREF="https://www.sudo.ws/mailman/listinfo/sudo-users">https://www.sudo.ws/mailman/listinfo/sudo-users</A>
<A NAME="lbBQ">&nbsp;</A>
<H2>免責</H2>

<B>sudo</B> は「現状のまま」提供される。 明示的な、あるいは黙示的ないかなる保証も、
商品性や特定目的への適合性についての黙示的な保証を含め、
またそれのみに止まらず、これを否認する。詳細な全文については、
<B>sudo</B> と一緒に配布されている LICENSE ファイルや、
次の Web ページをご覧いただきたい。
<A HREF="https://www.sudo.ws/license.html">https://www.sudo.ws/license.html</A>
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">名前</A><DD>
<DT><A HREF="#lbAC">説明</A><DD>
<DL>
<DT><A HREF="#lbAD">sudoers ポリシー・プラグインを使うための sudo.conf の設定</A><DD>
<DT><A HREF="#lbAE">ユーザの認証</A><DD>
<DT><A HREF="#lbAF">ロギング</A><DD>
<DT><A HREF="#lbAG">コマンド環境</A><DD>
</DL>
<DT><A HREF="#lbAH">SUDOERS ファイルの書式</A><DD>
<DL>
<DT><A HREF="#lbAI">EBNF の基礎の基礎</A><DD>
<DT><A HREF="#lbAJ">エイリアス</A><DD>
<DT><A HREF="#lbAK">デフォルト設定 (Defaults)</A><DD>
<DT><A HREF="#lbAL">ユーザ設定 (User Specification)</A><DD>
<DT><A HREF="#lbAM">Runas_Spec</A><DD>
<DT><A HREF="#lbAN">SELinux_Spec</A><DD>
<DT><A HREF="#lbAO">Tag_Spec</A><DD>
<DT><A HREF="#lbAP">ワイルドカード</A><DD>
<DT><A HREF="#lbAQ">ワイルドカード・ルールの例外</A><DD>
<DT><A HREF="#lbAR">sudoers に他のファイルをインクルードする</A><DD>
<DT><A HREF="#lbAS">ほかの特殊文字と予約語</A><DD>
</DL>
<DT><A HREF="#lbAT">SUDOERS のオプション</A><DD>
<DT><A HREF="#lbAU">グループ・プロバイダー・プラグイン</A><DD>
<DT><A HREF="#lbAV">ログの書式</A><DD>
<DL>
<DT><A HREF="#lbAW">実行を許可されたコマンドに関するログ記載事項</A><DD>
<DT><A HREF="#lbAX">実行を拒否されたコマンドに関するログ記載事項</A><DD>
<DT><A HREF="#lbAY">エラーに関するログ記載事項</A><DD>
<DT><A HREF="#lbAZ">syslog 経由でロギングするときの注意点</A><DD>
<DT><A HREF="#lbBA">ファイルにロギングするときの注意点</A><DD>
</DL>
<DT><A HREF="#lbBB">入出力ログファイル</A><DD>
<DT><A HREF="#lbBC">ファイル</A><DD>
<DT><A HREF="#lbBD">用例</A><DD>
<DT><A HREF="#lbBE">セキュリティに関する注意点</A><DD>
<DL>
<DT><A HREF="#lbBF">'!' 演算子の限界</A><DD>
<DT><A HREF="#lbBG"><I>fast_glob</I> の持つセキュリティ上の問題</A><DD>
<DT><A HREF="#lbBH">シェル・エスケープの防止</A><DD>
<DT><A HREF="#lbBI">安全な編集作業</A><DD>
<DT><A HREF="#lbBJ">タイムスタンプ・ファイルのチェック</A><DD>
</DL>
<DT><A HREF="#lbBK">デバッギング</A><DD>
<DT><A HREF="#lbBL">関連項目</A><DD>
<DT><A HREF="#lbBM">作者</A><DD>
<DT><A HREF="#lbBN">警告</A><DD>
<DT><A HREF="#lbBO">バグ</A><DD>
<DT><A HREF="#lbBP">サポート</A><DD>
<DT><A HREF="#lbBQ">免責</A><DD>
</DL>
<HR>
This document was created by
<A HREF="../../man/man1/man2html.1.html">man2html</A>,
using the manual pages.<BR>
Time: 03:33:46 GMT, December 05, 2022
</BODY>
</HTML>
